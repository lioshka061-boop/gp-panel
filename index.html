<!-- GP:M0 START • THEME + LAYOUT (build 2025-10-29.1) -->
<div id="gp-panel" data-mode="auto" data-theme="light" data-env="local" aria-label="Zero-to-Bot Panel">
  <!-- GP:BEGIN THEME -->
  <style>
    /* ===== Scope only inside #gp-panel ===== */
    #gp-panel, #gp-panel * { box-sizing: border-box; }

    /* ===== Design tokens (Light) ===== */
    #gp-panel{
      --bg:#ffffff; --text:#0f172a; --muted:#667085; --line:#e7eaf3;
      --chip:#f6f7ff; --accent:#2563eb;
      --grad1:#464eeb; --grad2:#5596fe; /* з твоєї системи */
      --active-bg:#eaf2ff; --active-border:#9ec5ff;
      --success:#16a34a; --warn:#f59e0b; --error:#ef4444;

      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      color: var(--text); background: var(--bg);
      border:1px solid var(--line); border-radius:16px; padding:12px;
    }

    /* ===== Dark theme tokens ===== */
    #gp-panel[data-theme="dark"]{
      --bg:#0b1220; --text:#e5edff; --muted:#a3b1c6; --line:#1e293b; --chip:#111a2e;
      --active-bg:#0f1f3c; --active-border:#264d9a;
      --accent:#79a6ff;
    }
    /* Page background sync for dark */
    body.gp-dark { background:#0b1220; color-scheme: dark; }

    /* ===== UI atoms ===== */
    #gp-panel .btn{
      cursor:pointer; border:1px solid var(--line); background:#fff; color:var(--text);
      border-radius:10px; padding:8px 12px; display:inline-flex; align-items:center; gap:8px; line-height:1;
    }
    #gp-panel[data-theme="dark"] .btn{ background:#0f172a; border-color:#1f2b45; }
    #gp-panel .btn.primary{ border:0; color:#fff; background:linear-gradient(90deg,var(--grad1),var(--grad2)); }
    #gp-panel .btn.ghost{ background:transparent; }
    #gp-panel .btn.sm{ padding:6px 10px; font-size:12px; }

    #gp-panel .tag{ font-size:12px; color:var(--muted); border:1px solid var(--line); border-radius:999px; padding:4px 8px; }
    #gp-panel .hint{ font-size:12px; color:var(--muted); }
    #gp-panel .chip{ font-size:12px; color:var(--text); background:var(--chip); border:1px solid var(--line); border-radius:6px; padding:4px 6px; }

    #gp-panel .icon{ width:18px; height:18px; display:inline-block; }
    #gp-panel .icon svg{ width:18px; height:18px; fill:none; stroke:currentColor; }

    /* ===== Layout chrome ===== */
    #gp-panel .top {
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
      padding:6px 6px 8px; border:1px solid var(--line); border-radius:12px; background:transparent;
    }
    #gp-panel .brand{
      display:flex; align-items:center; gap:8px;
    }
    #gp-panel .brand img{ width:28px; height:28px; border-radius:6px; object-fit:cover; }
    #gp-panel .brand b{ font-size:14px; }

    #gp-panel .wrap{
      display:grid; grid-template-columns:280px 1fr; gap:12px; margin-top:10px;
    }
    @media (max-width: 980px){ #gp-panel .wrap{ grid-template-columns:1fr; } }

    #gp-panel .sidebar{
      border:1px solid var(--line); border-radius:12px; padding:10px; max-height:68vh; overflow:auto;
    }
    #gp-panel .main{
      border:1px solid var(--line); border-radius:12px; padding:12px; min-height:240px;
    }

    /* ===== Simple blocks inside sidebar/main ===== */
    #gp-panel .side-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; }
    #gp-panel .search{ display:flex; gap:6px; }
    #gp-panel input[type="text"]{
      width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:transparent; color:var(--text);
    }

    #gp-panel h3{ margin:0 0 6px; font-size:18px; }
    #gp-panel p{ margin:6px 0; }
    #gp-panel .progress{ font-size:12px; color:var(--muted); }
  </style>
  <!-- GP:END THEME -->

  <!-- GP:BEGIN LAYOUT -->
  <div class="top">
    <div class="brand">
      <!-- Лого з твого URL -->
      <img src="http://46.254.107.103:8080/shop/d26a0a21-85fe-46ea-8469-ce8bad72397b/description/ChatGPT%20Image%2024%20сент.%202025%20г.,%2010_49_10.png" alt="Logo" loading="lazy" />
      <b>Zero-to-Bot Panel</b>
      <span class="chip">beta</span>
    </div>
    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
      <span class="tag" id="gp-chat1">Chat 1 · Навігатор</span>
      <span class="tag" id="gp-chat2">Chat 2 · Cursor</span>
      <span class="progress" id="gp-progress">0% виконано</span>
      <button class="btn" id="gp-guide-btn" title="Короткий гайд">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h10M4 18h16" stroke-width="2" stroke-linecap="round"/></svg>
        </span> Керівництво
      </button>
      <button class="btn" id="gp-settings-btn" title="Налаштування">Налаштування</button>
    </div>
  </div>

  <div class="wrap">
    <aside class="sidebar" aria-label="Навігація кроків">
      <div class="side-head">
        <b class="hint">Кроки</b>
        <span class="chip" id="gp-build">build 2025-10-29.1</span>
      </div>
      <div class="search">
        <input type="text" id="gp-find" placeholder="Пошук кроків…" />
        <button class="btn sm" id="gp-showall">Показати план</button>
      </div>
      <div id="gp-sections" class="hint">
        <!-- тут зʼявиться дерево кроків у M2 -->
        Сайдбар з кроками буде тут (M2).
      </div>
    </aside>

    <main class="main" aria-live="polite">
      <h3 id="gp-title">Ласкаво просимо ????</h3>
      <p class="hint" id="gp-desc">Це оболонка панелі. На наступних кроках додамо логіку етапів і промптів.</p>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
        <button class="btn primary" id="gp-start">Почати</button>
        <button class="btn" id="gp-how">Як це працює?</button>
      </div>
    </main>
  </div>
  <!-- GP:END LAYOUT -->

  <!-- GP:BEGIN BOOT -->
  <script>
    (function(){
      const root = document.getElementById('gp-panel');
      const STORE_KEY = 'gpPanel_state_m0';
      const STATE_VERSION = 1;
      const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

      let state = { v: STATE_VERSION, mode: root?.getAttribute('data-mode') || 'auto', theme: 'light', done: 0 };

      function applyTheme(){
        const selected = state.mode === 'auto' ? (mq && mq.matches ? 'dark' : 'light') : state.mode;
        state.theme = selected;
        root.setAttribute('data-theme', selected);
        document.body.classList.toggle('gp-dark', selected==='dark');
      }

      function save(){ try { localStorage.setItem(STORE_KEY, JSON.stringify(state)); } catch(e){} }
      function load(){ try {
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return;
        const prev = JSON.parse(raw);
        if(prev && prev.v === STATE_VERSION){ state = Object.assign(state, prev); }
      } catch(e){} }

      function render(){
        // Примітивний прогрес-плейсхолдер (оновиться в M2+)
        const pg = root.querySelector('#gp-progress');
        if(pg) pg.textContent = (state.done|0) + '% виконано';
      }

      function bind(){
        const guide = root.querySelector('#gp-guide-btn');
        guide && guide.addEventListener('click', ()=> alert('Гайд зʼявиться в M1/M2.'));
        const how = root.querySelector('#gp-how');
        how && how.addEventListener('click', ()=> alert('Коротко: натисни → скопіюй → встав. Деталі додамо у наступних модулях.'));
        const start = root.querySelector('#gp-start');
        start && start.addEventListener('click', ()=> alert('Старт майстра додамо у M3 (Анкета).'));
        if(mq && mq.addEventListener){ mq.addEventListener('change', ()=>{ if(state.mode==='auto'){ applyTheme(); save(); } }); }
      }

      function init(){
        load(); applyTheme(); render(); bind(); save();
      }
      init();
    })();
  </script>
  <!-- GP:END BOOT -->
</div>
<!-- GP:M0 END -->
<!-- GP:M1 START • SETTINGS MODAL + LOGIC (build 2025-10-29.2) -->
<!-- GP:BEGIN SETTINGS STYLES -->
<style>
  /* scope всередині панелі */
  #gp-panel .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;z-index:9998}
  #gp-panel .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999}
  #gp-panel .modal .box{
    width:min(720px,92vw);max-height:82vh;overflow:auto;background:var(--bg);
    border:1px solid var(--line);border-radius:16px;padding:14px;color:var(--text)
  }
  #gp-panel .modal .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  #gp-panel .modal h4{margin:0 0 8px}
  #gp-panel .setting{display:flex;justify-content:space-between;align-items:center;gap:12px;border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0}
  #gp-panel .radio{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  #gp-panel .radio label{display:inline-flex;gap:6px;align-items:center;font-size:14px}
  #gp-panel .radio input{accent-color:#4664ff}
  #gp-panel .linklike{color:var(--accent);text-decoration:underline;cursor:pointer}
  #gp-panel .badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px}
</style>
<!-- GP:END SETTINGS STYLES -->

<!-- GP:BEGIN SETTINGS MODAL -->
<div class="modal-backdrop" id="gp-backdrop-settings"></div>
<div class="modal" id="gp-settings-modal" role="dialog" aria-modal="true" aria-label="Налаштування">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <h4>Налаштування</h4>
      <button class="btn sm ghost" id="gp-settings-close" aria-label="Закрити">✕</button>
    </div>

    <div class="setting">
      <div>
        <b>Мова інтерфейсу</b>
        <div class="hint">Дефолт — українська. Інші мови з’являться пізніше.</div>
      </div>
      <div class="radio" id="gp-lang-group">
        <label><input type="radio" name="gp-lang" value="uk" checked> Українська</label>
        <label><input type="radio" name="gp-lang" value="en"> English</label>
      </div>
    </div>

    <div class="setting">
      <div>
        <b>RU-версія сторінки</b>
        <div class="hint">Залиш посилання на RU-версію. Ми збережемо його і покажемо у шапці.</div>
        <div id="gp-ru-hint" class="hint"></div>
      </div>
      <div class="row">
        <button class="btn sm" id="gp-add-ru">Додати RU-посилання</button>
        <span class="badge" id="gp-ru-badge" style="display:none">збережено</span>
      </div>
    </div>

    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="gp-settings-cancel">Скасувати</button>
      <button class="btn primary" id="gp-settings-save">Зберегти</button>
    </div>
  </div>
</div>
<!-- GP:END SETTINGS MODAL -->

<!-- GP:BEGIN SETTINGS SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel');
  if(!root) return;

  // --- storage / міграція ---
  const STORE_KEY = 'gpPanel_state_m0';           // той самий ключ з M0
  const NEW_STATE_VERSION = 2;                    // bump версії
  let state = { v: NEW_STATE_VERSION, mode: root.getAttribute('data-mode')||'auto', theme:'light', done:0, lang:'uk', ruLink:'' };

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return;
      const prev = JSON.parse(raw);
      if(!prev) return;
      // міграція з v1 → v2
      if(prev.v && prev.v <= NEW_STATE_VERSION){
        state = Object.assign({}, state, prev);
        if(!state.lang) state.lang = 'uk';
        if(typeof state.ruLink!=='string') state.ruLink='';
        state.v = NEW_STATE_VERSION;
      }
    }catch(e){}
  }
  function save(){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){}
  }

  // --- modal refs ---
  const backdrop = document.getElementById('gp-backdrop-settings');
  const modal = document.getElementById('gp-settings-modal');
  const btnOpen = document.getElementById('gp-settings-btn');
  const btnClose = document.getElementById('gp-settings-close');
  const btnCancel = document.getElementById('gp-settings-cancel');
  const btnSave = document.getElementById('gp-settings-save');
  const groupLang = document.getElementById('gp-lang-group');
  const addRu = document.getElementById('gp-add-ru');
  const ruHint = document.getElementById('gp-ru-hint');
  const ruBadge = document.getElementById('gp-ru-badge');

  function openModal(){ modal.style.display='flex'; backdrop.style.display='block'; modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.style.display='none'; backdrop.style.display='none'; modal.setAttribute('aria-hidden','true'); }

  function applyHeaderBadges(){
    // показати маркер мови поруч з “Chat 1/Chat 2” або у прогресі
    const progress = root.querySelector('#gp-progress');
    if(progress){
      let pct = String(state.done||0)+'% виконано';
      progress.textContent = pct + ' · мова: ' + (state.lang||'uk').toUpperCase();
    }
    // RU badge hint всередині модалки
    if(ruHint){
      if(state.ruLink){
        ruHint.textContent = 'Поточне RU-посилання: ' + state.ruLink;
        ruBadge.style.display = 'inline-block';
      }else{
        ruHint.textContent = 'Ще не додано. Натисни “Додати RU-посилання”.';
        ruBadge.style.display = 'none';
      }
    }
  }

  function bind(){
    // відкриття
    btnOpen && btnOpen.addEventListener('click', openModal);
    // закриття
    [btnClose, btnCancel, backdrop].forEach(b=> b && b.addEventListener('click', closeModal));
    // сабміт
    btnSave && btnSave.addEventListener('click', ()=>{
      // мова
      const checked = groupLang && groupLang.querySelector('input[name="gp-lang"]:checked');
      if(checked) state.lang = checked.value || 'uk';
      save(); applyHeaderBadges(); closeModal();
    });
    // додати RU лінк
    addRu && addRu.addEventListener('click', ()=>{
      const url = prompt('Встав посилання на RU-версію сторінки:', state.ruLink || 'https://genieprompts.net/ru');
      if(url && typeof url === 'string'){
        state.ruLink = url.trim();
        save(); applyHeaderBadges();
        alert('RU-посилання збережено.');
      }
    });
    // ініціалізація стану перемикача мови
    if(groupLang){
      const current = state.lang || 'uk';
      const opt = groupLang.querySelector('input[value="'+current+'"]');
      if(opt) opt.checked = true;
    }
    // Esc для закриття
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
  }

  function init(){
    load(); save(); applyHeaderBadges(); bind();
  }
  init();
})();
</script>
<!-- GP:END SETTINGS SCRIPT -->
<!-- GP:M1 END -->
<!-- GP:M2 START • SIDEBAR steps (build 2025-10-29.3) -->
<!-- GP:BEGIN SIDEBAR STYLES -->
<style>
  /* тільки в межах панелі */
  #gp-panel .sec{margin:8px 0;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  #gp-panel .sec h4{margin:0;font-size:14px;padding:8px 10px;background:var(--chip);
    display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  #gp-panel .sec .list{display:none;padding:6px 8px}
  #gp-panel .sec.open .list{display:block}
  #gp-panel .item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;
    cursor:pointer;border:1px solid transparent}
  #gp-panel .item .i{width:18px;height:18px;border:1px solid var(--line);border-radius:4px;
    display:inline-flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted)}
  #gp-panel .item .t{flex:1}
  #gp-panel .item .b{font-size:11px;color:var(--muted)}
  #gp-panel .item.active{background:var(--active-bg);border-color:var(--active-border);outline:2px solid var(--active-border)}
  #gp-panel .item.done{opacity:.75}
</style>
<!-- GP:END SIDEBAR STYLES -->

<!-- GP:BEGIN SIDEBAR SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel');
  if(!root) return;

  // === state / storage (bump версії до 3) ===
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 3;
  let state = {
    v: STATE_VERSION,
    mode: root.getAttribute('data-mode')||'auto',
    theme:'light',
    lang:'uk',
    ruLink:'',
    current: 0,
    done: [],       // індекси виконаних кроків
    filter: ''
  };

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return;
      const prev = JSON.parse(raw);
      if(prev){
        state = Object.assign(state, prev);
        state.v = STATE_VERSION;
        if(!Array.isArray(state.done)) state.done=[];
        if(typeof state.current!=='number') state.current=0;
        if(typeof state.filter!=='string') state.filter='';
      }
    }catch(e){}
  }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  // === кроки / секції ===
  const sections = [
    { title:'0 · Старт', open:true, items:[
      {t:'Почати', b:'welcome'},
      {t:'Як це працює', b:'guide'}
    ]},
    { title:'1 · Анкета', open:true, items:[
      {t:'Заповнити 5 полів', b:'form'},
      {t:'Підтвердити анкету', b:'confirm'}
    ]},
    { title:'2 · Режим', open:false, items:[
      {t:'AUTO', b:'auto'},
      {t:'ASSISTED', b:'assisted'}
    ]},
    { title:'3 · Конструктор', open:false, items:[
      {t:'Тип / Модулі', b:'chips'},
      {t:'Дані / Інтеграції', b:'storage/integrations'},
      {t:'Бекенд (опц.) / Рівень', b:'backend/level'}
    ]},
    { title:'4 · Огляд', open:false, items:[
      {t:'DEV BRIEF (EN)', b:'brief'},
      {t:'CURSOR PROMPT (EN)', b:'prompt'}
    ]},
    { title:'5 · Середовище', open:false, items:[
      {t:'Local vs Codespaces', b:'env'}
    ]},
    { title:'6 · Інструменти / Files', open:false, items:[
      {t:'Встановити/Відкрити', b:'tools'},
      {t:'Чек-лист файлів', b:'files'}
    ]},
    { title:'7 · Вставити у Cursor', open:false, items:[
      {t:'Скопіювати промпт', b:'copy-cursor'},
      {t:'Де вставити?', b:'cursor-how'}
    ]},
    { title:'8 · Запуск', open:false, items:[
      {t:'Команди запуску', b:'run'},
      {t:'Є проблема', b:'troubles'}
    ]},
    { title:'9 · BotFather', open:false, items:[
      {t:'/setcommands', b:'bf-commands'}
    ]},
    { title:'10 · Перевірка', open:false, items:[
      {t:'/start /help', b:'test'}
    ]},
    { title:'11 · Готово / Апґрейди', open:false, items:[
      {t:'UI-кнопки', b:'upgrade-ui'},
      {t:'Статистика', b:'upgrade-stats'},
      {t:'Оплати', b:'upgrade-pay'}
    ]}
  ];

  // звести в плоский список для індексів
  let flat = [];
  function flatten(){
    flat = [];
    sections.forEach((sec, si)=>{
      sec.items.forEach((it, idx)=>{
        flat.push({ si, idx, sec: sec.title, title: it.t, badge: it.b });
      });
    });
  }

  // === UI build ===
  const box = root.querySelector('#gp-sections');
  const find = root.querySelector('#gp-find');
  const showAllBtn = root.querySelector('#gp-showall');
  const progressEl = root.querySelector('#gp-progress');

  function buildSidebar(){
    if(!box) return;
    box.innerHTML = '';
    const f = (state.filter||'').toLowerCase();

    sections.forEach((sec, si)=>{
      // секція
      const c = document.createElement('div'); c.className = 'sec' + (sec.open? ' open':'');

      const h = document.createElement('h4');
      h.innerHTML = `<span>${sec.title}</span><span>${sec.open?'−':'+'}</span>`;
      h.addEventListener('click', ()=>{ sec.open = !sec.open; save(); buildSidebar(); });
      c.appendChild(h);

      const list = document.createElement('div'); list.className = 'list';

      sec.items.forEach((it, idx)=>{
        const txt = (it.t + ' ' + (it.b||'')).toLowerCase();
        if(f && !txt.includes(f)) return;

        const li = document.createElement('div'); li.className = 'item';
        const flatIndex = flat.findIndex(x=>x.si===si && x.idx===idx);
        if(state.current===flatIndex) li.classList.add('active');
        if(state.done.includes(flatIndex)) li.classList.add('done');

        li.innerHTML =
          `<span class="i">${state.done.includes(flatIndex)?'✓':(flatIndex+1)}</span>`+
          `<div class="t"><div>${it.t}</div><div class="b">${it.b||''}</div></div>`;

        li.addEventListener('click', ()=>{
          state.current = flatIndex;
          // авто-відкриття секції
          sections[si].open = true;
          save(); buildSidebar(); reflectMainHeader();
        });

        list.appendChild(li);
      });

      c.appendChild(list);
      box.appendChild(c);
    });

    // прогрес
    const pct = Math.round((state.done.length / flat.length)*100) || 0;
    if(progressEl){
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
  }

  // тимчасовий рефлекс у заголовок main (оновимо у M3+)
  function reflectMainHeader(){
    const s = flat[state.current] || flat[0];
    const titleEl = root.querySelector('#gp-title');
    const descEl = root.querySelector('#gp-desc');
    if(titleEl) titleEl.textContent = `Крок ${state.current+1}. ${s ? s.title : '...'}`;
    if(descEl) descEl.textContent = s ? s.sec : '';
  }

  // === події ===
  function bind(){
    // пошук
    find && find.addEventListener('input', (e)=>{ state.filter = e.target.value || ''; save(); buildSidebar(); });
    // показати/згорнути все
    showAllBtn && showAllBtn.addEventListener('click', ()=>{
      const allOpen = sections.every(s=>s.open);
      sections.forEach(s=> s.open = !allOpen);
      save(); buildSidebar();
    });

    // гаряча кнопка "Виконано" (поки що демо: маркує поточний крок done)
    // у M3 замінимо на справжню кнопку в main
    root.addEventListener('gp:markDone', ()=>{
      if(!state.done.includes(state.current)) state.done.push(state.current);
      save(); buildSidebar();
    });
  }

  function init(){
    load(); flatten(); buildSidebar(); reflectMainHeader(); bind();
  }
  init();
})();
</script>
<!-- GP:END SIDEBAR SCRIPT -->
<!-- GP:M2 END -->
<!-- GP:M3 START • START + FORM (build 2025-10-29.4) -->
<!-- GP:BEGIN FORM STYLES -->
<style>
  #gp-panel .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  #gp-panel .form-grid .full{grid-column:1/-1}
  @media(max-width:980px){ #gp-panel .form-grid{grid-template-columns:1fr} }
  #gp-panel .field{display:flex;flex-direction:column;gap:6px}
  #gp-panel .field label{font-size:12px;color:var(--muted)}
  #gp-panel .err{font-size:12px;color:var(--error);display:none}
  #gp-panel .err.show{display:block}
  #gp-panel .block{border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
</style>
<!-- GP:END FORM STYLES -->

<!-- GP:BEGIN START+FORM SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;

  // === storage (сумісно з M0/M1/M2) ===
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 4;

  // дубль секцій для мапи індексів (той самий порядок, що в M2)
  const sections = [
    { title:'0 · Старт', items:[{t:'Почати', b:'welcome'},{t:'Як це працює', b:'guide'}]},
    { title:'1 · Анкета', items:[{t:'Заповнити 5 полів', b:'form'},{t:'Підтвердити анкету', b:'confirm'}]},
    { title:'2 · Режим', items:[{t:'AUTO', b:'auto'},{t:'ASSISTED', b:'assisted'}]},
    { title:'3 · Конструктор', items:[{t:'Тип / Модулі', b:'chips'},{t:'Дані / Інтеграції', b:'storage/integrations'},{t:'Бекенд (опц.) / Рівень', b:'backend/level'}]},
    { title:'4 · Огляд', items:[{t:'DEV BRIEF (EN)', b:'brief'},{t:'CURSOR PROMPT (EN)', b:'prompt'}]},
    { title:'5 · Середовище', items:[{t:'Local vs Codespaces', b:'env'}]},
    { title:'6 · Інструменти / Files', items:[{t:'Встановити/Відкрити', b:'tools'},{t:'Чек-лист файлів', b:'files'}]},
    { title:'7 · Вставити у Cursor', items:[{t:'Скопіювати промпт', b:'copy-cursor'},{t:'Де вставити?', b:'cursor-how'}]},
    { title:'8 · Запуск', items:[{t:'Команди запуску', b:'run'},{t:'Є проблема', b:'troubles'}]},
    { title:'9 · BotFather', items:[{t:'/setcommands', b:'bf-commands'}]},
    { title:'10 · Перевірка', items:[{t:'/start /help', b:'test'}]},
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  let flat=[]; sections.forEach((sec,si)=>sec.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:sec.title})));

  // стан
  let state = {
    v: STATE_VERSION,
    mode: root.getAttribute('data-mode')||'auto',
    theme: root.getAttribute('data-theme')||'light',
    lang: 'uk',
    ruLink: '',
    current: 0,
    done: [],
    filter: '',
    profile: { role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM' },
    formValid:false
  };

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY); if(!raw) return;
      const prev = JSON.parse(raw)||{};
      state = Object.assign(state, prev);
      state.v = STATE_VERSION;
      if(!state.profile) state.profile = { role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM' };
      if(typeof state.formValid!=='boolean') state.formValid=false;
      if(!Array.isArray(state.done)) state.done=[];
    }catch(e){}
  }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  // утиліти
  const $ = s => root.querySelector(s);
  function setProgress(){ // просте оновлення прогресу (M2 теж по-своєму перерахує)
    const progressEl = $('#gp-progress');
    const pct = Math.round((state.done.length / flat.length)*100) || 0;
    if(progressEl) progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
  }
  function markDoneAndGo(nextIndex){
    if(!state.done.includes(state.current)) state.done.push(state.current);
    if(typeof nextIndex==='number') state.current = nextIndex;
    save(); setProgress();
    // повідомляємо сайдбар (M2 слухає цю подію)
    root.dispatchEvent(new CustomEvent('gp:markDone'));
    renderMain();
  }

  // рендер головної області для ключів welcome/form
  function renderMain(){
    const main = $('.main'); if(!main) return;
    const cur = flat[state.current] || flat[0];
    const key = cur ? cur.key : 'welcome';
    const titleEl = $('#gp-title'); const descEl = $('#gp-desc');

    if(key==='welcome'){
      if(titleEl) titleEl.textContent = 'Ласкаво просимо 👋';
      if(descEl) descEl.textContent = 'Натисни “Почати” — заповниш 5 полів і підемо далі.';
      main.querySelectorAll('.dyn').forEach(n=>n.remove());
      const block = document.createElement('div');
      block.className='dyn';
      block.innerHTML = `
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
          <button class="btn primary" id="gp-start-now">Почати</button>
          <button class="btn" id="gp-see-how">Як це працює?</button>
        </div>
      `;
      main.appendChild(block);
      $('#gp-start-now')?.addEventListener('click', ()=>{
        // перейти на крок "Заповнити 5 полів"
        const idx = flat.findIndex(x=>x.key==='form');
        if(idx>=0){ state.current = idx; save(); renderMain(); }
      });
      $('#gp-see-how')?.addEventListener('click', ()=> alert('1) Заповнюєш анкету → 2) Обираєш режим → 3) Копіюєш промпт у Cursor → 4) Запуск.'));
      return;
    }

    if(key==='form'){
      if(titleEl) titleEl.textContent = 'Анкета: 5 простих полів';
      if(descEl) descEl.textContent = 'Це база. На її основі зберемо промпти та інструкції.';
      main.querySelectorAll('.dyn').forEach(n=>n.remove());

      const block = document.createElement('div'); block.className='dyn';
      block.innerHTML = `
        <div class="block">
          <div class="form-grid">
            <div class="field">
              <label>Роль бота <span class="hint">(напр.: Асистент трекінгу звичок)</span></label>
              <input type="text" id="f-role" value="${escapeHtml(state.profile.role)}" placeholder="Впиши коротко">
              <div class="err" id="e-role">Вкажи роль.</div>
            </div>
            <div class="field">
              <label>Ціль <span class="hint">(одне речення)</span></label>
              <input type="text" id="f-goal" value="${escapeHtml(state.profile.goal)}" placeholder="Що саме має робити бот?">
              <div class="err" id="e-goal">Опиши ціль.</div>
            </div>
            <div class="field">
              <label>Команди <span class="hint">(через кому)</span></label>
              <input type="text" id="f-cmds" value="${escapeHtml(state.profile.cmds)}">
            </div>
            <div class="field">
              <label>Мова UI</label>
              <input type="text" id="f-lang" value="${escapeHtml(state.profile.lang||'uk')}" placeholder="uk / en">
            </div>
            <div class="field">
              <label>Канал</label>
              <input type="text" id="f-channel" value="${escapeHtml(state.profile.channel||'DM')}" placeholder="DM або Group">
            </div>
            <div class="full">
              <div class="hint">Порада: не ускладнюй. Коротко й по суті — далі розкладемо автоматично.</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
            <button class="btn primary" id="f-confirm">Підтвердити анкету</button>
            <button class="btn" id="f-copy-chat1">Скопіювати для Chat 1</button>
          </div>
          <div class="kbd" id="f-chat1-preview" style="display:none"></div>
        </div>
      `;
      main.appendChild(block);

      // бінди
      $('#f-confirm')?.addEventListener('click', onConfirm);
      $('#f-copy-chat1')?.addEventListener('click', ()=>{
        const prompt = buildChat1Prompt();
        const box = $('#f-chat1-preview'); if(box){ box.textContent = prompt; box.style.display='block'; }
        copyText(prompt);
      });
      // live update збереження
      ['role','goal','cmds','lang','channel'].forEach(k=>{
        const el = $('#f-'+k);
        el && el.addEventListener('input', (e)=>{
          state.profile[k] = String(e.target.value||'');
          save();
        });
      });
      return;
    }

    // інші кроки M4+ заповнимо пізніше — тут просто не чіпаємо main
  }

  function onConfirm(){
    // зчитати поля
    const role = $('#f-role').value.trim();
    const goal = $('#f-goal').value.trim();
    const cmds = $('#f-cmds').value.trim() || '/start, /help';
    const lang = $('#f-lang').value.trim() || 'uk';
    const channel = $('#f-channel').value.trim() || 'DM';

    // валідація
    let ok = true;
    toggleErr('#e-role', !role); ok = ok && !!role;
    toggleErr('#e-goal', !goal); ok = ok && !!goal;
    if(!ok) return;

    // зберегти
    state.profile = { role, goal, cmds, lang, channel };
    state.lang = lang;
    state.formValid = true;
    save(); setProgress();

    // відмітити done і перейти на наступний пункт “Підтвердити анкету”
    const idxConfirm = flat.findIndex(x=>x.key==='confirm');
    if(idxConfirm>=0){
      state.current = idxConfirm; // позначимо як поточний підтвердження
      save();
      // маркуємо як виконаний попередній пункт (form)
      const idxForm = flat.findIndex(x=>x.key==='form');
      if(idxForm>=0){ state.current = idxForm; save(); }
      markDoneAndGo(idxConfirm); // rebuild sidebar + jump на confirm (done)
      // і одразу штовхаємо користувача далі — до вибору режиму
      const idxAuto = flat.findIndex(x=>x.key==='auto');
      if(idxAuto>=0){ state.current = idxAuto; save(); root.dispatchEvent(new CustomEvent('gp:markDone')); renderMain(); }
      alert('Анкету прийнято. Далі — вибір режиму (AUTO/ASSISTED).');
    }
  }

  // Побудова короткого промпта для Chat 1 (ASSISTED режим)
  function buildChat1Prompt(){
    const p = state.profile;
    return [
      '[CHAT 1 | NAVIGATOR] Onboarding survey → produce concise English DEV BRIEF.',
      'User answers:',
      '- Role: '+(p.role||'-'),
      '- Goal: '+(p.goal||'-'),
      '- Commands: '+(p.cmds||'-'),
      '- UI Language: '+(p.lang||'uk'),
      '- Channel: '+(p.channel||'DM'),
      '',
      'Deliverables:',
      '1) DEV BRIEF (8–12 lines, English) for a Telegram bot matching answers.',
      '2) Bullet list of key flows.',
      '3) Data entities and storage suggestion (very brief).',
      'No code yet.'
    ].join('\n');
  }

  // допоміжне: копіювання з фолбеком
  async function copyText(txt){
    try{
      if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); return; }
    }catch(e){}
    // фолбек
    const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); toast('Скопійовано.'); }catch(e){ alert('Скопіюй вручну.'); }
    finally{ document.body.removeChild(ta); }
  }
  function toast(msg){
    let t = root.querySelector('#gp-toast-m3');
    if(!t){ t = document.createElement('div'); t.id='gp-toast-m3'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m3);
    window.__gp_to_m3 = setTimeout(()=> t.style.display='none', 1600);
  }
  function toggleErr(sel, show){ const el = $(sel); if(!el) return; el.classList.toggle('show', !!show); }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function init(){
    load(); setProgress();
    // якщо користувач натисне "Почати" з M0 — просто перерендеримо
    const startBtn = $('#gp-start'); startBtn && startBtn.addEventListener('click', ()=>{
      const idx = flat.findIndex(x=>x.key==='form'); if(idx>=0){ state.current=idx; save(); renderMain(); }
    });
    renderMain();
  }
  init();
})();
</script>
<!-- GP:END START+FORM SCRIPT -->
<!-- GP:M3 END -->
<!-- GP:M4 START • MODES: AUTO / ASSISTED (build 2025-10-29.5) -->
<!-- GP:BEGIN MODES STYLES -->
<style>
  #gp-panel .mode-wrap{display:grid;grid-template-columns:1fr;gap:10px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel textarea.kbd{min-height:120px}
</style>
<!-- GP:END MODES STYLES -->

<!-- GP:BEGIN MODES SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 5;

  // синхронний flat порядок як у M2/M3
  const sections = [
    { title:'0 · Старт', items:[{t:'Почати', b:'welcome'},{t:'Як це працює', b:'guide'}]},
    { title:'1 · Анкета', items:[{t:'Заповнити 5 полів', b:'form'},{t:'Підтвердити анкету', b:'confirm'}]},
    { title:'2 · Режим', items:[{t:'AUTO', b:'auto'},{t:'ASSISTED', b:'assisted'}]},
    { title:'3 · Конструктор', items:[{t:'Тип / Модулі', b:'chips'},{t:'Дані / Інтеграції', b:'storage/integrations'},{t:'Бекенд (опц.) / Рівень', b:'backend/level'}]},
    { title:'4 · Огляд', items:[{t:'DEV BRIEF (EN)', b:'brief'},{t:'CURSOR PROMPT (EN)', b:'prompt'}]},
    { title:'5 · Середовище', items:[{t:'Local vs Codespaces', b:'env'}]},
    { title:'6 · Інструменти / Files', items:[{t:'Встановити/Відкрити', b:'tools'},{t:'Чек-лист файлів', b:'files'}]},
    { title:'7 · Вставити у Cursor', items:[{t:'Скопіювати промпт', b:'copy-cursor'},{t:'Де вставити?', b:'cursor-how'}]},
    { title:'8 · Запуск', items:[{t:'Команди запуску', b:'run'},{t:'Є проблема', b:'troubles'}]},
    { title:'9 · BotFather', items:[{t:'/setcommands', b:'bf-commands'}]},
    { title:'10 · Перевірка', items:[{t:'/start /help', b:'test'}]},
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  let flat=[]; sections.forEach((sec,si)=>sec.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:sec.title})));

  let state = {
    v: STATE_VERSION, mode: root.getAttribute('data-mode')||'auto',
    theme: root.getAttribute('data-theme')||'light',
    lang:'uk', ruLink:'', current:0, done:[], filter:'',
    profile:{ role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM' },
    assistedBrief:''  // сюди вставляємо DEV BRIEF від Chat 1
  };

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY); if(!raw) return;
      const prev = JSON.parse(raw)||{};
      state = Object.assign(state, prev);
      state.v = STATE_VERSION;
      if(!state.profile) state.profile = { role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM' };
      if(typeof state.assistedBrief!=='string') state.assistedBrief='';
      if(!Array.isArray(state.done)) state.done=[];
      if(typeof state.current!=='number') state.current=0;
    }catch(e){}
  }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){ return (flat[state.current]||flat[0]).key; }
  let lastIdx = -1;

  // генератор DEV BRIEF (EN) з анкети (дуже коротко і чітко)
  function makeDevBrief(p){
    return [
      `Goal: Build a Telegram bot – ${p.role||'Bot'} – whose main purpose is: ${p.goal||'not specified'}.`,
      `Commands: ${p.cmds||'/start, /help'}.`,
      `UI Language: ${p.lang||'uk'}. Channel: ${p.channel||'DM'}.`,
      `Key flows: onboarding (/start), help (/help), core action(s) based on goal.`,
      `Storage: start with lightweight JSON file (local) or Google Sheets if user selects Sheets.`,
      `Tech: Python 3.10+, aiogram v3, python-dotenv for TOKEN.`,
      `Structure: main.py, requirements.txt, .env, data/ (if needed).`,
      `Next steps: generate code skeleton, run locally or in Codespaces, then extend features.`
    ].join('\n');
  }

  // генератор CURSOR PROMPT (EN) із DEV BRIEF
  function makeCursorPrompt(p, brief){
    return [
`[CHAT 2 | PROGRAMMER] CURRENT STEP: Generate project skeleton`,
`TERMINAL> none`,
`CODE> none`,
`INSTRUCTION:`,
`You are Cursor writing code only. Use Python 3.10+, aiogram v3, python-dotenv.`,
`Create a minimal working bot based on this DEV BRIEF:`,
`----- DEV BRIEF -----`,
brief.trim(),
`---------------------`,
`Deliverables (files):`,
`1) requirements.txt (aiogram==3.*, python-dotenv, loguru)`,
`2) main.py with /start and /help handlers, polling start`,
`3) .env.example with TOKEN=your_token_here`,
`Notes:`,
`- Do not add extra prose. Return code blocks with exact content.`,
`- Keep code runnable with: pip install -r requirements.txt && python main.py`,
`- Language in messages: ${p.lang||'uk'}.`
    ].join('\n');
  }

  // промпт для Chat 1 (ASSISTED) — короткий
  function makeAssistedPrompt(p){
    return [
      `[CHAT 1 | NAVIGATOR] Onboarding survey → produce concise English DEV BRIEF.`,
      `User answers:`,
      `- Role: ${p.role||'-'}`,
      `- Goal: ${p.goal||'-'}`,
      `- Commands: ${p.cmds||'-'}`,
      `- UI Language: ${p.lang||'uk'}`,
      `- Channel: ${p.channel||'DM'}`,
      ``,
      `Deliverables:`,
      `1) DEV BRIEF (8–12 lines, English) for a Telegram bot matching answers.`,
      `2) Bullet list of key flows.`,
      `3) Data entities and storage suggestion (very brief).`,
      `No code yet.`
    ].join('\n');
  }

  function copyText(txt){
    (async()=>{
      try{
        if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); return; }
      }catch(e){}
      const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); toast('Скопійовано.'); }catch(e){ alert('Скопіюй вручну.'); }
      finally{ document.body.removeChild(ta); }
    })();
  }
  function toast(msg){
    let t = root.querySelector('#gp-toast-m4');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m4'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m4);
    window.__gp_to_m4 = setTimeout(()=> t.style.display='none', 1600);
  }

  function markDoneAndGo(nextKey){
    const idx = state.current;
    if(!state.done.includes(idx)) state.done.push(idx);
    // оновити прогрес у шапці
    const progressEl = $('#gp-progress');
    if(progressEl){
      const pct = Math.round((state.done.length/flat.length)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
    save();
    root.dispatchEvent(new CustomEvent('gp:markDone')); // M2 оновить сайдбар
    if(nextKey){
      const ni = flat.findIndex(x=>x.key===nextKey);
      if(ni>=0){ state.current = ni; save(); renderModes(true); }
    }
  }

  // основний рендер для кроків auto/assisted
  function renderModes(force){
    load(); // витягнути актуальний current, якщо змінився зовні
    const curIdx = state.current;
    if(!force && curIdx===lastIdx) return;
    lastIdx = curIdx;

    const key = getKey();
    if(key!=='auto' && key!=='assisted') return; // показуємо тільки на цих етапах

    const main = root.querySelector('.main'); if(!main) return;
    const titleEl = $('#gp-title'); const descEl = $('#gp-desc');
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    if(key==='auto'){
      titleEl && (titleEl.textContent = 'Режим AUTO: все готово автоматично');
      descEl && (descEl.textContent = 'Ми згенерували англомовний DEV BRIEF і CURSOR PROMPT. Скопіюй у Cursor, коли будемо там.');

      const devBrief = makeDevBrief(state.profile);
      const cursorPrompt = makeCursorPrompt(state.profile, devBrief);

      const wrap = document.createElement('div'); wrap.className='dyn card mode-wrap';
      wrap.innerHTML = `
        <div class="card">
          <b>DEV BRIEF (EN)</b>
          <div class="kbd" id="m4-brief">${escapeHtml(devBrief)}</div>
          <div class="row">
            <button class="btn" id="m4-copy-brief">Скопіювати BRIEF</button>
          </div>
        </div>
        <div class="card">
          <b>CURSOR PROMPT (EN)</b>
          <div class="kbd" id="m4-prompt">${escapeHtml(cursorPrompt)}</div>
          <div class="row">
            <button class="btn primary" id="m4-copy-cursor">Скопіювати для Cursor</button>
            <button class="btn" id="m4-next">Готово → До конструктора</button>
          </div>
        </div>
      `;
      main.appendChild(wrap);

      $('#m4-copy-brief')?.addEventListener('click', ()=> copyText(devBrief));
      $('#m4-copy-cursor')?.addEventListener('click', ()=> copyText(cursorPrompt));
      $('#m4-next')?.addEventListener('click', ()=> markDoneAndGo('chips'));
      return;
    }

    if(key==='assisted'){
      titleEl && (titleEl.textContent = 'Режим ASSISTED: через ChatGPT → потім Cursor');
      descEl && (descEl.textContent = 'Крок 1: скопіюй промпт у Chat 1. Крок 2: встав назад DEV BRIEF. Крок 3: отримаєш CURSOR PROMPT.');

      const assistedPrompt = makeAssistedPrompt(state.profile);
      const devBrief = (state.assistedBrief||'').trim();
      const cursorPrompt = devBrief ? makeCursorPrompt(state.profile, devBrief) : '';

      const wrap = document.createElement('div'); wrap.className='dyn card mode-wrap';
      wrap.innerHTML = `
        <div class="card">
          <b>Крок 1 — Промпт для Chat 1</b>
          <div class="kbd" id="m4-assist">${escapeHtml(assistedPrompt)}</div>
          <div class="row">
            <button class="btn" id="m4-copy-assist">Скопіювати для Chat 1</button>
          </div>
        </div>
        <div class="card">
          <b>Крок 2 — Встав DEV BRIEF (EN) від Chat 1</b>
          <textarea class="kbd" id="m4-brief-inp" placeholder="Встав сюди DEV BRIEF англійською…">${escapeHtml(state.assistedBrief)}</textarea>
          <div class="row">
            <button class="btn" id="m4-save-brief">Зберегти BRIEF</button>
            <span class="hint">Після збереження зʼявиться CURSOR PROMPT.</span>
          </div>
        </div>
        <div class="card" id="m4-cursor-card" style="${cursorPrompt?'':'display:none'}">
          <b>Крок 3 — CURSOR PROMPT (EN)</b>
          <div class="kbd" id="m4-prompt2">${escapeHtml(cursorPrompt)}</div>
          <div class="row">
            <button class="btn primary" id="m4-copy-cursor2">Скопіювати для Cursor</button>
            <button class="btn" id="m4-next2">Готово → До конструктора</button>
          </div>
        </div>
      `;
      main.appendChild(wrap);

      $('#m4-copy-assist')?.addEventListener('click', ()=> copyText(assistedPrompt));
      $('#m4-save-brief')?.addEventListener('click', ()=>{
        const val = ($('#m4-brief-inp').value||'').trim();
        if(!val){ alert('Встав DEV BRIEF від Chat 1.'); return; }
        state.assistedBrief = val; save();
        // згенерувати й показати CURSOR PROMPT
        const cp = makeCursorPrompt(state.profile, val);
        const card = $('#m4-cursor-card'); const box=$('#m4-prompt2');
        if(card && box){ box.textContent = cp; card.style.display='block'; }
      });
      $('#m4-copy-cursor2')?.addEventListener('click', ()=>{
        const box = $('#m4-prompt2'); if(!box) return;
        copyText(box.textContent||'');
      });
      $('#m4-next2')?.addEventListener('click', ()=> markDoneAndGo('chips'));
      return;
    }
  }

  // утиліти
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // тригери оновлення: періодично й після позначення done
  function init(){
    load();
    renderModes(true);
    // коли сайдбар або інші модулі міняють current — оновлюємось
    root.addEventListener('gp:markDone', ()=> renderModes(true));
    // легкий інтервал як страховка від зовнішніх кліків у сайдбарі (M2)
    setInterval(()=> renderModes(false), 400);
  }
  init();
})();
</script>
<!-- GP:END MODES SCRIPT -->
<!-- GP:M4 END -->
<!-- GP:M5 START • CHIPS CONSTRUCTOR (build 2025-10-29.6) -->
<!-- GP:BEGIN CHIPS STYLES -->
<style>
  #gp-panel .chips-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .chip-row{display:flex;flex-wrap:wrap;gap:8px}
  #gp-panel .chipbtn{
    border:1px solid var(--line); border-radius:999px; padding:6px 10px; cursor:pointer; font-size:12px; background:transparent;
  }
  #gp-panel .chipbtn[aria-pressed="true"]{ background:var(--active-bg); border-color:var(--active-border) }
  #gp-panel .card{border:1px solid var(--line); border-radius:12px; padding:12px}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
</style>
<!-- GP:END CHIPS STYLES -->

<!-- GP:BEGIN CHIPS SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 6;

  // синхронізовано з M2/M3/M4
  const sections = [
    { title:'0 · Старт', items:[{t:'Почати', b:'welcome'},{t:'Як це працює', b:'guide'}]},
    { title:'1 · Анкета', items:[{t:'Заповнити 5 полів', b:'form'},{t:'Підтвердити анкету', b:'confirm'}]},
    { title:'2 · Режим', items:[{t:'AUTO', b:'auto'},{t:'ASSISTED', b:'assisted'}]},
    { title:'3 · Конструктор', items:[{t:'Тип / Модулі', b:'chips'},{t:'Дані / Інтеграції', b:'storage/integrations'},{t:'Бекенд (опц.) / Рівень', b:'backend/level'}]},
    { title:'4 · Огляд', items:[{t:'DEV BRIEF (EN)', b:'brief'},{t:'CURSOR PROMPT (EN)', b:'prompt'}]},
    { title:'5 · Середовище', items:[{t:'Local vs Codespaces', b:'env'}]},
    { title:'6 · Інструменти / Files', items:[{t:'Встановити/Відкрити', b:'tools'},{t:'Чек-лист файлів', b:'files'}]},
    { title:'7 · Вставити у Cursor', items:[{t:'Скопіювати промпт', b:'copy-cursor'},{t:'Де вставити?', b:'cursor-how'}]},
    { title:'8 · Запуск', items:[{t:'Команди запуску', b:'run'},{t:'Є проблема', b:'troubles'}]},
    { title:'9 · BotFather', items:[{t:'/setcommands', b:'bf-commands'}]},
    { title:'10 · Перевірка', items:[{t:'/start /help', b:'test'}]},
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  const flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION, mode: root.getAttribute('data-mode')||'auto', theme: root.getAttribute('data-theme')||'light',
    lang:'uk', ruLink:'', current:0, done:[], filter:'',
    profile:{ role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
      // нові поля конструктора:
      type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
    },
    assistedBrief:''
  };

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY); if(!raw) return;
      const prev = JSON.parse(raw)||{};
      state = Object.assign(state, prev);
      state.v = STATE_VERSION;
      // дефолти для нових полів
      state.profile = Object.assign({
        role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
        type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
      }, state.profile||{});
      if(!Array.isArray(state.profile.modules)) state.profile.modules=[];
      if(!Array.isArray(state.profile.integrations)) state.profile.integrations=[];
      if(!state.profile.data) state.profile.data='json';
      if(!state.profile.level) state.profile.level='L1';
    }catch(e){}
  }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  const $ = s => root.querySelector(s);
  function key(){ return (flat[state.current]||flat[0]).key; }

  // набір чіпів
  const CHIPSETS = {
    type: ['CRM','Task','Habit','FAQ','Shop','Booking','Custom'],
    modules: ['ui-buttons','reminders','roles','admin','payments','stats','files'],
    data: ['no-save','json','sheets','sqlite','postgres'],
    integrations: ['sheets','notion','webhook','stripe','openai'],
    backend: ['none','parser','webhook-receiver','tiny-fastapi'],
    level: ['L0','L1','L2','L3']
  };

  function chip(label, pressed, onClick){
    const b = document.createElement('button');
    b.className='chipbtn';
    b.textContent=label;
    b.setAttribute('aria-pressed', pressed?'true':'false');
    b.addEventListener('click', ()=>{
      onClick && onClick(label, b.getAttribute('aria-pressed')==='true');
    });
    return b;
  }

  function renderChips(){
    const main = root.querySelector('.main'); if(!main) return;
    const k = key();
    if(!['chips','storage/integrations','backend/level'].includes(k)) return;

    const title = $('#gp-title'); const desc = $('#gp-desc');
    title && (title.textContent = 'Конструктор: збери конфіг вашого бота');
    desc && (desc.textContent = 'Обери потрібні чіпи. Превʼю англомовного BRIEF і CURSOR PROMPT знизу.');

    // очистити динаміку
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    // блоки
    const wrap = document.createElement('div'); wrap.className='dyn chips-wrap';

    // TYPE (single)
    wrap.appendChild(sectionCard('Тип бота', CHIPSETS.type, (val, was)=>{
      state.profile.type = (state.profile.type===val && was) ? '' : val;
      save(); renderPreview();
    }, (val)=> state.profile.type===val, true));

    // MODULES (multi)
    wrap.appendChild(sectionCard('Модулі', CHIPSETS.modules, (val, was)=>{
      toggleIn(state.profile.modules, val, was);
      save(); renderPreview();
    }, (val)=> state.profile.modules.includes(val), false));

    // DATA (single)
    wrap.appendChild(sectionCard('Дані / Збереження', CHIPSETS.data, (val, was)=>{
      state.profile.data = (state.profile.data===val && was) ? 'json' : val;
      save(); renderPreview();
    }, (val)=> state.profile.data===val, true));

    // INTEGRATIONS (multi)
    wrap.appendChild(sectionCard('Інтеграції', CHIPSETS.integrations, (val, was)=>{
      toggleIn(state.profile.integrations, val, was);
      save(); renderPreview();
    }, (val)=> state.profile.integrations.includes(val), false));

    // BACKEND (single)
    wrap.appendChild(sectionCard('Бекенд (опц.)', CHIPSETS.backend, (val, was)=>{
      state.profile.backend = (state.profile.backend===val && was) ? 'none' : val;
      save(); renderPreview();
    }, (val)=> state.profile.backend===val, true));

    // LEVEL (single)
    wrap.appendChild(sectionCard('Рівень складності', CHIPSETS.level, (val, was)=>{
      state.profile.level = (state.profile.level===val && was) ? 'L1' : val;
      save(); renderPreview();
    }, (val)=> state.profile.level===val, true));

    // PREVIEW
    const prev = document.createElement('div'); prev.className='card';
    prev.innerHTML = `
      <b>Превʼю · DEV BRIEF (EN)</b>
      <div class="kbd" id="m5-brief"></div>
      <div class="row">
        <button class="btn" id="m5-copy-brief">Скопіювати BRIEF</button>
      </div>
      <div style="height:8px"></div>
      <b>Превʼю · CURSOR PROMPT (EN)</b>
      <div class="kbd" id="m5-prompt"></div>
      <div class="row">
        <button class="btn primary" id="m5-copy-cursor">Скопіювати для Cursor</button>
        <button class="btn" id="m5-done">Готово → Огляд</button>
      </div>
    `;
    wrap.appendChild(prev);

    main.appendChild(wrap);
    renderPreview();

    $('#m5-copy-brief')?.addEventListener('click', ()=> copyText(makeBrief(state.profile)));
    $('#m5-copy-cursor')?.addEventListener('click', ()=> copyText(makeCursor(state.profile)));
    $('#m5-done')?.addEventListener('click', ()=> {
      // помітити done і перейти на “DEV BRIEF (EN)”
      const idx = state.current;
      if(!state.done.includes(idx)) state.done.push(idx);
      save();
      root.dispatchEvent(new CustomEvent('gp:markDone'));
      const ni = flat.findIndex(x=>x.key==='brief');
      if(ni>=0){ state.current=ni; save(); renderChips(); renderPreview(true); }
    });
  }

  function sectionCard(title, items, onClick, isActive, single){
    const card = document.createElement('div'); card.className='card';
    const row = document.createElement('div'); row.className='chip-row';
    card.innerHTML = `<b>${title}${single?' (один вибір)':' (кілька)'} </b>`;
    items.forEach(val=>{
      const b = chip(val, isActive(val), (label, wasPressed)=>{
        // якщо single — зняти інші
        if(single){
          row.querySelectorAll('.chipbtn').forEach(x=>x.setAttribute('aria-pressed','false'));
          b.setAttribute('aria-pressed', String(!(state.profile[typeByTitle(title)]===label && wasPressed)));
        }else{
          b.setAttribute('aria-pressed', String(!wasPressed));
        }
        onClick(label, wasPressed);
      });
      row.appendChild(b);
    });
    card.appendChild(row);
    return card;
  }

  function typeByTitle(title){
    if(title.startsWith('Тип')) return 'type';
    if(title.startsWith('Дані')) return 'data';
    if(title.startsWith('Бекенд')) return 'backend';
    if(title.startsWith('Рівень')) return 'level';
    return '';
  }
  function toggleIn(arr, val, wasPressed){
    const i = arr.indexOf(val);
    if(wasPressed && i>-1) arr.splice(i,1);
    else if(!wasPressed && i===-1) arr.push(val);
  }

  // Превʼю генератори (короткі, без коду)
  function makeBrief(p){
    const mods = p.modules.length? p.modules.join(', ') : 'basic';
    const ints = p.integrations.length? p.integrations.join(', ') : 'none';
    return [
      `Type: ${p.type||'Custom'} · Level: ${p.level||'L1'} · Backend: ${p.backend||'none'}`,
      `Goal: ${p.goal||'-'}`,
      `Commands: ${p.cmds||'/start, /help'}`,
      `Modules: ${mods}`,
      `Data: ${p.data} · Integrations: ${ints}`,
      `Tech: Python 3.10+, aiogram v3, python-dotenv`,
      `Structure: requirements.txt, main.py, .env(.example), data/ (if needed)`,
      `Run: pip install -r requirements.txt && python main.py`,
      `UI Language: ${p.lang||'uk'} · Channel: ${p.channel||'DM'}`
    ].join('\n');
  }
  function makeCursor(p){
    const brief = makeBrief(p);
    return [
`[CHAT 2 | PROGRAMMER] CURRENT STEP: Generate skeleton by profile`,
`TERMINAL> none`,
`CODE> none`,
`INSTRUCTION:`,
`Use Python 3.10+, aiogram v3, python-dotenv.`,
`Implement minimal working bot according to this profile:`,
`----- DEV BRIEF -----`,
brief,
`---------------------`,
`Deliverables:`,
`- requirements.txt (aiogram==3.*, python-dotenv, loguru)`,
`- main.py with /start, /help; start polling`,
`- .env.example (TOKEN=your_token_here)`,
`No extra prose. Keep messages in ${p.lang||'uk'}.`
    ].join('\n');
  }

  function renderPreview(skipSet){
    const b = $('#m5-brief'); const p = $('#m5-prompt');
    if(b) b.textContent = makeBrief(state.profile);
    if(p) p.textContent = makeCursor(state.profile);
    if(!skipSet){
      const title = $('#gp-title'); if(title) title.textContent = 'Конструктор: збери конфіг вашого бота';
    }
    // оновити прогрес у шапці
    const progressEl = $('#gp-progress');
    if(progressEl){
      const pct = Math.round((state.done.length/flat.length)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
  }

  function copyText(txt){
    (async()=>{
      try{
        if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); return; }
      }catch(e){}
      const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); toast('Скопійовано.'); }catch(e){ alert('Скопіюй вручну.'); }
      finally{ document.body.removeChild(ta); }
    })();
  }
  function toast(msg){
    let t = root.querySelector('#gp-toast-m5');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m5'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m5);
    window.__gp_to_m5 = setTimeout(()=> t.style.display='none', 1600);
  }

  function init(){
    load();
    // рендерити, коли користувач заходить у будь-який пункт “Конструктора”
    renderChips();
    // слідкуємо за змінами current (кліки у сайдбарі)
    setInterval(()=> renderChips(), 400);
  }
  init();
})();
</script>
<!-- GP:END CHIPS SCRIPT -->
<!-- GP:M5 END -->
<!-- GP:M6 START • REVIEW & CONFIRM (build 2025-10-29.7) -->
<!-- GP:BEGIN REVIEW STYLES -->
<style>
  #gp-panel .review-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel .check{display:grid;grid-template-columns:1fr;gap:8px;margin-top:6px}
  #gp-panel .check .li{display:flex;gap:8px;align-items:flex-start}
  #gp-panel .check .li .i{width:18px;height:18px;border:1px solid var(--line);border-radius:4px;
    display:inline-flex;align-items:center;justify-content:center;font-size:12px}
</style>
<!-- GP:END REVIEW STYLES -->

<!-- GP:BEGIN REVIEW SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 7;

  // flat як у попередніх модулів
  const sections = [
    { title:'0 · Старт', items:[{t:'Почати', b:'welcome'},{t:'Як це працює', b:'guide'}]},
    { title:'1 · Анкета', items:[{t:'Заповнити 5 полів', b:'form'},{t:'Підтвердити анкету', b:'confirm'}]},
    { title:'2 · Режим', items:[{t:'AUTO', b:'auto'},{t:'ASSISTED', b:'assisted'}]},
    { title:'3 · Конструктор', items:[{t:'Тип / Модулі', b:'chips'},{t:'Дані / Інтеграції', b:'storage/integrations'},{t:'Бекенд (опц.) / Рівень', b:'backend/level'}]},
    { title:'4 · Огляд', items:[{t:'DEV BRIEF (EN)', b:'brief'},{t:'CURSOR PROMPT (EN)', b:'prompt'}]},
    { title:'5 · Середовище', items:[{t:'Local vs Codespaces', b:'env'}]},
    { title:'6 · Інструменти / Files', items:[{t:'Встановити/Відкрити', b:'tools'},{t:'Чек-лист файлів', b:'files'}]},
    { title:'7 · Вставити у Cursor', items:[{t:'Скопіювати промпт', b:'copy-cursor'},{t:'Де вставити?', b:'cursor-how'}]},
    { title:'8 · Запуск', items:[{t:'Команди запуску', b:'run'},{t:'Є проблема', b:'troubles'}]},
    { title:'9 · BotFather', items:[{t:'/setcommands', b:'bf-commands'}]},
    { title:'10 · Перевірка', items:[{t:'/start /help', b:'test'}]},
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  let flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION, mode: root.getAttribute('data-mode')||'auto',
    theme: root.getAttribute('data-theme')||'light',
    lang:'uk', ruLink:'', current:0, done:[], filter:'',
    profile:{ role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
      type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
    },
    assistedBrief:''
  };

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY); if(!raw) return;
      const prev = JSON.parse(raw)||{};
      state = Object.assign(state, prev);
      state.v = STATE_VERSION;
      // дефолти
      state.profile = Object.assign({
        role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
        type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
      }, state.profile||{});
      if(!Array.isArray(state.profile.modules)) state.profile.modules=[];
      if(!Array.isArray(state.profile.integrations)) state.profile.integrations=[];
      if(!state.profile.level) state.profile.level='L1';
    }catch(e){}
  }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){ return (flat[state.current]||flat[0]).key; }

  // генеруємо текст
  function makeBrief(p){
    const mods = p.modules.length? p.modules.join(', ') : 'basic';
    const ints = p.integrations.length? p.integrations.join(', ') : 'none';
    return [
      `Type: ${p.type||'Custom'} · Level: ${p.level||'L1'} · Backend: ${p.backend||'none'}`,
      `Goal: ${p.goal||'-'}`,
      `Commands: ${p.cmds||'/start, /help'}`,
      `Modules: ${mods}`,
      `Data: ${p.data} · Integrations: ${ints}`,
      `Tech: Python 3.10+, aiogram v3, python-dotenv`,
      `Structure: requirements.txt, main.py, .env(.example), data/ (if needed)`,
      `Run: pip install -r requirements.txt && python main.py`,
      `UI Language: ${p.lang||'uk'} · Channel: ${p.channel||'DM'}`
    ].join('\n');
  }
  function makeCursor(p, brief){
    return [
`[CHAT 2 | PROGRAMMER] CURRENT STEP: Generate skeleton by profile`,
`TERMINAL> none`,
`CODE> none`,
`INSTRUCTION:`,
`Use Python 3.10+, aiogram v3, python-dotenv.`,
`Implement minimal working bot according to this profile:`,
`----- DEV BRIEF -----`,
brief,
`---------------------`,
`Deliverables:`,
`- requirements.txt (aiogram==3.*, python-dotenv, loguru)`,
`- main.py with /start, /help; start polling`,
`- .env.example (TOKEN=your_token_here)`,
`No extra prose. Keep messages in ${p.lang||'uk'}.`
    ].join('\n');
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function copyText(txt){
    (async()=>{
      try{
        if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); return; }
      }catch(e){}
      const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); toast('Скопійовано.'); }catch(e){ alert('Скопіюй вручну.'); }
      finally{ document.body.removeChild(ta); }
    })();
  }
  function toast(msg){
    let t = root.querySelector('#gp-toast-m6');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m6'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m6);
    window.__gp_to_m6 = setTimeout(()=> t.style.display='none', 1600);
  }

  function markDoneAndGo(nextKey){
    const idx = state.current;
    if(!state.done.includes(idx)) state.done.push(idx);
    save();
    root.dispatchEvent(new CustomEvent('gp:markDone')); // M2 оновить сайдбар
    const ni = flat.findIndex(x=>x.key===nextKey);
    if(ni>=0){ state.current = ni; save(); renderReview(true); }
  }

  function renderReview(force){
    load();
    const key = getKey();
    if(key!=='brief' && key!=='prompt') return;

    const main = root.querySelector('.main'); if(!main) return;
    const title = $('#gp-title'); const desc = $('#gp-desc');
    title && (title.textContent = 'Огляд та підтвердження');
    desc && (desc.textContent = 'Перевір BRIEF і CURSOR PROMPT. Якщо все ок — підтвердь і рушай далі.');

    // дані
    const p = state.profile;
    const brief = (state.assistedBrief||'').trim() ? state.assistedBrief.trim() : makeBrief(p);
    const cursor = makeCursor(p, brief);

    // чистимо динаміку
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    // контент
    const wrap = document.createElement('div'); wrap.className='dyn review-wrap';
    wrap.innerHTML = `
      <div class="card">
        <b>DEV BRIEF (EN)</b>
        <div class="kbd" id="m6-brief">${escapeHtml(brief)}</div>
        <div class="row">
          <button class="btn" id="m6-copy-brief">Скопіювати BRIEF</button>
        </div>
      </div>

      <div class="card">
        <b>CURSOR PROMPT (EN)</b>
        <div class="kbd" id="m6-prompt">${escapeHtml(cursor)}</div>
        <div class="row">
          <button class="btn primary" id="m6-copy-cursor">Скопіювати для Cursor</button>
        </div>
      </div>

      <div class="card">
        <b>Що буде зроблено</b>
        <div class="check">
          ${[
            'Створимо requirements.txt з потрібними бібліотеками',
            'Згенеруємо main.py з командами /start і /help',
            'Покладемо .env.example (TOKEN=your_token_here)',
            'Пояснимо де вставити промпт у Cursor і як запустити',
            'Підготуємо /setcommands для BotFather'
          ].map((t,i)=>(
            `<div class="li">
              <span class="i">${i+1}</span>
              <div>${t}</div>
            </div>`
          )).join('')}
        </div>
        <div class="row">
          <button class="btn" id="m6-back">Назад до Конструктора</button>
          <button class="btn primary" id="m6-approve">Підтвердити і далі → Середовище</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // дії
    $('#m6-copy-brief')?.addEventListener('click', ()=> copyText(brief));
    $('#m6-copy-cursor')?.addEventListener('click', ()=> copyText(cursor));
    $('#m6-back')?.addEventListener('click', ()=>{
      const ni = flat.findIndex(x=>x.key==='chips');
      if(ni>=0){ state.current=ni; save(); renderReview(true); }
    });
    $('#m6-approve')?.addEventListener('click', ()=>{
      // позначаємо обидва пункти секції "Огляд" виконаними (brief+prompt)
      const iBrief = flat.findIndex(x=>x.key==='brief');
      const iPrompt = flat.findIndex(x=>x.key==='prompt');
      [iBrief,iPrompt].forEach(i=>{ if(i>=0 && !state.done.includes(i)) state.done.push(i); });
      save(); root.dispatchEvent(new CustomEvent('gp:markDone'));
      markDoneAndGo('env'); // на Local vs Codespaces
    });

    // оновити прогрес у шапці
    const progressEl = $('#gp-progress');
    if(progressEl){
      const pct = Math.round((state.done.length/flat.length)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
  }

  function init(){
    load();
    renderReview(true);
    // реагуємо на перемикання current із сайдбару
    setInterval(()=> renderReview(false), 400);
  }
  init();
})();
</script>
<!-- GP:END REVIEW SCRIPT -->
<!-- GP:M6 END -->
<!-- GP:M7 START • ENV: Local vs Codespaces (build 2025-10-29.8) -->
<!-- GP:BEGIN ENV STYLES -->
<style>
  #gp-panel .env-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .hint-ok{font-size:12px;color:var(--muted)}
  #gp-panel .env-badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);
    border-radius:999px;padding:4px 10px}
</style>
<!-- GP:END ENV STYLES -->

<!-- GP:BEGIN ENV SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 8;

  // flat порядок (той самий)
  const sections = [
    { title:'0 · Старт', items:[{t:'Почати', b:'welcome'},{t:'Як це працює', b:'guide'}]},
    { title:'1 · Анкета', items:[{t:'Заповнити 5 полів', b:'form'},{t:'Підтвердити анкету', b:'confirm'}]},
    { title:'2 · Режим', items:[{t:'AUTO', b:'auto'},{t:'ASSISTED', b:'assisted'}]},
    { title:'3 · Конструктор', items:[{t:'Тип / Модулі', b:'chips'},{t:'Дані / Інтеграції', b:'storage/integrations'},{t:'Бекенд (опц.) / Рівень', b:'backend/level'}]},
    { title:'4 · Огляд', items:[{t:'DEV BRIEF (EN)', b:'brief'},{t:'CURSOR PROMPT (EN)', b:'prompt'}]},
    { title:'5 · Середовище', items:[{t:'Local vs Codespaces', b:'env'}]},
    { title:'6 · Інструменти / Files', items:[{t:'Встановити/Відкрити', b:'tools'},{t:'Чек-лист файлів', b:'files'}]},
    { title:'7 · Вставити у Cursor', items:[{t:'Скопіювати промпт', b:'copy-cursor'},{t:'Де вставити?', b:'cursor-how'}]},
    { title:'8 · Запуск', items:[{t:'Команди запуску', b:'run'},{t:'Є проблема', b:'troubles'}]},
    { title:'9 · BotFather', items:[{t:'/setcommands', b:'bf-commands'}]},
    { title:'10 · Перевірка', items:[{t:'/start /help', b:'test'}]},
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  const flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION,
    mode: root.getAttribute('data-mode')||'auto',   // auto/light/dark theme mode
    theme: root.getAttribute('data-theme')||'light',
    lang:'uk', ruLink:'', current:0, done:[], filter:'',
    env: root.getAttribute('data-env')||'local',    // <-- важливо
    profile:{ role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
      type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
    },
    assistedBrief:''
  };

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY); if(!raw) return;
      const prev = JSON.parse(raw)||{};
      state = Object.assign(state, prev);
      state.v = STATE_VERSION;
      if(!state.env) state.env = 'local';
      // дефолти профілю
      state.profile = Object.assign({
        role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
        type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
      }, state.profile||{});
      if(!Array.isArray(state.profile.modules)) state.profile.modules=[];
      if(!Array.isArray(state.profile.integrations)) state.profile.integrations=[];
    }catch(e){}
  }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){ return (flat[state.current]||flat[0]).key; }
  function setEnv(env){
    state.env = env;
    root.setAttribute('data-env', env);
    save();
    renderEnv(true);
  }

  // короткі поради “що обрати?”
  function envAdvice(){
    return [
      '• Якщо не хочеш ставити нічого — обирай Codespaces (все у браузері).',
      '• Якщо маєш Mac/Windows і хочеш офлайн — обирай Local.',
      '• На слабкому ноуті — Codespaces комфортніше.',
      '• Обидва варіанти працюють однаково для нашої системи.'
    ].join('\n');
  }

  function localChecklist(){
    return [
`1) Встанови Python 3.10+ (якщо вже є — пропусти).`,
`2) Встанови Cursor (або VS Code).`,
`3) Створи папку проекту і відкрий її у Cursor.`,
`4) Далі ми скинемо файли (requirements.txt, main.py, .env.example).`,
`5) Запуск: pip install -r requirements.txt  →  python main.py`
    ].join('\n');
  }
  function codesChecklist(){
    return [
`1) Натисни “Open in Codespaces” (GitHub акаунт потрібен).`,
`2) Створиться середовище з Python у браузері.`,
`3) Відкрий вбудований Terminal (там же).`,
`4) Далі ми скинемо файли (requirements.txt, main.py, .env.example).`,
`5) Запуск: pip install -r requirements.txt  →  python main.py`
    ].join('\n');
  }

  function markDoneAndGo(nextKey){
    const idx = state.current;
    if(!state.done.includes(idx)) state.done.push(idx);
    save();
    root.dispatchEvent(new CustomEvent('gp:markDone')); // оновить сайдбар/прогрес
    const ni = flat.findIndex(x=>x.key===nextKey);
    if(ni>=0){ state.current = ni; save(); renderEnv(true); }
  }

  function renderEnv(force){
    load();
    const key = getKey();
    if(key!=='env') return;

    const main = root.querySelector('.main'); if(!main) return;
    const title = $('#gp-title'); const desc = $('#gp-desc');
    title && (title.textContent = 'Середовище: Local чи Codespaces');
    desc && (desc.textContent = 'Обери варіант. Нижче — простий чекліст і швидкі кнопки.');

    // чистимо попередні динамічні блоки
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    const wrap = document.createElement('div'); wrap.className='dyn env-wrap';
    wrap.innerHTML = `
      <div class="card">
        <div class="row">
          <span class="env-badge">Поточне: <b id="env-badge">${(state.env||'local').toUpperCase()}</b></span>
          <button class="btn" id="env-choose-local">Обрати Local</button>
          <button class="btn" id="env-choose-codes">Обрати Codespaces</button>
        </div>
        <div class="kbd hint-ok" style="margin-top:8px">${envAdvice()}</div>
      </div>

      <div class="card">
        <b>Local (офлайн на твоєму ПК)</b>
        <div class="kbd" id="env-local-steps">${localChecklist()}</div>
        <div class="row">
          <button class="btn" id="open-python">Python.org</button>
          <button class="btn" id="open-cursor">Відкрити Cursor</button>
          <button class="btn" id="open-folder">Як відкрити папку у Cursor?</button>
        </div>
      </div>

      <div class="card">
        <b>Codespaces (у браузері)</b>
        <div class="kbd" id="env-codes-steps">${codesChecklist()}</div>
        <div class="row">
          <button class="btn" id="open-codes">Відкрити GitHub Codespaces</button>
          <button class="btn" id="open-gh">Відкрити GitHub</button>
        </div>
      </div>

      <div class="card">
        <b>Далі</b>
        <div class="hint">Коли обереш середовище — тисни “Позначити як виконано” і перейдемо до інструментів/файлів.</div>
        <div class="row">
          <button class="btn primary" id="env-done">Позначити як виконано → Інструменти/Files</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // bind env switch
    $('#env-choose-local')?.addEventListener('click', ()=> setEnv('local'));
    $('#env-choose-codes')?.addEventListener('click', ()=> setEnv('codespaces'));

    // quick links (відкриваємо у новій вкладці)
    $('#open-python')?.addEventListener('click', ()=> window.open('https://www.python.org/downloads/','_blank','noopener'));
    $('#open-cursor')?.addEventListener('click', ()=> window.open('https://www.cursor.com/','_blank','noopener'));
    $('#open-folder')?.addEventListener('click', ()=> alert('Cursor → File → Open… → обери папку проекту. Далі працюємо всередині цієї папки.'));
    $('#open-codes')?.addEventListener('click', ()=> window.open('https://github.com/codespaces','_blank','noopener'));
    $('#open-gh')?.addEventListener('click', ()=> window.open('https://github.com/','_blank','noopener'));

    // done → go next
    $('#env-done')?.addEventListener('click', ()=>{
      // відмітити “env” як done і перейти на “tools”
      markDoneAndGo('tools');
    });

    // оновити бейдж
    const badge = $('#env-badge'); if(badge) badge.textContent = (state.env||'local').toUpperCase();

    // легкий апдейт прогресу у шапці
    const progressEl = $('#gp-progress');
    if(progressEl){
      const pct = Math.round((state.done.length/flat.length)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
  }

  function init(){
    load();
    renderEnv(true);
    // реагуємо на кліки з сайдбару
    setInterval(()=> renderEnv(false), 400);
  }
  init();
})();
</script>
<!-- GP:END ENV SCRIPT -->
<!-- GP:M7 END -->
<!-- GP:M8 START • TOOLS & FILES (build 2025-10-29.9) -->
<!-- GP:BEGIN TOOLS/FILES STYLES -->
<style>
  #gp-panel .tools-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .listy{display:grid;grid-template-columns:1fr;gap:6px;margin-top:6px}
  #gp-panel .li{display:flex;gap:8px;align-items:flex-start}
  #gp-panel .li .i{width:18px;height:18px;border:1px solid var(--line);border-radius:4px;
    display:inline-flex;align-items:center;justify-content:center;font-size:12px}
</style>
<!-- GP:END TOOLS/FILES STYLES -->

<!-- GP:BEGIN TOOLS/FILES SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 9;

  // flat як у попередніх модулів
  const sections = [
    { title:'0 · Старт', items:[{t:'Почати', b:'welcome'},{t:'Як це працює', b:'guide'}]},
    { title:'1 · Анкета', items:[{t:'Заповнити 5 полів', b:'form'},{t:'Підтвердити анкету', b:'confirm'}]},
    { title:'2 · Режим', items:[{t:'AUTO', b:'auto'},{t:'ASSISTED', b:'assisted'}]},
    { title:'3 · Конструктор', items:[{t:'Тип / Модулі', b:'chips'},{t:'Дані / Інтеграції', b:'storage/integrations'},{t:'Бекенд (опц.) / Рівень', b:'backend/level'}]},
    { title:'4 · Огляд', items:[{t:'DEV BRIEF (EN)', b:'brief'},{t:'CURSOR PROMPT (EN)', b:'prompt'}]},
    { title:'5 · Середовище', items:[{t:'Local vs Codespaces', b:'env'}]},
    { title:'6 · Інструменти / Files', items:[{t:'Встановити/Відкрити', b:'tools'},{t:'Чек-лист файлів', b:'files'}]},
    { title:'7 · Вставити у Cursor', items:[{t:'Скопіювати промпт', b:'copy-cursor'},{t:'Де вставити?', b:'cursor-how'}]},
    { title:'8 · Запуск', items:[{t:'Команди запуску', b:'run'},{t:'Є проблема', b:'troubles'}]},
    { title:'9 · BotFather', items:[{t:'/setcommands', b:'bf-commands'}]},
    { title:'10 · Перевірка', items:[{t:'/start /help', b:'test'}]},
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  const flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION,
    mode: root.getAttribute('data-mode')||'auto',
    theme: root.getAttribute('data-theme')||'light',
    lang:'uk', ruLink:'', current:0, done:[], filter:'',
    env: root.getAttribute('data-env')||'local',
    profile:{ role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
      type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
    },
    assistedBrief:''
  };

  function load(){ try{
    const raw=localStorage.getItem(STORE_KEY); if(!raw) return;
    const prev=JSON.parse(raw)||{}; state=Object.assign(state, prev); state.v=STATE_VERSION;
    if(!state.env) state.env='local';
    state.profile = Object.assign({
      role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
      type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
    }, state.profile||{});
    if(!Array.isArray(state.profile.modules)) state.profile.modules=[];
    if(!Array.isArray(state.profile.integrations)) state.profile.integrations=[];
  }catch(e){} }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){ return (flat[state.current]||flat[0]).key; }

  // З BRIEF/PROMPT беремо з профілю/конструктора
  function makeBrief(p){
    const mods = p.modules.length? p.modules.join(', ') : 'basic';
    const ints = p.integrations.length? p.integrations.join(', ') : 'none';
    return [
      `Type: ${p.type||'Custom'} · Level: ${p.level||'L1'} · Backend: ${p.backend||'none'}`,
      `Goal: ${p.goal||'-'}`,
      `Commands: ${p.cmds||'/start, /help'}`,
      `Modules: ${mods}`,
      `Data: ${p.data} · Integrations: ${ints}`,
      `Tech: Python 3.10+, aiogram v3, python-dotenv`,
      `Structure: requirements.txt, main.py, .env(.example), data/ (if needed)`,
      `Run: pip install -r requirements.txt && python main.py`,
      `UI Language: ${p.lang||'uk'} · Channel: ${p.channel||'DM'}`
    ].join('\n');
  }
  function makeCursorPrompt(p, brief){
    return [
`[CHAT 2 | PROGRAMMER] CURRENT STEP: Generate skeleton by profile`,
`TERMINAL> none`,
`CODE> none`,
`INSTRUCTION:`,
`Use Python 3.10+, aiogram v3, python-dotenv.`,
`Implement minimal working bot according to this profile:`,
`----- DEV BRIEF -----`,
brief,
`---------------------`,
`Deliverables:`,
`- requirements.txt (aiogram==3.*, python-dotenv, loguru)`,
`- main.py with /start, /help; start polling`,
`- .env.example (TOKEN=your_token_here)`,
`No extra prose. Keep messages in ${p.lang||'uk'}.`
    ].join('\n');
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  async function copyText(txt){
    try{
      if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); return; }
    }catch(e){}
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); toast('Скопійовано.'); }catch(e){ alert('Скопіюй вручну.'); }
    finally{ document.body.removeChild(ta); }
  }
  function toast(msg){
    let t = root.querySelector('#gp-toast-m8');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m8'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m8);
    window.__gp_to_m8 = setTimeout(()=> t.style.display='none', 1600);
  }

  function markDoneAndGo(nextKey){
    const idx = state.current;
    if(!state.done.includes(idx)) state.done.push(idx);
    save(); root.dispatchEvent(new CustomEvent('gp:markDone'));
    const ni = flat.findIndex(x=>x.key===nextKey);
    if(ni>=0){ state.current=ni; save(); renderTools(true); }
  }

  function whereToPasteHelp(){
    return [
'В Cursor відкрий чат у правій панелі (Cmd/Ctrl+I або іконка “Chat”).',
'У полі повідомлення вставляй наш CURSOR PROMPT (англійською).',
'УВАГА: використовуй чат, який повʼязаний із поточною папкою проекту.',
'Далі Cursor сам згенерує/запропонує створити файли. Погоджуйся.',
'Якщо чат відповідає прозаою — додай у кінці PROMPT: “No prose. Return only code blocks.”'
    ].join('\n');
  }

  function localTools(){
    return [
'• Python 3.10+ встановлено? Якщо ні — завантаж з python.org.',
'• Cursor встановлено? Якщо ні — cursor.com → Install.',
'• Відкрий папку проекту у Cursor: File → Open Folder…',
'• Відкрий Chat у Cursor (Cmd/Ctrl+I).'
    ].join('\n');
  }
  function codesTools(){
    return [
'• Відкрий GitHub Codespaces (потрібен GitHub акаунт).',
'• Створи Codespace → відкриється VS Code у браузері.',
'• Відкрий вбудований Terminal (Ctrl+` або View → Terminal).',
'• Відкрий GitHub Copilot Chat/Editor Chat — або встав PROMPT у Codespaces Chat.',
'• Якщо використовуєш Cursor у локальному браузері — працюй у локальному варіанті.'
    ].join('\n');
  }

  function renderTools(force){
    load();
    const key = getKey();
    if(key!=='tools' && key!=='files') return;

    const main = root.querySelector('.main'); if(!main) return;
    const title = $('#gp-title'); const desc = $('#gp-desc');
    title && (title.textContent = 'Інструменти та файли');
    desc && (desc.textContent = 'Відкрий потрібні інструменти. Потім — згенеруємо файли через Cursor.');

    // прибираємо динаміку
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    const brief = (state.assistedBrief||'').trim() ? state.assistedBrief.trim() : makeBrief(state.profile);
    const cursorPrompt = makeCursorPrompt(state.profile, brief);

    const wrap = document.createElement('div'); wrap.className='dyn tools-wrap';
    wrap.innerHTML = `
      <div class="card">
        <b>Встановити / Відкрити</b>
        <div class="kbd" id="m8-tools">${state.env==='codespaces' ? codesTools() : localTools()}</div>
        <div class="row">
          <button class="btn" id="m8-open-python">Python.org</button>
          <button class="btn" id="m8-open-cursor">Відкрити Cursor</button>
          <button class="btn" id="m8-open-codes">GitHub Codespaces</button>
        </div>
      </div>

      <div class="card">
        <b>Чек-лист файлів (мають зʼявитись після PROMPT)</b>
        <div class="listy">
          <div class="li"><span class="i">1</span><div><code>requirements.txt</code> з <code>aiogram==3.*</code>, <code>python-dotenv</code>, <code>loguru</code></div></div>
          <div class="li"><span class="i">2</span><div><code>main.py</code> зі стартовим скелетом (/start, /help, polling)</div></div>
          <div class="li"><span class="i">3</span><div><code>.env.example</code> з <code>TOKEN=your_token_here</code></div></div>
        </div>
        <div class="row">
          <button class="btn primary" id="m8-copy-cursor">Скопіювати PROMPT для Cursor</button>
          <button class="btn" id="m8-where">Де саме вставити?</button>
        </div>
        <div class="kbd" id="m8-prompt" style="display:none"></div>
      </div>

      <div class="card">
        <b>Далі</b>
        <div class="hint">Коли готовий — позначаємо розділ як виконаний і переходимо до “Вставити у Cursor”.</div>
        <div class="row">
          <button class="btn primary" id="m8-done">Позначити як виконано → Вставити у Cursor</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // кнопки
    $('#m8-open-python')?.addEventListener('click', ()=> window.open('https://www.python.org/downloads/','_blank','noopener'));
    $('#m8-open-cursor')?.addEventListener('click', ()=> window.open('https://www.cursor.com/','_blank','noopener'));
    $('#m8-open-codes')?.addEventListener('click', ()=> window.open('https://github.com/codespaces','_blank','noopener'));

    $('#m8-copy-cursor')?.addEventListener('click', async()=>{
      const box = $('#m8-prompt'); if(box){ box.textContent = cursorPrompt; box.style.display='block'; }
      await copyText(cursorPrompt);
    });

    $('#m8-where')?.addEventListener('click', ()=>{
      alert(whereToPasteHelp());
    });

    $('#m8-done')?.addEventListener('click', ()=>{
      // позначити current (“tools” або “files”) як done і перейти на “copy-cursor”
      const idx = state.current;
      if(!state.done.includes(idx)) state.done.push(idx);
      save(); root.dispatchEvent(new CustomEvent('gp:markDone'));
      const ni = flat.findIndex(x=>x.key==='copy-cursor');
      if(ni>=0){ state.current=ni; save(); renderTools(true); }
    });

    // оновити шапку-прогрес
    const progressEl = $('#gp-progress');
    if(progressEl){
      const pct = Math.round((state.done.length/flat.length)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
  }

  function init(){
    load();
    renderTools(true);
    setInterval(()=> renderTools(false), 400);
  }
  init();
})();
</script>
<!-- GP:END TOOLS/FILES SCRIPT -->
<!-- GP:M8 END -->
<!-- GP:M9 START • INSERT INTO CURSOR (build 2025-10-29.10) -->
<!-- GP:BEGIN COPY-CURSOR STYLES -->
<style>
  #gp-panel .cursor-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel textarea.kbd{min-height:200px}
  #gp-panel .listy{display:grid;grid-template-columns:1fr;gap:6px;margin-top:6px}
  #gp-panel .li{display:flex;gap:8px;align-items:flex-start}
  #gp-panel .li .i{width:18px;height:18px;border:1px solid var(--line);border-radius:4px;display:inline-flex;align-items:center;justify-content:center;font-size:12px}
</style>
<!-- GP:END COPY-CURSOR STYLES -->

<!-- GP:BEGIN COPY-CURSOR SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 10;

  // синхронний flat як раніше
  const sections = [
    { title:'0 · Старт', items:[{t:'Почати', b:'welcome'},{t:'Як це працює', b:'guide'}]},
    { title:'1 · Анкета', items:[{t:'Заповнити 5 полів', b:'form'},{t:'Підтвердити анкету', b:'confirm'}]},
    { title:'2 · Режим', items:[{t:'AUTO', b:'auto'},{t:'ASSISTED', b:'assisted'}]},
    { title:'3 · Конструктор', items:[{t:'Тип / Модулі', b:'chips'},{t:'Дані / Інтеграції', b:'storage/integrations'},{t:'Бекенд (опц.) / Рівень', b:'backend/level'}]},
    { title:'4 · Огляд', items:[{t:'DEV BRIEF (EN)', b:'brief'},{t:'CURSOR PROMPT (EN)', b:'prompt'}]},
    { title:'5 · Середовище', items:[{t:'Local vs Codespaces', b:'env'}]},
    { title:'6 · Інструменти / Files', items:[{t:'Встановити/Відкрити', b:'tools'},{t:'Чек-лист файлів', b:'files'}]},
    { title:'7 · Вставити у Cursor', items:[{t:'Скопіювати промпт', b:'copy-cursor'},{t:'Де вставити?', b:'cursor-how'}]},
    { title:'8 · Запуск', items:[{t:'Команди запуску', b:'run'},{t:'Є проблема', b:'troubles'}]},
    { title:'9 · BotFather', items:[{t:'/setcommands', b:'bf-commands'}]},
    { title:'10 · Перевірка', items:[{t:'/start /help', b:'test'}]},
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  const flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION,
    mode: root.getAttribute('data-mode')||'auto',
    theme: root.getAttribute('data-theme')||'light',
    lang:'uk', ruLink:'', current:0, done:[], filter:'',
    env: root.getAttribute('data-env')||'local',
    profile:{ role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
      type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
    },
    assistedBrief:''
  };

  function load(){ try{
    const raw=localStorage.getItem(STORE_KEY); if(!raw) return;
    const prev=JSON.parse(raw)||{}; state=Object.assign(state, prev); state.v=STATE_VERSION;
    if(!state.env) state.env='local';
    state.profile = Object.assign({
      role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
      type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
    }, state.profile||{});
    if(!Array.isArray(state.profile.modules)) state.profile.modules=[];
    if(!Array.isArray(state.profile.integrations)) state.profile.integrations=[];
    if(typeof state.assistedBrief!=='string') state.assistedBrief='';
  }catch(e){} }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){ return (flat[state.current]||flat[0]).key; }

  // генератори текстів
  function makeBrief(p){
    const mods = p.modules.length? p.modules.join(', ') : 'basic';
    const ints = p.integrations.length? p.integrations.join(', ') : 'none';
    return [
      `Type: ${p.type||'Custom'} · Level: ${p.level||'L1'} · Backend: ${p.backend||'none'}`,
      `Goal: ${p.goal||'-'}`,
      `Commands: ${p.cmds||'/start, /help'}`,
      `Modules: ${mods}`,
      `Data: ${p.data} · Integrations: ${ints}`,
      `Tech: Python 3.10+, aiogram v3, python-dotenv`,
      `Structure: requirements.txt, main.py, .env(.example), data/ (if needed)`,
      `Run: pip install -r requirements.txt && python main.py`,
      `UI Language: ${p.lang||'uk'} · Channel: ${p.channel||'DM'}`
    ].join('\n');
  }
  function makeCursorPrompt(p, brief){
    return [
`[CHAT 2 | PROGRAMMER] CURRENT STEP: Generate skeleton by profile`,
`TERMINAL> none`,
`CODE> none`,
`INSTRUCTION:`,
`Use Python 3.10+, aiogram v3, python-dotenv.`,
`Implement minimal working bot according to this profile:`,
`----- DEV BRIEF -----`,
brief,
`---------------------`,
`Deliverables:`,
`- requirements.txt (aiogram==3.*, python-dotenv, loguru)`,
`- main.py with /start, /help; start polling`,
`- .env.example (TOKEN=your_token_here)`,
`No extra prose. Return only code blocks. Language in messages: ${p.lang||'uk'}.`
    ].join('\n');
  }

  function whereToPaste(){
    return [
'1) В Cursor натисни Cmd/Ctrl+I або іконку “Chat” у правій панелі.',
'2) Переконайся, що чат привʼязаний до поточної папки проекту.',
'3) Встав наш CURSOR PROMPT (англійською) у поле повідомлення та надішли.',
'4) Якщо Cursor почав відповідати “водою” — додай у кінець: “No prose. Return only code blocks.”',
'5) Погоджуй створення файлів (requirements.txt, main.py, .env.example).'
    ].join('\n');
  }

  async function copyText(txt){
    try{
      if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); return; }
    }catch(e){}
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); toast('Скопійовано.'); }catch(e){ alert('Скопіюй вручну.'); }
    finally{ document.body.removeChild(ta); }
  }
  function toast(msg){
    let t = root.querySelector('#gp-toast-m9');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m9'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m9);
    window.__gp_to_m9 = setTimeout(()=> t.style.display='none', 1600);
  }

  function markDoneAndGo(nextKey){
    const idx = state.current;
    if(!state.done.includes(idx)) state.done.push(idx);
    save(); root.dispatchEvent(new CustomEvent('gp:markDone'));
    const ni = flat.findIndex(x=>x.key===nextKey);
    if(ni>=0){ state.current=ni; save(); renderCopy(true); }
  }

  function renderCopy(force){
    load();
    const key = getKey();
    if(key!=='copy-cursor' && key!=='cursor-how') return;

    const main = root.querySelector('.main'); if(!main) return;
    const title = $('#gp-title'); const desc = $('#gp-desc');
    title && (title.textContent = 'Вставляємо у Cursor');
    desc && (desc.textContent = 'Скопіюй PROMPT і встав у чат Cursor, що привʼязаний до папки проекту.');

    // підготовка BRIEF+PROMPT
    const profile = state.profile;
    const brief = (state.assistedBrief||'').trim() ? state.assistedBrief.trim() : makeBrief(profile);
    const prompt = makeCursorPrompt(profile, brief);

    // прибирання динаміки
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    // верстка
    const wrap = document.createElement('div'); wrap.className='dyn cursor-wrap';
    wrap.innerHTML = `
      <div class="card">
        <b>CURSOR PROMPT (EN)</b>
        <textarea class="kbd" id="m9-prompt-box" readonly>${escapeHtml(prompt)}</textarea>
        <div class="row">
          <button class="btn primary" id="m9-copy-prompt">Скопіювати PROMPT</button>
          <button class="btn" id="m9-copy-both">Скопіювати BRIEF + PROMPT</button>
          <button class="btn" id="m9-open-chat">Відкрити чат у Cursor</button>
          <button class="btn" id="m9-where">Де саме вставити?</button>
        </div>
      </div>

      <div class="card">
        <b>Що має зʼявитися після відправки PROMPT</b>
        <div class="listy">
          <div class="li"><span class="i">1</span><div><code>requirements.txt</code> з <code>aiogram==3.*</code>, <code>python-dotenv</code>, <code>loguru</code></div></div>
          <div class="li"><span class="i">2</span><div><code>main.py</code> з /start і /help та стартом polling</div></div>
          <div class="li"><span class="i">3</span><div><code>.env.example</code> з <code>TOKEN=your_token_here</code></div></div>
        </div>
        <div class="row">
          <button class="btn" id="m9-done">Позначити як виконано → Запуск</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // дії
    $('#m9-copy-prompt')?.addEventListener('click', ()=> copyText(prompt));
    $('#m9-copy-both')?.addEventListener('click', ()=> copyText( ['----- DEV BRIEF -----', brief, '---------------------', '', prompt].join('\n') ));
    $('#m9-open-chat')?.addEventListener('click', ()=> window.open('https://www.cursor.com/','_blank','noopener'));
    $('#m9-where')?.addEventListener('click', ()=> alert(whereToPaste()));
    $('#m9-done')?.addEventListener('click', ()=> markDoneAndGo('run'));

    // прогрес у шапці
    const progressEl = $('#gp-progress');
    if(progressEl){
      const pct = Math.round((state.done.length/flat.length)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function init(){
    load();
    renderCopy(true);
    setInterval(()=> renderCopy(false), 400);
  }
  init();
})();
</script>
<!-- GP:END COPY-CURSOR SCRIPT -->
<!-- GP:M9 END -->
<!-- GP:M10 START • RUN (build 2025-10-29.11) -->
<!-- GP:BEGIN RUN STYLES -->
<style>
  #gp-panel .run-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .hint{font-size:12px;color:var(--muted)}
</style>
<!-- GP:END RUN STYLES -->

<!-- GP:BEGIN RUN SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 11;

  // flat як раніше
  const sections = [
    { title:'0 · Старт', items:[{t:'Почати', b:'welcome'},{t:'Як це працює', b:'guide'}]},
    { title:'1 · Анкета', items:[{t:'Заповнити 5 полів', b:'form'},{t:'Підтвердити анкету', b:'confirm'}]},
    { title:'2 · Режим', items:[{t:'AUTO', b:'auto'},{t:'ASSISTED', b:'assisted'}]},
    { title:'3 · Конструктор', items:[{t:'Тип / Модулі', b:'chips'},{t:'Дані / Інтеграції', b:'storage/integrations'},{t:'Бекенд (опц.) / Рівень', b:'backend/level'}]},
    { title:'4 · Огляд', items:[{t:'DEV BRIEF (EN)', b:'brief'},{t:'CURSOR PROMPT (EN)', b:'prompt'}]},
    { title:'5 · Середовище', items:[{t:'Local vs Codespaces', b:'env'}]},
    { title:'6 · Інструменти / Files', items:[{t:'Встановити/Відкрити', b:'tools'},{t:'Чек-лист файлів', b:'files'}]},
    { title:'7 · Вставити у Cursor', items:[{t:'Скопіювати промпт', b:'copy-cursor'},{t:'Де вставити?', b:'cursor-how'}]},
    { title:'8 · Запуск', items:[{t:'Команди запуску', b:'run'},{t:'Є проблема', b:'troubles'}]},
    { title:'9 · BotFather', items:[{t:'/setcommands', b:'bf-commands'}]},
    { title:'10 · Перевірка', items:[{t:'/start /help', b:'test'}]},
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  const flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION,
    mode: root.getAttribute('data-mode')||'auto',
    theme: root.getAttribute('data-theme')||'light',
    lang:'uk', ruLink:'', current:0, done:[], filter:'',
    env: root.getAttribute('data-env')||'local',
    profile:{ role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk', channel:'DM',
      type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
    },
    assistedBrief:''
  };

  function load(){ try{
    const raw=localStorage.getItem(STORE_KEY); if(!raw) return;
    const prev=JSON.parse(raw)||{}; state=Object.assign(state, prev); state.v=STATE_VERSION;
    if(!state.env) state.env='local';
  }catch(e){} }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){ return (flat[state.current]||flat[0]).key; }

  // команди для запуску
  function runLocal(){
    return [
      '# створити та активувати venv',
      'python -m venv .venv',
      (isWin()?'.\\.venv\\Scripts\\activate':'source .venv/bin/activate'),
      '',
      '# поставити залежності',
      'pip install -r requirements.txt',
      '',
      '# створити .env з токеном',
      'copy .env.example .env  # або вручну (Mac/Linux: cp .env.example .env)',
      '  # відкрий .env і встав TOKEN=123456:ABC...',
      '',
      '# запустити бота',
      'python main.py'
    ].join('\n');
  }
  function runCodes(){
    return [
      '# у терміналі Codespaces',
      'python --version',
      '',
      '# ставимо залежності',
      'pip install -r requirements.txt',
      '',
      '# створюємо .env',
      'cp .env.example .env',
      '  # відкрий .env і встав TOKEN=123456:ABC...',
      '',
      '# старт бота',
      'python main.py'
    ].join('\n');
  }
  function isWin(){ return navigator.platform && /Win/.test(navigator.platform); }

  async function copyText(txt){
    try{
      if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); return; }
    }catch(e){}
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); toast('Скопійовано.'); }catch(e){ alert('Скопіюй вручну.'); }
    finally{ document.body.removeChild(ta); }
  }
  function toast(msg){
    let t = root.querySelector('#gp-toast-m10');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m10'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m10);
    window.__gp_to_m10 = setTimeout(()=> t.style.display='none', 1600);
  }

  function markDoneAndGo(nextKey){
    const idx = state.current;
    if(!state.done.includes(idx)) state.done.push(idx);
    save(); root.dispatchEvent(new CustomEvent('gp:markDone'));
    const ni = flat.findIndex(x=>x.key===nextKey);
    if(ni>=0){ state.current=ni; save(); renderRun(true); }
  }

  function openTroubles(){
    // відкрити ваш уже існуючий модал траблшуту
    const m = document.getElementById('gp-troubles-modal');
    const back = document.getElementById('gp-backdrop');
    if(m && back){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); back.style.display='block'; }
    else { alert('Відкрий розділ "Траблшутінг" у шапці.'); }
  }

  function renderRun(force){
    load();
    const key = getKey();
    if(key!=='run' && key!=='troubles') return;

    const main = root.querySelector('.main'); if(!main) return;
    const title = $('#gp-title'); const desc = $('#gp-desc');
    title && (title.textContent = 'Запускаємо бота');
    desc && (desc.textContent = 'Скопіюй команди у свій термінал. Якщо щось не так — “Не працює” → Траблшут.');

    // прибрати динаміку
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    const cmds = (state.env==='codespaces') ? runCodes() : runLocal();

    const wrap = document.createElement('div'); wrap.className='dyn run-wrap';
    wrap.innerHTML = `
      <div class="card">
        <b>Команди для ${state.env==='codespaces'?'Codespaces':'Local'}</b>
        <div class="kbd" id="m10-cmds">${cmds}</div>
        <div class="row">
          <button class="btn primary" id="m10-copy">Скопіювати всі команди</button>
          <button class="btn" id="m10-troubles">Не працює — Траблшут</button>
        </div>
        <div class="hint">Після запуску напиши у Telegram команду <code>/start</code> — бот має відповісти.</div>
      </div>

      <div class="card">
        <b>Далі</b>
        <div class="hint">Коли бот стартує без помилок — переходимо додати команди у BotFather.</div>
        <div class="row">
          <button class="btn" id="m10-done">Позначити як виконано → BotFather</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // bind
    $('#m10-copy')?.addEventListener('click', ()=> copyText(cmds));
    $('#m10-troubles')?.addEventListener('click', openTroubles);
    $('#m10-done')?.addEventListener('click', ()=> markDoneAndGo('bf-commands'));

    // прогрес
    const progressEl = $('#gp-progress');
    if(progressEl){
      const pct = Math.round((state.done.length/flat.length)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
  }

  function init(){
    load();
    renderRun(true);
    setInterval(()=> renderRun(false), 400);
  }
  init();
})();
</script>
<!-- GP:END RUN SCRIPT -->
<!-- GP:M10 END -->
<!-- GP:M11 START • BOTFATHER & TEST (build 2025-10-29.12) -->
<!-- GP:BEGIN BF/TEST STYLES -->
<style>
  #gp-panel .bf-wrap, #gp-panel .test-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .listy{display:grid;grid-template-columns:1fr;gap:6px;margin-top:6px}
  #gp-panel .li{display:flex;gap:8px;align-items:flex-start}
  #gp-panel .li .i{width:18px;height:18px;border:1px solid var(--line);border-radius:4px;
    display:inline-flex;align-items:center;justify-content:center;font-size:12px}
  #gp-panel .hint{font-size:12px;color:var(--muted)}
</style>
<!-- GP:END BF/TEST STYLES -->

<!-- GP:BEGIN BF/TEST SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 12;

  const sections = [
    { title:'0 · Старт', items:[{t:'Почати', b:'welcome'},{t:'Як це працює', b:'guide'}]},
    { title:'1 · Анкета', items:[{t:'Заповнити 5 полів', b:'form'},{t:'Підтвердити анкету', b:'confirm'}]},
    { title:'2 · Режим', items:[{t:'AUTO', b:'auto'},{t:'ASSISTED', b:'assisted'}]},
    { title:'3 · Конструктор', items:[{t:'Тип / Модулі', b:'chips'},{t:'Дані / Інтеграції', b:'storage/integrations'},{t:'Бекенд (опц.) / Рівень', b:'backend/level'}]},
    { title:'4 · Огляд', items:[{t:'DEV BRIEF (EN)', b:'brief'},{t:'CURSOR PROMPT (EN)', b:'prompt'}]},
    { title:'5 · Середовище', items:[{t:'Local vs Codespaces', b:'env'}]},
    { title:'6 · Інструменти / Files', items:[{t:'Встановити/Відкрити', b:'tools'},{t:'Чек-лист файлів', b:'files'}]},
    { title:'7 · Вставити у Cursor', items:[{t:'Скопіювати промпт', b:'copy-cursor'},{t:'Де вставити?', b:'cursor-how'}]},
    { title:'8 · Запуск', items:[{t:'Команди запуску', b:'run'},{t:'Є проблема', b:'troubles'}]},
    { title:'9 · BotFather', items:[{t:'/setcommands', b:'bf-commands'}]},
    { title:'10 · Перевірка', items:[{t:'/start /help', b:'test'}]},
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  const flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION,
    mode: root.getAttribute('data-mode')||'auto',
    theme: root.getAttribute('data-theme')||'light',
    lang:'uk', ruLink:'', current:0, done:[], filter:'',
    env: root.getAttribute('data-env')||'local',
    profile:{ role:'', goal:'', cmds:'/start, /help, /add, /list, /done, /skip, /stats, /tips', lang:'uk', channel:'DM',
      type:'', modules:[], data:'json', integrations:[], backend:'none', level:'L1'
    },
    assistedBrief:''
  };

  function load(){ try{
    const raw=localStorage.getItem(STORE_KEY); if(!raw) return;
    const prev=JSON.parse(raw)||{}; state=Object.assign(state, prev); state.v=STATE_VERSION;
    if(!state.env) state.env='local';
    if(!state.profile) state.profile={};
    if(!state.profile.cmds) state.profile.cmds='/start, /help';
  }catch(e){} }
  function save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){ return (flat[state.current]||flat[0]).key; }

  // ---- генерація /setcommands
  function parseCmds(raw){
    return (raw||'')
      .split(/[,\n]/).map(s=>s.trim()).filter(Boolean)
      .map(s=> s.startsWith('/')? s : '/'+s);
  }
  function defaultDesc(cmd){
    const map = {
      '/start':'Запуск та привітання',
      '/help':'Підказки по командам',
      '/add':'Додати запис/таск',
      '/list':'Показати список',
      '/done':'Позначити як виконано',
      '/skip':'Пропустити/відкласти',
      '/stats':'Статистика за 7/30 днів',
      '/tips':'Поради',
      '/panic':'Швидка допомога'
    };
    return map[cmd] || 'Команда';
  }
  function makeSetCommands(cmdsStr){
    const cmds = parseCmds(cmdsStr);
    const lines = cmds.map(c => `${c} - ${defaultDesc(c)}`);
    return lines.join('\n');
  }
  function whereSetCommands(){
    return [
'1) Відкрий @BotFather',
'2) Натисни /setcommands → обери свого бота',
'3) Встав згенерований список команд і надішли',
'4) Перезапусти клієнт Telegram (або зачекай 1–2 хв), щоб зʼявилися підказки'
    ].join('\n');
  }

  // копіювання/тост
  async function copyText(txt){
    try{
      if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); return; }
    }catch(e){}
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); toast('Скопійовано.'); }catch(e){ alert('Скопіюй вручну.'); }
    finally{ document.body.removeChild(ta); }
  }
  function toast(msg){
    let t = root.querySelector('#gp-toast-m11');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m11'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m11);
    window.__gp_to_m11 = setTimeout(()=> t.style.display='none', 1600);
  }

  function markDoneAndGo(nextKey){
    const idx = state.current;
    if(!state.done.includes(idx)) state.done.push(idx);
    save(); root.dispatchEvent(new CustomEvent('gp:markDone'));
    const ni = flat.findIndex(x=>x.key===nextKey);
    if(ni>=0){ state.current=ni; save(); renderBF(true); renderTest(true); }
  }

  // ---- RENDER: BotFather
  function renderBF(force){
    load();
    if(getKey()!=='bf-commands') return;

    const main = root.querySelector('.main'); if(!main) return;
    const title = $('#gp-title'); const desc = $('#gp-desc');
    title && (title.textContent = 'BotFather: додаємо команди');
    desc && (desc.textContent = 'Згенеруй /setcommands і встав у @BotFather. Після — переходимо до тесту.');

    // прибрати динаміку
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    const setCmds = makeSetCommands(state.profile.cmds||'/start, /help');

    const wrap = document.createElement('div'); wrap.className='dyn bf-wrap';
    wrap.innerHTML = `
      <div class="card">
        <b>/setcommands (${(state.profile.lang||'uk').toUpperCase()})</b>
        <div class="kbd" id="m11-commands">${setCmds}</div>
        <div class="row">
          <button class="btn primary" id="m11-copy">Скопіювати /setcommands</button>
          <button class="btn" id="m11-open-bf">Відкрити BotFather</button>
          <button class="btn" id="m11-how">Де це вставити?</button>
        </div>
        <div class="hint">Порада: короткі описи працюють краще (до ~40 символів).</div>
      </div>

      <div class="card">
        <b>Далі</b>
        <div class="hint">Коли вставиш команди в BotFather — переходимо до перевірки в Telegram.</div>
        <div class="row">
          <button class="btn" id="m11-done">Позначити як виконано → Перевірка</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // дії
    $('#m11-copy')?.addEventListener('click', ()=> copyText(setCmds));
    $('#m11-open-bf')?.addEventListener('click', ()=> window.open('https://t.me/BotFather','_blank','noopener'));
    $('#m11-how')?.addEventListener('click', ()=> alert(whereSetCommands()));
    $('#m11-done')?.addEventListener('click', ()=> markDoneAndGo('test'));

    // прогрес
    const progressEl = $('#gp-progress');
    if(progressEl){
      const pct = Math.round((state.done.length/flat.length)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
  }

  // ---- RENDER: Test
  function testChecklist(){
    return [
      'Надіслати /start → отримати привітання (без помилок у консолі)',
      'Надіслати /help → список доступних команд',
      'Команди /add і /list (якщо додані) відповідають без падінь',
      'Бот онлайн ≥ 2 хв (без Traceback у терміналі)'
    ].map((t,i)=>`<div class="li"><span class="i">${i+1}</span><div>${t}</div></div>`).join('');
  }
  function renderTest(force){
    load();
    if(getKey()!=='test') return;

    const main = root.querySelector('.main'); if(!main) return;
    const title = $('#gp-title'); const desc = $('#gp-desc');
    title && (title.textContent = 'Перевірка бота');
    desc && (desc.textContent = 'Переконайся, що /start і /help працюють, а бот не падає.');

    // почистити динаміку
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    const wrap = document.createElement('div'); wrap.className='dyn test-wrap';
    wrap.innerHTML = `
      <div class="card">
        <b>Що перевіряємо</b>
        <div class="listy">${testChecklist()}</div>
        <div class="row">
          <button class="btn" id="m11-open-telegram">Відкрити Telegram Web</button>
          <button class="btn" id="m11-troubles">Не працює — Траблшут</button>
        </div>
        <div class="hint">Якщо є помилка — скопіюй останні 50 рядків із терміналу та встав у “Навігатор”.</div>
      </div>

      <div class="card">
        <b>Фініш</b>
        <div class="hint">Все працює? Полетіли в апґрейди: UI-кнопки, Статистика, Оплати.</div>
        <div class="row">
          <button class="btn primary" id="m11-finish">Фініш → Готово / Апґрейди</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // дії
    $('#m11-open-telegram')?.addEventListener('click', ()=> window.open('https://web.telegram.org/','_blank','noopener'));
    $('#m11-troubles')?.addEventListener('click', ()=>{
      const m = document.getElementById('gp-troubles-modal');
      const back = document.getElementById('gp-backdrop');
      if(m && back){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); back.style.display='block'; }
      else { alert('Відкрий “Траблшутінг” у шапці.'); }
    });
    $('#m11-finish')?.addEventListener('click', ()=>{
      const iTest = flat.findIndex(x=>x.key==='test');
      if(iTest>=0 && !state.done.includes(iTest)) state.done.push(iTest);
      save(); root.dispatchEvent(new CustomEvent('gp:markDone'));
      const up = flat.findIndex(x=>x.key==='upgrade-ui');
      if(up>=0){ state.current=up; save(); renderBF(true); renderTest(true); }
    });

    // прогрес
    const progressEl = $('#gp-progress');
    if(progressEl){
      const pct = Math.round((state.done.length/flat.length)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(state.lang||'uk').toUpperCase()}`;
    }
  }

  function init(){
    load();
    renderBF(true);
    renderTest(true);
    // пасивний ресвізит при навігації сайдбаром
    setInterval(()=>{ renderBF(false); renderTest(false); }, 400);
  }
  init();
})();
</script>
<!-- GP:END BF/TEST SCRIPT -->
<!-- GP:M11 END -->
<!-- GP:M12 START • UPGRADE: UI BUTTONS (build 2025-10-29.u1) -->
<!-- GP:BEGIN UPGRADE UI STYLES -->
<style>
  #gp-panel .upui-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel .hint{font-size:12px;color:var(--muted)}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .chipset{display:flex;gap:6px;flex-wrap:wrap}
  #gp-panel .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;cursor:pointer}
  #gp-panel .chip[aria-pressed="true"]{background:var(--active-bg);border-color:var(--active-border)}
  #gp-panel .preview{display:inline-grid;grid-auto-flow:row;gap:6px;margin-top:8px}
  #gp-panel .badge{display:inline-flex;gap:6px;align-items:center;border:1px dashed var(--line);border-radius:8px;padding:4px 8px}
</style>
<!-- GP:END UPGRADE UI STYLES -->

<!-- GP:BEGIN UPGRADE UI SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 1201;

  const sections = [
    { title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}
  ];
  const flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION,
    lang:'uk',
    profile:{ role:'', goal:'', cmds:'/start, /help, /add, /list, /done', lang:'uk' },
    ui:{ kind:'reply', layout:'simple', emojis:true, confirmOnDone:true }
  };

  function load(){ try{
    const raw = localStorage.getItem(STORE_KEY); if(!raw) return;
    const prev = JSON.parse(raw)||{};
    // зберігаємо чужі поля (env, done, current тощо)
    state = Object.assign({}, prev, { v: STATE_VERSION, ui: (prev.ui||state.ui), profile: Object.assign({}, state.profile, (prev.profile||{})) });
  }catch(e){} }
  function save(){ try{
    const prev = JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
    const merged = Object.assign({}, prev, { v: STATE_VERSION, ui: state.ui, profile: state.profile });
    localStorage.setItem(STORE_KEY, JSON.stringify(merged));
  }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){
    const all = (root.__flatAll || []).filter(Boolean);
    const idx = (JSON.parse(localStorage.getItem(STORE_KEY)||'{}').current) ?? 0;
    return (all[idx]&&all[idx].key) || '';
  }

  // ---- Пресети макетів
  const PRESETS = {
    reply: {
      simple: ['✅ Done','➖ Skip','📊 Stats'],
      compact: ['✅','➖','📊'],
      extended: ['✅ Done','➖ Skip','📊 Stats','❓ Help']
    },
    inline:{
      simple: ['➕ Add','🧾 List','✅ Done','📊 Stats'],
      compact: ['➕','🧾','✅','📊'],
      confirm: ['✅ Done','↩️ Undo','ℹ️ Help']
    }
  };

  // ---- Генерація PROMPT для Cursor
  function makePrompt(ui){
    const kb = (ui.kind==='reply') ? 'Reply Keyboard' : 'Inline Keyboard';
    const buttons = PRESETS[ui.kind][ui.layout] || [];
    const btnList = buttons.map(b=>`- ${b}`).join('\n');
    const lang = (state.profile.lang||'uk');

    return [
`[CHAT 2 | PROGRAMMER] CURRENT STEP: Add ${kb} to existing aiogram v3 bot`,
`TERMINAL> none`,
`CODE> none`,
`INSTRUCTION:`,
`1) Keep current features. Add ${kb} with these labels:`,
btnList,
`2) For /done require optional confirmation = ${ui.confirmOnDone?'true':'false'}.`,
`3) Messages must remain in ${lang}.`,
`4) Return only code blocks (no prose).`
    ].join('\n');
  }

  function updatePreview(){
    const p = $('#m12-preview'); if(!p) return;
    const s = state.ui;
    const arr = PRESETS[s.kind][s.layout] || [];
    p.innerHTML = arr.map(x=>`<span class="badge">${x}</span>`).join(' ');
  }

  function renderUI(force){
    load();
    // показуємо лише на кроці 'upgrade-ui'
    const all = (root.__flatAll || []);
    const current = JSON.parse(localStorage.getItem(STORE_KEY)||'{}').current ?? 0;
    if(!(all[current] && all[current].key==='upgrade-ui')) return;

    const main = root.querySelector('.main'); if(!main) return;
    const title = $('#gp-title'), desc = $('#gp-desc');
    title && (title.textContent = 'Апґрейд: UI-кнопки');
    desc && (desc.textContent = 'Обери тип і макет клавіатури. Згенеруємо готовий PROMPT для Cursor.');

    // прибрати динаміку
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    const wrap = document.createElement('div'); wrap.className='dyn upui-wrap';
    wrap.innerHTML = `
      <div class="card">
        <b>1) Тип клавіатури</b>
        <div class="chipset" role="group">
          <button class="chip" id="ui-kind-reply" aria-pressed="${state.ui.kind==='reply'}">Reply</button>
          <button class="chip" id="ui-kind-inline" aria-pressed="${state.ui.kind==='inline'}">Inline</button>
        </div>
        <div class="hint" style="margin-top:6px">
          Reply — великі кнопки під полем вводу. Inline — маленькі під повідомленням.
        </div>
      </div>

      <div class="card">
        <b>2) Макет</b>
        <div class="chipset" role="group" id="m12-layouts"></div>
        <div class="preview" id="m12-preview"></div>
      </div>

      <div class="card">
        <b>3) Параметри</b>
        <label><input type="checkbox" id="ui-emojis" ${state.ui.emojis?'checked':''}> Додавати емодзі</label><br>
        <label><input type="checkbox" id="ui-confirm" ${state.ui.confirmOnDone?'checked':''}> Підтвердження при “Done”</label>
        <div class="hint">Підтвердження знижує випадкові натискання.</div>
      </div>

      <div class="card">
        <b>4) PROMPT для Cursor</b>
        <div class="kbd" id="m12-prompt">${makePrompt(state.ui)}</div>
        <div class="row">
          <button class="btn primary" id="m12-copy">Скопіювати PROMPT</button>
          <button class="btn" id="m12-where">Де вставити?</button>
        </div>
      </div>

      <div class="card">
        <b>Далі</b>
        <div class="hint">Готово? Додаємо статистику (/stats) — прості прогрес-бари 7/30.</div>
        <div class="row">
          <button class="btn" id="m12-done">Позначити як виконано → Статистика</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // побудувати макети
    function renderLayouts(){
      const box = $('#m12-layouts'); if(!box) return;
      const keys = Object.keys(PRESETS[state.ui.kind]);
      box.innerHTML = keys.map(k=>`<button class="chip" data-layout="${k}" aria-pressed="${state.ui.layout===k}">${k}</button>`).join('');
      box.querySelectorAll('.chip').forEach(ch=>{
        ch.addEventListener('click',()=>{
          state.ui.layout = ch.getAttribute('data-layout');
          save(); renderLayouts(); updatePreview();
          $('#m12-prompt').textContent = makePrompt(state.ui);
        });
      });
    }

    // bind тип
    $('#ui-kind-reply')?.addEventListener('click',()=>{
      state.ui.kind='reply'; state.ui.layout = state.ui.layout in PRESETS.reply ? state.ui.layout : 'simple';
      save(); renderUI(true);
    });
    $('#ui-kind-inline')?.addEventListener('click',()=>{
      state.ui.kind='inline'; state.ui.layout = state.ui.layout in PRESETS.inline ? state.ui.layout : 'simple';
      save(); renderUI(true);
    });

    // bind параметри
    $('#ui-emojis')?.addEventListener('change',e=>{
      state.ui.emojis = !!e.target.checked; save(); $('#m12-prompt').textContent = makePrompt(state.ui);
    });
    $('#ui-confirm')?.addEventListener('change',e=>{
      state.ui.confirmOnDone = !!e.target.checked; save(); $('#m12-prompt').textContent = makePrompt(state.ui);
    });

    // кнопки
    $('#m12-copy')?.addEventListener('click', async()=>{
      await (async()=>{
        try{
          await navigator.clipboard.writeText($('#m12-prompt').textContent); toast('Скопійовано.');
        }catch(e){
          const ta=document.createElement('textarea'); ta.value=$('#m12-prompt').textContent; document.body.appendChild(ta); ta.select();
          try{ document.execCommand('copy'); toast('Скопійовано.'); }finally{ document.body.removeChild(ta); }
        }
      })();
    });
    $('#m12-where')?.addEventListener('click', ()=>{
      alert('Відкрий чат у Cursor (Cmd/Ctrl+I) → встав PROMPT → надішли. Погоджуй зміни у файлах.');
    });
    $('#m12-done')?.addEventListener('click', ()=>{
      const store=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
      if(!Array.isArray(store.done)) store.done=[];
      const all = root.__flatAll||[];
      const idx = store.current ?? 0;
      if(!store.done.includes(idx)) store.done.push(idx);
      // перейти на upgrade-stats
      const to = all.findIndex(x=>x.key==='upgrade-stats');
      if(to>=0) store.current = to;
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
      toast('Позначено. Переходимо до статистики.');
    });

    // ініціалізація
    renderLayouts();
    updatePreview();
  }

  function toast(msg){
    let t = root.querySelector('#gp-toast-m12');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m12'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m12);
    window.__gp_to_m12 = setTimeout(()=> t.style.display='none', 1600);
  }

  function init(){
    // підхоплюємо глобальний flat з базового модуля
    if(!root.__flatAll){
      // зберемо короткий flat зі всіх секцій, якщо базовий не записав
      const base = JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
      root.__flatAll = (base.flat||[]); // якщо є
    }
    renderUI(true);
    setInterval(()=> renderUI(false), 400);
  }
  init();
})();
</script>
<!-- GP:END UPGRADE UI SCRIPT -->
<!-- GP:M12 END -->
<!-- GP:M13 START • UPGRADE: STATS (build 2025-10-29.u2) -->
<!-- GP:BEGIN UPGRADE STATS STYLES -->
<style>
  #gp-panel .upstats-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel .hint{font-size:12px;color:var(--muted)}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .chipset{display:flex;gap:6px;flex-wrap:wrap}
  #gp-panel .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;cursor:pointer}
  #gp-panel .chip[aria-pressed="true"]{background:var(--active-bg);border-color:var(--active-border)}
  #gp-panel .inputline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #gp-panel .inputline input{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text)}
  #gp-panel .demo{font:12px/1.6 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre}
</style>
<!-- GP:END UPGRADE STATS STYLES -->

<!-- GP:BEGIN UPGRADE STATS SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 1302;

  const sections=[{ title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}];
  const flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION,
    lang:'uk',
    profile:{ lang:'uk' },
    stats:{ mode:'count', period:7, metric:'Виконань', asciiWidth:20 }
  };

  function load(){ try{
    const raw=localStorage.getItem(STORE_KEY); if(!raw) return;
    const prev=JSON.parse(raw)||{};
    state = Object.assign(state, prev.stats? { stats: Object.assign(state.stats, prev.stats) } : {}, { v: STATE_VERSION });
    // підхоплюємо мову профілю якщо є
    if(prev.profile && prev.profile.lang) state.profile={ lang: prev.profile.lang };
  }catch(e){} }
  function save(){ try{
    const prev=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
    const merged=Object.assign({}, prev, { stats: state.stats });
    localStorage.setItem(STORE_KEY, JSON.stringify(merged));
  }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){
    const all = (root.__flatAll || []);
    const idx = (JSON.parse(localStorage.getItem(STORE_KEY)||'{}').current) ?? 0;
    return (all[idx]&&all[idx].key) || '';
  }

  // простий ASCII-бар
  function makeBar(pct,width){
    const w = Math.max(10, Math.min(60, width||20));
    const fill = Math.round(w * Math.max(0, Math.min(100, pct))/100);
    return '[' + '#'.repeat(fill) + '-'.repeat(w-fill) + `] ${pct}%`;
    }

  // демо прев’ю (рандомні дані для вигляду)
  function demoPreview(period, mode){
    const days = period===30?30:7;
    const arr = Array.from({length:days},()=> Math.floor(Math.random()*100));
    const nowPct = Math.floor((arr.reduce((a,b)=>a+b,0) / (days*100)) * 100);
    const streak = Math.floor(Math.random()*10)+1;
    const head = (mode==='count')
      ? `Метрика: кількість виконань за ${days} днів`
      : `Метрика: серія (streak) за ${days} днів`;
    const line = makeBar(nowPct, state.stats.asciiWidth);
    return head + '\n' + line + (mode==='streak'?`\nCurrent streak: ${streak}`:'');
  }

  // PROMPT для Cursor
  function makePrompt(stats){
    const lang = (state.profile.lang||'uk');
    const period = stats.period===30?30:7;
    const mode = stats.mode==='streak'?'streak':'count';
    return [
`[CHAT 2 | PROGRAMMER] CURRENT STEP: Add /stats to existing aiogram v3 bot`,
`TERMINAL> none`,
`CODE> none`,
`INSTRUCTION:`,
`1) Add command /stats that returns text-based progress for the last ${period} days.`,
`2) Metric mode: ${mode} (${mode==='count'?'sum of completed actions per day':'longest/current streak of consecutive days with success'}).`,
`3) Render ASCII progress bar with width ${stats.asciiWidth} chars.`,
`4) Keep messages in ${lang}.`,
`5) Keep existing features and commands; no breaking changes.`,
`6) Return only code blocks (no prose).`
    ].join('\n');
  }

  function renderStats(force){
    load();
    // показуємо лише на кроці 'upgrade-stats'
    const all = (root.__flatAll || []);
    const current = JSON.parse(localStorage.getItem(STORE_KEY)||'{}').current ?? 0;
    if(!(all[current] && all[current].key==='upgrade-stats')) return;

    const main = root.querySelector('.main'); if(!main) return;
    const title = $('#gp-title'), desc = $('#gp-desc');
    title && (title.textContent = 'Апґрейд: Статистика (/stats)');
    desc && (desc.textContent = 'Обери метрику і період. Згенеруємо PROMPT — Cursor додасть текстові прогрес-бари 7/30.');

    // прибрати динаміку
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    const wrap = document.createElement('div'); wrap.className='dyn upstats-wrap';
    wrap.innerHTML = `
      <div class="card">
        <b>1) Метрика</b>
        <div class="chipset" role="group">
          <button class="chip" id="st-mode-count" aria-pressed="${state.stats.mode==='count'}">Кількість виконань</button>
          <button class="chip" id="st-mode-streak" aria-pressed="${state.stats.mode==='streak'}">Серія (streak)</button>
        </div>
        <div class="hint">“Кількість” — скільки разів виконано. “Серія” — скільки днів підряд без пропусків.</div>
      </div>

      <div class="card">
        <b>2) Період</b>
        <div class="chipset" role="group">
          <button class="chip" id="st-per-7" aria-pressed="${state.stats.period===7}">7 днів</button>
          <button class="chip" id="st-per-30" aria-pressed="${state.stats.period===30}">30 днів</button>
        </div>
      </div>

      <div class="card">
        <b>3) Параметри</b>
        <div class="inputline">
          <label>Назва метрики:</label>
          <input type="text" id="st-metric" placeholder="Виконань" value="${state.stats.metric||'Виконань'}">
          <label>Ширина ASCII:</label>
          <input type="number" id="st-width" min="10" max="60" step="1" value="${state.stats.asciiWidth}">
        </div>
        <div class="hint">Ширина — довжина прогрес-бару у символах (# і -).</div>
      </div>

      <div class="card">
        <b>4) Превʼю</b>
        <div class="kbd demo" id="st-preview">${demoPreview(state.stats.period, state.stats.mode)}</div>
      </div>

      <div class="card">
        <b>5) PROMPT для Cursor</b>
        <div class="kbd" id="st-prompt">${makePrompt(state.stats)}</div>
        <div class="row">
          <button class="btn primary" id="st-copy">Скопіювати PROMPT</button>
          <button class="btn" id="st-where">Де вставити?</button>
        </div>
      </div>

      <div class="card">
        <b>Далі</b>
        <div class="hint">Готово? Переходимо до оплат (Telegram Stars/Stripe/Fondy) — за бажанням.</div>
        <div class="row">
          <button class="btn" id="st-done">Позначити як виконано → Оплати</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // binds
    $('#st-mode-count')?.addEventListener('click', ()=>{ state.stats.mode='count'; save(); renderStats(true); });
    $('#st-mode-streak')?.addEventListener('click', ()=>{ state.stats.mode='streak'; save(); renderStats(true); });
    $('#st-per-7')?.addEventListener('click', ()=>{ state.stats.period=7; save(); renderStats(true); });
    $('#st-per-30')?.addEventListener('click', ()=>{ state.stats.period=30; save(); renderStats(true); });

    $('#st-metric')?.addEventListener('input', e=>{
      state.stats.metric = e.target.value || 'Виконань'; save();
    });
    $('#st-width')?.addEventListener('input', e=>{
      let v = parseInt(e.target.value||20,10); v = isNaN(v)?20:Math.max(10,Math.min(60,v));
      state.stats.asciiWidth = v; save();
      $('#st-preview').textContent = demoPreview(state.stats.period, state.stats.mode);
      $('#st-prompt').textContent = makePrompt(state.stats);
    });

    $('#st-copy')?.addEventListener('click', async()=>{
      const txt = $('#st-prompt').textContent;
      try{ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); }
      catch(e){ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); toast('Скопійовано.'); }
    });

    $('#st-where')?.addEventListener('click', ()=> alert('Відкрий чат у Cursor (Cmd/Ctrl+I) → встав PROMPT → надішли. Погодь зміни у файлах.'));

    $('#st-done')?.addEventListener('click', ()=>{
      const store=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
      if(!Array.isArray(store.done)) store.done=[];
      const all = root.__flatAll||[];
      const idx = store.current ?? 0;
      if(!store.done.includes(idx)) store.done.push(idx);
      const to = all.findIndex(x=>x.key==='upgrade-pay');
      if(to>=0) store.current = to;
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
      toast('Позначено. Переходимо до оплат.');
    });

    // оновлюємо превʼю/промпт при першому рендері
    $('#st-preview').textContent = demoPreview(state.stats.period, state.stats.mode);
    $('#st-prompt').textContent = makePrompt(state.stats);
  }

  function toast(msg){
    let t = root.querySelector('#gp-toast-m13');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m13'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m13);
    window.__gp_to_m13 = setTimeout(()=> t.style.display='none', 1600);
  }

  function init(){
    if(!root.__flatAll){
      const base = JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
      root.__flatAll = (base.flat||[]);
    }
    renderStats(true);
    setInterval(()=> renderStats(false), 400);
  }
  init();
})();
</script>
<!-- GP:END UPGRADE STATS SCRIPT -->
<!-- GP:M13 END -->
<!-- GP:M14 START • UPGRADE: PAYMENTS (build 2025-10-29.u3) -->
<!-- GP:BEGIN UPGRADE PAY STYLES -->
<style>
  #gp-panel .uppay-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  #gp-panel .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  #gp-panel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #gp-panel .hint{font-size:12px;color:var(--muted)}
  #gp-panel .kbd{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;
    font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;background:transparent;color:var(--text)}
  #gp-panel .chipset{display:flex;gap:6px;flex-wrap:wrap}
  #gp-panel .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;cursor:pointer}
  #gp-panel .chip[aria-pressed="true"]{background:var(--active-bg);border-color:var(--active-border)}
  #gp-panel .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:980px){#gp-panel .grid2{grid-template-columns:1fr}}
  #gp-panel .input{display:flex;flex-direction:column;gap:6px}
  #gp-panel .input input{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text)}
  #gp-panel .badge{display:inline-flex;gap:6px;align-items:center;border:1px dashed var(--line);border-radius:8px;padding:4px 8px}
</style>
<!-- GP:END UPGRADE PAY STYLES -->

<!-- GP:BEGIN UPGRADE PAY SCRIPT -->
<script>
(function(){
  const root = document.getElementById('gp-panel'); if(!root) return;
  const STORE_KEY = 'gpPanel_state_m0';
  const STATE_VERSION = 1403;

  const sections=[{ title:'11 · Готово / Апґрейди', items:[{t:'UI-кнопки', b:'upgrade-ui'},{t:'Статистика', b:'upgrade-stats'},{t:'Оплати', b:'upgrade-pay'}]}];
  const flat=[]; sections.forEach((s,si)=>s.items.forEach((it,idx)=>flat.push({si,idx,key:it.b,title:it.t,sec:s.title})));

  let state = {
    v: STATE_VERSION,
    profile:{ lang:'uk' },
    pay:{
      provider:'stars',   // 'stars' | 'stripe'
      currency:'USD',
      price:'5.00',
      planName:'Pro Upgrade',
      // Stars
      tg_app_name:'',     // назва міні-апки/бота, якщо треба
      // Stripe/Fondy
      stripe_pk:'', stripe_sk:'', success_url:'https://example.com/success', cancel_url:'https://example.com/cancel',
      fondy_merchant_id:'', fondy_secret:''
    }
  };

  function load(){ try{
    const raw=localStorage.getItem(STORE_KEY); if(!raw) return;
    const prev=JSON.parse(raw)||{};
    state = Object.assign(state, { v: STATE_VERSION }, prev.pay? { pay:Object.assign(state.pay, prev.pay) } : {});
  }catch(e){} }
  function save(){ try{
    const prev=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
    const merged=Object.assign({}, prev, { pay: state.pay });
    localStorage.setItem(STORE_KEY, JSON.stringify(merged));
  }catch(e){} }

  const $ = s => root.querySelector(s);
  function getKey(){
    const all=(root.__flatAll||[]);
    const idx=(JSON.parse(localStorage.getItem(STORE_KEY)||'{}').current) ?? 0;
    return (all[idx]&&all[idx].key) || '';
  }

  // ---- Чек-лист вебхука
  function webhookChecklist(){
    const usingStars = state.pay.provider==='stars';
    return [
      usingStars ? '• У Bot Settings включи Payments/Stars у BotFather (якщо застосовно).' : '• Створи Stripe/Fondy мерчант і отримай ключі.',
      '• Створи endpoint у коді (/payment_webhook).',
      '• Вкажи URL вебхука у провайдері (ngrok/ваш домен).',
      '• Перевір підпис (секрет) і обробляй статуси: created → paid → failed/refund.',
      '• Занось покупку в локальну БД/JSON (user_id, товар, сума, час).'
    ].join('\n');
  }

  // ---- PROMPT для Cursor
  function makePrompt(pay){
    const lang = (state.profile.lang||'uk');
    if(pay.provider==='stars'){
      return [
`[CHAT 2 | PROGRAMMER] CURRENT STEP: Add Telegram Stars payments`,
`TERMINAL> none`,
`CODE> none`,
`INSTRUCTION:`,
`1) Add module payments.py for Telegram Stars (aiogram v3).`,
`2) Add /buy command and "Upgrade" button; create invoice (amount=${pay.price} ${pay.currency}, title="${pay.planName}").`,
`3) Implement webhook/updates handler to mark user as premium on successful payment.`,
`4) ENV: TG_BOT_TOKEN (already), OPTIONAL: APP_NAME=${pay.tg_app_name||'my_app'}, PRICE=${pay.price}, CURRENCY=${pay.currency}.`,
`5) Persist purchases in a local JSON (data/purchases.json).`,
`6) Messages must remain in ${lang}.`,
`7) Return only code blocks (no prose).`
      ].join('\n');
    }
    // stripe/fondy
    return [
`[CHAT 2 | PROGRAMMER] CURRENT STEP: Add card payments (${pay.provider==='stripe'?'Stripe':'Fondy'})`,
`TERMINAL> none`,
`CODE> none`,
`INSTRUCTION:`,
`1) Add payments.py with endpoints: /create_checkout and /payment_webhook.`,
`2) /buy command returns payment URL (Checkout) for plan "${pay.planName}" at ${pay.price} ${pay.currency}.`,
`3) ENV for Stripe: STRIPE_PK=${pay.stripe_pk||'pk_live_...'}, STRIPE_SK=${pay.stripe_sk||'sk_live_...'}, SUCCESS_URL=${pay.success_url}, CANCEL_URL=${pay.cancel_url}.`,
`   ENV for Fondy: FONDY_MERCHANT_ID=${pay.fondy_merchant_id||'xxxx'}, FONDY_SECRET=${pay.fondy_secret||'xxxx'}.`,
`4) On webhook "paid" → mark user premium; save purchase to data/purchases.json (user_id, plan, amount, ts).`,
`5) Messages in ${lang}; keep existing bot features; no breaking changes.`,
`6) Return only code blocks (no prose).`
    ].join('\n');
  }

  function providerDocUrl(){
    return state.pay.provider==='stars'
      ? 'https://core.telegram.org/bots/payments'
      : (state.pay.provider==='stripe' ? 'https://stripe.com/docs/payments/checkout' : 'https://fondy.io/en/docs/');
  }

  function renderPay(force){
    load();
    const all=(root.__flatAll||[]);
    const current=(JSON.parse(localStorage.getItem(STORE_KEY)||'{}').current) ?? 0;
    if(!(all[current] && all[current].key==='upgrade-pay')) return;

    const main=root.querySelector('.main'); if(!main) return;
    const title=$('#gp-title'), desc=$('#gp-desc');
    title && (title.textContent='Апґрейд: Оплати (опційно)');
    desc && (desc.textContent='Обери провайдера, заповни ключі, згенеруй PROMPT — Cursor додасть модуль оплат.');

    // прибрати динаміку
    main.querySelectorAll('.dyn').forEach(n=>n.remove());

    const wrap=document.createElement('div'); wrap.className='dyn uppay-wrap';
    wrap.innerHTML = `
      <div class="card">
        <b>1) Провайдер</b>
        <div class="chipset" role="group">
          <button class="chip" id="pay-stars" aria-pressed="${state.pay.provider==='stars'}">Telegram Stars</button>
          <button class="chip" id="pay-stripe" aria-pressed="${state.pay.provider==='stripe'}">Stripe/Fondy</button>
        </div>
        <div class="hint">Stars — нативні платежі Telegram. Stripe/Fondy — класичні картки/Apple Pay/Google Pay (через Checkout).</div>
      </div>

      <div class="card">
        <b>2) Налаштування</b>
        <div class="grid2">
          <div class="input">
            <label>Назва плану</label>
            <input id="pay-plan" type="text" value="${state.pay.planName}">
          </div>
          <div class="input">
            <label>Ціна</label>
            <input id="pay-price" type="text" value="${state.pay.price}">
          </div>
          <div class="input">
            <label>Валюта</label>
            <input id="pay-cur" type="text" value="${state.pay.currency}">
          </div>
          <div class="input">
            <label>${state.pay.provider==='stars'?'Telegram App Name (опц.)':'Success URL'}</label>
            <input id="pay-extra1" type="text" value="${state.pay.provider==='stars'? (state.pay.tg_app_name||'') : state.pay.success_url}">
          </div>
          <div class="input">
            <label>${state.pay.provider==='stars'?'(Stars — інше поле не потрібне)':'Cancel URL'}</label>
            <input id="pay-extra2" type="text" ${state.pay.provider==='stars'?'disabled':''} value="${state.pay.cancel_url}">
          </div>
          <div class="input">
            <label>${state.pay.provider==='stripe'?'Stripe PK':'Fondy merchant id'}</label>
            <input id="pay-k1" type="text" value="${state.pay.provider==='stripe'?state.pay.stripe_pk:state.pay.fondy_merchant_id}">
          </div>
          <div class="input">
            <label>${state.pay.provider==='stripe'?'Stripe SK':'Fondy secret'}</label>
            <input id="pay-k2" type="text" value="${state.pay.provider==='stripe'?state.pay.stripe_sk:state.pay.fondy_secret}">
          </div>
        </div>
        <div class="hint">Залиш як є, якщо тільки демо. Справжні ключі підставиш у .env пізніше.</div>
      </div>

      <div class="card">
        <b>3) Вебхук — що зробити</b>
        <div class="kbd">${webhookChecklist()}</div>
        <div class="row">
          <span class="badge">Підказка: для локалу використай ngrok → HTTPS URL</span>
        </div>
      </div>

      <div class="card">
        <b>4) PROMPT для Cursor</b>
        <div class="kbd" id="pay-prompt">${makePrompt(state.pay)}</div>
        <div class="row">
          <button class="btn primary" id="pay-copy">Скопіювати PROMPT</button>
          <button class="btn" id="pay-doc">Відкрити документацію</button>
        </div>
      </div>

      <div class="card">
        <b>Фініш</b>
        <div class="hint">Після впровадження оплат — твій бот готовий до монетизації. Далі — дрібні правки/брендинг.</div>
        <div class="row">
          <button class="btn" id="pay-done">Позначити як виконано → Готово</button>
        </div>
      </div>
    `;
    main.appendChild(wrap);

    // binds
    $('#pay-stars')?.addEventListener('click', ()=>{ state.pay.provider='stars'; save(); renderPay(true); });
    $('#pay-stripe')?.addEventListener('click', ()=>{ state.pay.provider='stripe'; save(); renderPay(true); });

    $('#pay-plan')?.addEventListener('input', e=>{ state.pay.planName=e.target.value; save(); $('#pay-prompt').textContent = makePrompt(state.pay); });
    $('#pay-price')?.addEventListener('input', e=>{ state.pay.price=e.target.value; save(); $('#pay-prompt').textContent = makePrompt(state.pay); });
    $('#pay-cur')?.addEventListener('input', e=>{ state.pay.currency=e.target.value; save(); $('#pay-prompt').textContent = makePrompt(state.pay); });

    $('#pay-extra1')?.addEventListener('input', e=>{
      if(state.pay.provider==='stars'){ state.pay.tg_app_name=e.target.value; }
      else { state.pay.success_url=e.target.value; }
      save(); $('#pay-prompt').textContent = makePrompt(state.pay);
    });
    $('#pay-extra2')?.addEventListener('input', e=>{
      if(state.pay.provider!=='stars'){ state.pay.cancel_url=e.target.value; save(); $('#pay-prompt').textContent = makePrompt(state.pay); }
    });
    $('#pay-k1')?.addEventListener('input', e=>{
      if(state.pay.provider==='stripe'){ state.pay.stripe_pk=e.target.value; }
      else { state.pay.fondy_merchant_id=e.target.value; }
      save(); $('#pay-prompt').textContent = makePrompt(state.pay);
    });
    $('#pay-k2')?.addEventListener('input', e=>{
      if(state.pay.provider==='stripe'){ state.pay.stripe_sk=e.target.value; }
      else { state.pay.fondy_secret=e.target.value; }
      save(); $('#pay-prompt').textContent = makePrompt(state.pay);
    });

    $('#pay-copy')?.addEventListener('click', async()=>{
      const txt = $('#pay-prompt').textContent;
      try{ await navigator.clipboard.writeText(txt); toast('Скопійовано.'); }
      catch(e){ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); toast('Скопійовано.'); }
    });

    $('#pay-doc')?.addEventListener('click', ()=> window.open(providerDocUrl(), '_blank', 'noopener'));

    $('#pay-done')?.addEventListener('click', ()=>{
      const store=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
      if(!Array.isArray(store.done)) store.done=[];
      const all = root.__flatAll||[];
      const idx = store.current ?? 0;
      if(!store.done.includes(idx)) store.done.push(idx);
      // перейти до "Готово" (перший пункт секції апґрейдів або залишитись)
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
      toast('Позначено. Апґрейди завершено.');
    });

    // оновити прогрес у шапці (якщо глобальний елемент є)
    const progressEl = $('#gp-progress');
    if(progressEl){
      const base=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
      const done=(base.done||[]).length, total=(base.flat||[]).length||1;
      const pct=Math.round((done/total)*100)||0;
      progressEl.textContent = `${pct}% виконано · мова: ${(base.lang||'uk').toUpperCase?.()||'UK'}`;
    }
  }

  function toast(msg){
    let t = root.querySelector('#gp-toast-m14');
    if(!t){ t=document.createElement('div'); t.id='gp-toast-m14'; t.className='toast'; t.style.display='none'; root.appendChild(t); }
    t.innerHTML = msg; t.style.display='block'; clearTimeout(window.__gp_to_m14);
    window.__gp_to_m14 = setTimeout(()=> t.style.display='none', 1600);
  }

  function init(){
    if(!root.__flatAll){
      const base = JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
      root.__flatAll = (base.flat||[]);
    }
    renderPay(true);
    setInterval(()=> renderPay(false), 400);
  }
  init();
})();
</script>
<!-- GP:END UPGRADE PAY SCRIPT -->
<!-- GP:M14 END -->
<!-- GP:M15 START • POLISH (build 2025-10-29.p1) -->
<style>
  /* Мобільні дрібниці + кращі тап-зони */
  #gp-panel .btn{ align-items:center; gap:8px; }
  #gp-panel .btn .ico{ font-style:normal; font-size:14px; }
  @media (max-width:780px){
    #gp-panel .top{ position:sticky; top:0; z-index:9; background:var(--bg); padding:8px 0; border-bottom:1px solid var(--line) }
    #gp-panel .btn{ padding:10px 12px; border-radius:12px }
    #gp-panel .qbtn{ padding:8px 12px; border-radius:999px }
    #gp-panel .kbd{ font-size:11px }
  }

  /* Хінти під кнопками */
  #gp-panel .hintline{display:flex;gap:8px;align-items:center;margin-top:6px;color:var(--muted);font-size:12px}
  #gp-panel .hintline .dot{width:6px;height:6px;border-radius:50%;background:var(--muted);opacity:.6}

  /* Міні-дашборд у шапці */
  #gp-pulse{display:inline-flex;gap:10px;align-items:center;border:1px dashed var(--line);
    border-radius:999px;padding:6px 10px;margin-left:6px;font-size:12px;color:var(--muted)}
  #gp-pulse b{color:var(--text)}
</style>

<script>
(function(){
  const root=document.getElementById('gp-panel'); if(!root) return;

  /* ===== АНАЛІТИКА (дуже проста, без мережі) ===== */
  const AKEY='gpPanel_analytics_v1';
  const an = loadA();

  function loadA(){ try{ return JSON.parse(localStorage.getItem(AKEY)||'{}'); }catch(e){ return {}; } }
  function saveA(){ try{ localStorage.setItem(AKEY, JSON.stringify(an)); }catch(e){} }
  function inc(path){
    // path типу "click.copy_prompt" або "step.done" або "modal.troubles"
    const now = Date.now();
    an.__last = now;
    const seg = path.split('.');
    let ref = an;
    for(const s of seg){ if(!ref[s]) ref[s]={}; ref=ref[s]; }
    ref._n = (ref._n||0)+1;
    saveA();
  }
  // слухачі з базових модулів (коли користувач позначає крок виконаним)
  root.addEventListener('gp:markDone', ()=> inc('step.done'));

  // перехоплюємо кліки на ключових кнопках (делегування)
  document.addEventListener('click', (e)=>{
    const id = (e.target.closest('button')||{}).id||'';
    if(!id) return;
    if(/copy|m9-copy|m10-copy|st-copy|pay-copy|gp-copy/.test(id)) inc('click.copy_prompt');
    if(/open|m11-open-telegram|m11-open-bf|m9-open-chat/.test(id)) inc('click.open');
    if(/done|m9-done|m10-done|m11-done|st-done|pay-done/.test(id)) inc('click.done');
    if(/troubles|gp-troubles/.test(id)) inc('modal.troubles');
  });

  /* ===== ПУЛЬС ПРОГРЕСУ в шапці ===== */
  ensurePulse();
  renderPulse(); // одразу
  // оновлюємо при кожному кліку/збереженні
  setInterval(renderPulse, 1000);

  function ensurePulse(){
    const top = root.querySelector('.switch'); if(!top) return;
    if(!document.getElementById('gp-pulse')){
      const span = document.createElement('span');
      span.id='gp-pulse';
      span.innerHTML = `<span class="ico">📈</span><span>Пульс: <b id="gp-pulse-done">0</b>/<span id="gp-pulse-total">0</span> · CTR копій: <b id="gp-pulse-ctr">0%</b></span>`;
      // додаємо до першої групи у шапці (поруч із прогресом)
      const prog = document.getElementById('gp-progress');
      (prog && prog.parentNode) ? prog.parentNode.appendChild(span) : top.appendChild(span);
    }
  }
  function renderPulse(){
    const store = JSON.parse(localStorage.getItem('gpPanel_v3_hotfix')||'{}');
    const done = (store.done||[]).length||0;
    const total = (store.flat||[]).length||0;
    const copyN = (((an||{}).click||{}).copy_prompt||{})._n||0;
    const openN = (((an||{}).click||{}).open||{})._n||1; // щоб не ділили на 0
    const ctr = Math.min(100, Math.round( (copyN/openN)*100 ));
    setText('#gp-pulse-done', done);
    setText('#gp-pulse-total', total);
    setText('#gp-pulse-ctr', ctr+'%');
  }
  function setText(sel, val){ const el=document.querySelector(sel); if(el) el.textContent=val; }

  /* ===== МІКРОТЕКСТИ / ІКОНКИ (без лому існуючого UI) ===== */
  // 1) Додаємо підказки під ключові кнопки, якщо їх ще немає
  function hintUnder(btnSel, text){
    const btn = root.querySelector(btnSel); if(!btn) return;
    // якщо вже є підказка поруч — не дублюємо
    if(btn.nextElementSibling && btn.nextElementSibling.classList && btn.nextElementSibling.classList.contains('hintline')) return;
    const line = document.createElement('div'); line.className='hintline';
    line.innerHTML = `<span class="dot"></span><span>${text}</span>`;
    btn.parentNode && btn.parentNode.appendChild(line);
  }
  // 2) Легкі емодзі-ікони до тексту кнопок (лише якщо немає всередині svg)
  function addIcon(btnSel, emoji){
    const btn = root.querySelector(btnSel); if(!btn) return;
    if(btn.querySelector('svg')) return; // не чіпаємо ваші svg
    if(btn.querySelector('.ico')) return; // вже додано
    const span = document.createElement('span'); span.className='ico'; span.textContent=emoji;
    btn.insertBefore(span, btn.firstChild);
  }

  // ІНІЦІАЛЬНА ДОПОЛІРОВКА (з повагою до вже існуючого DOM)
  function polishPass(){
    // Шапка
    addIcon('#gp-guide-open','📘');
    addIcon('#gp-help','❓');
    addIcon('#gp-troubles','🛠️');
    addIcon('#gp-toggle','🗂️');
    addIcon('#gp-settings','⚙️');
    addIcon('#gp-reset','♻️');

    // Головні робочі дії
    addIcon('#gp-copy1','📋'); addIcon('#gp-copy2','📋'); addIcon('#gp-copy-both','📑');
    addIcon('#gp-open','🔗');  addIcon('#gp-done','✅');

    // Підказки під найкритичніші кнопки
    hintUnder('#gp-copy-both','Скопіює обидва промпти одразу. Встав у Chat1/Chat2.');
    hintUnder('#gp-done','Якщо крок виконано й все ок — тисни “Виконано”.');
    hintUnder('#gp-troubles','Найчастіші фейли: відсутній .env, неактивний venv, забутий pip install.');

    // Екрани M9–M14 (якщо присутні)
    addIcon('#m9-copy-prompt','📋'); addIcon('#m9-copy-both','📑'); addIcon('#m9-open-chat','💬'); addIcon('#m9-done','✅');
    hintUnder('#m9-copy-prompt','Встав у чат Cursor, що прив’язаний до папки проекту.');

    addIcon('#m10-copy','📋'); addIcon('#m10-troubles','🛠️'); addIcon('#m10-done','✅');
    hintUnder('#m10-copy','Скопіює всі команди — встав у свій термінал.');

    addIcon('#m11-copy','📋'); addIcon('#m11-open-bf','🤖'); addIcon('#m11-done','✅');

    addIcon('#m12-copy','📋'); addIcon('#m12-done','✅');

    addIcon('#st-copy','📋'); addIcon('#st-done','✅');

    addIcon('#pay-copy','📋'); addIcon('#pay-doc','📚'); addIcon('#pay-done','✅');
  }

  // разово і далі періодично (бо DOM у тебе динамічний між модулями)
  polishPass();
  const __polishObserver = new MutationObserver(()=>polishPass());
  __polishObserver.observe(root, { childList:true, subtree:true });

})();
</script>
<!-- GP:M15 END -->


