<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zero-to-Bot Panel</title>
  <style>
    :root {
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, rgba(70, 100, 255, 0.12), transparent 55%), #f4f6fb;
      color: #101828;
      display: flex;
      justify-content: center;
      padding: 32px 16px 48px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body[data-theme="dark"] {
      background: radial-gradient(circle at top, rgba(70, 100, 255, 0.16), transparent 60%), #060c18;
      color: #e5edff;
      color-scheme: dark;
    }

    #ztb-app {
      width: min(1120px, 100%);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      backdrop-filter: blur(14px);
      box-shadow: 0 28px 80px -40px rgba(15, 23, 42, 0.55);
      display: flex;
      flex-direction: column;
      min-height: 92vh;
      border: 1px solid rgba(70, 100, 255, 0.12);
      overflow: hidden;
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    body[data-theme="dark"] #ztb-app {
      background: rgba(11, 18, 32, 0.88);
      border-color: rgba(70, 100, 255, 0.2);
      box-shadow: 0 32px 90px -46px rgba(4, 12, 28, 0.95);
    }

    header {
      padding: 22px 28px 12px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      transition: border-color 0.3s ease;
    }

    body[data-theme="dark"] header {
      border-color: rgba(148, 163, 184, 0.16);
    }

    header .top-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .brand .logo {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      display: grid;
      place-items: center;
      color: #fff;
      font-size: 22px;
      font-weight: 600;
      background: linear-gradient(120deg, #4664ff, #55a0ff);
    }

    .brand h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .status-line {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .status-line .tag {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      background: rgba(70, 100, 255, 0.12);
      color: #1e3aff;
    }

    body[data-theme="dark"] .status-line .tag {
      background: rgba(70, 100, 255, 0.22);
      color: #9db4ff;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button,
    .btn {
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #fff;
      color: inherit;
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }

    body[data-theme="dark"] button,
    body[data-theme="dark"] .btn {
      background: rgba(13, 24, 45, 0.9);
      border-color: rgba(148, 163, 184, 0.18);
    }

    button.primary,
    .btn.primary {
      border: none;
      color: #fff;
      background: linear-gradient(120deg, #4664ff, #55a0ff);
      font-weight: 600;
      box-shadow: 0 12px 28px -18px rgba(70, 100, 255, 0.75);
    }

    button.chat2 {
      background: rgba(85, 160, 255, 0.16);
      border-color: rgba(85, 160, 255, 0.32);
      color: #0f1f52;
    }

    body[data-theme="dark"] button.chat2 {
      background: rgba(85, 160, 255, 0.25);
      color: #eaf1ff;
    }

    button.ghost,
    .btn.ghost {
      background: transparent;
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 34px -24px rgba(15, 23, 42, 0.5);
    }

    .progress {
      margin-top: 16px;
      display: grid;
      gap: 8px;
    }

    .progress-label {
      font-size: 13px;
      color: rgba(15, 23, 42, 0.65);
    }

    body[data-theme="dark"] .progress-label {
      color: rgba(226, 232, 240, 0.7);
    }

    .progress-bar {
      height: 8px;
      background: rgba(70, 100, 255, 0.18);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar span {
      display: block;
      height: 100%;
      width: 0;
      border-radius: inherit;
      background: linear-gradient(120deg, #4664ff, #55a0ff);
      transition: width 0.35s ease;
    }

    main {
      flex: 1;
      padding: 38px 36px 48px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .step-headline {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .step-headline h2 {
      margin: 0;
      font-size: 26px;
    }

    .step-headline p {
      margin: 0;
      color: rgba(15, 23, 42, 0.7);
      font-size: 15px;
      max-width: 640px;
    }

    body[data-theme="dark"] .step-headline p {
      color: rgba(226, 232, 240, 0.75);
    }

    .step-body {
      display: grid;
      gap: 20px;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .card {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 18px;
      padding: 18px;
      background: rgba(255, 255, 255, 0.8);
      display: grid;
      gap: 10px;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    body[data-theme="dark"] .card {
      background: rgba(13, 24, 45, 0.8);
      border-color: rgba(148, 163, 184, 0.18);
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(70, 100, 255, 0.6);
      box-shadow: 0 18px 38px -28px rgba(70, 100, 255, 0.4);
    }

    .card.active {
      border: 2px solid rgba(70, 100, 255, 0.8);
      box-shadow: 0 18px 42px -30px rgba(70, 100, 255, 0.5);
    }

    .card h3 {
      margin: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card p {
      margin: 0;
      color: rgba(15, 23, 42, 0.68);
      font-size: 14px;
    }

    body[data-theme="dark"] .card p {
      color: rgba(226, 232, 240, 0.75);
    }

    .form-grid {
      display: grid;
      gap: 16px;
    }

    .form-grid.two {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: rgba(15, 23, 42, 0.72);
      font-weight: 600;
    }

    body[data-theme="dark"] label {
      color: rgba(226, 232, 240, 0.8);
    }

    input,
    textarea,
    select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 12px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.92);
      color: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    body[data-theme="dark"] input,
    body[data-theme="dark"] textarea,
    body[data-theme="dark"] select {
      background: rgba(9, 16, 28, 0.92);
      border-color: rgba(148, 163, 184, 0.2);
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: rgba(70, 100, 255, 0.7);
      box-shadow: 0 0 0 3px rgba(70, 100, 255, 0.18);
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: rgba(70, 100, 255, 0.08);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chip.active {
      background: linear-gradient(120deg, #4664ff, #55a0ff);
      color: #fff;
      border-color: transparent;
    }

    body[data-theme="dark"] .chip {
      border-color: rgba(148, 163, 184, 0.18);
      background: rgba(70, 100, 255, 0.12);
      color: #dbe7ff;
    }
    .info-block {
      border: 1px dashed rgba(70, 100, 255, 0.4);
      border-radius: 14px;
      padding: 16px;
      display: grid;
      gap: 10px;
      background: rgba(70, 100, 255, 0.07);
      font-size: 14px;
    }

    body[data-theme="dark"] .info-block {
      background: rgba(70, 100, 255, 0.16);
      border-color: rgba(70, 100, 255, 0.6);
      color: #e8eeff;
    }

    .prompt-area {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 16px;
      padding: 16px;
      background: rgba(247, 249, 255, 0.7);
      font-family: "IBM Plex Mono", "Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace;
      font-size: 13px;
      line-height: 1.55;
      white-space: pre-wrap;
      color: #0b1a46;
      position: relative;
    }

    body[data-theme="dark"] .prompt-area {
      background: rgba(9, 16, 28, 0.88);
      border-color: rgba(148, 163, 184, 0.22);
      color: #dbe7ff;
    }

    .prompt-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #4664ff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .prompt-label.chat1 { color: #4664ff; }
    .prompt-label.chat2 { color: #1aa251; }
    .prompt-label.cursor { color: #0b6bff; }

    .prompt-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .checklist {
      display: grid;
      gap: 10px;
    }

    .check-item {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.78);
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    body[data-theme="dark"] .check-item {
      background: rgba(13, 24, 45, 0.8);
      border-color: rgba(148, 163, 184, 0.18);
    }

    .check-item input {
      width: 20px;
      height: 20px;
      margin-top: 2px;
    }

    .check-item.completed {
      border-color: rgba(26, 162, 81, 0.6);
      background: rgba(26, 162, 81, 0.12);
    }

    .bottom-bar {
      padding: 20px 28px 28px;
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      transition: border-color 0.3s ease;
    }

    body[data-theme="dark"] .bottom-bar {
      border-color: rgba(148, 163, 184, 0.16);
    }

    .bottom-bar .note {
      font-size: 13px;
      color: rgba(15, 23, 42, 0.65);
    }

    body[data-theme="dark"] .bottom-bar .note {
      color: rgba(226, 232, 240, 0.7);
    }

    .toast {
      position: fixed;
      bottom: 26px;
      right: 30px;
      background: linear-gradient(135deg, rgba(70, 100, 255, 0.92), rgba(85, 160, 255, 0.9));
      color: #fff;
      padding: 14px 18px;
      border-radius: 14px;
      box-shadow: 0 18px 38px -24px rgba(70, 100, 255, 0.6);
      display: none;
      gap: 10px;
      font-size: 14px;
      align-items: center;
      z-index: 20;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(6, 12, 24, 0.55);
      display: none;
      z-index: 25;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .modal .box {
      width: min(760px, 92vw);
      max-height: 84vh;
      overflow: auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 26px;
      display: grid;
      gap: 16px;
      border: 1px solid rgba(70, 100, 255, 0.14);
      box-shadow: 0 32px 88px -46px rgba(6, 12, 24, 0.65);
    }

    body[data-theme="dark"] .modal .box {
      background: rgba(9, 14, 26, 0.95);
      border-color: rgba(70, 100, 255, 0.35);
      color: #f1f5ff;
    }

    .modal .box h3 {
      margin: 0;
    }

    .modal .box p {
      margin: 0;
      color: inherit;
      opacity: 0.85;
    }

    .modal .list {
      display: grid;
      gap: 12px;
    }

    .note-area {
      display: grid;
      gap: 8px;
    }

    .note-area textarea {
      min-height: 120px;
      resize: vertical;
    }

    @media (max-width: 860px) {
      header,
      .bottom-bar {
        padding-inline: 20px;
      }

      main {
        padding-inline: 22px;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div id="ztb-app">
    <header>
      <div class="top-line">
        <div class="brand">
          <div class="logo">🤖</div>
          <div>
            <h1>Zero-to-Bot Panel</h1>
            <div class="status-line">
              <span class="tag" id="mode-badge">Режим не обрано</span>
              <span class="tag" id="env-badge">Середовище не вибране</span>
            </div>
          </div>
        </div>
        <div class="controls">
          <button class="ghost" id="open-help">❓ Допомога</button>
          <button class="ghost" id="open-trouble">🪛 Траблшутінг</button>
          <button class="ghost" id="open-how">ℹ️ Як це працює</button>
          <button id="toggle-theme">🌙 Темна тема</button>
          <button id="reset-flow">🔄 Почати спочатку</button>
        </div>
      </div>
      <div class="progress">
        <span class="progress-label" id="progress-label">Прогрес: 0% · Крок 0 / 11</span>
        <div class="progress-bar"><span id="progress-bar"></span></div>
      </div>
    </header>
    <main>
      <div class="step-headline">
        <h2 id="step-title">Ласкаво просимо!</h2>
        <p id="step-desc">Оберіть «Почати», щоб запустити майстер. Ми підкажемо кожен крок.</p>
      </div>
      <div class="step-body" id="step-body"></div>
      <div class="note-area" id="note-wrapper" hidden>
        <label for="step-note">Нотатки для цього кроку (зберігається локально)</label>
        <textarea id="step-note" placeholder="Записуй відповіді ChatGPT, токени або власні думки"></textarea>
      </div>
    </main>
    <div class="bottom-bar">
      <div class="note" id="action-hint">Почніть із натискання «Почати».</div>
      <div class="controls">
        <button id="prev-step">⬅️ Назад</button>
        <button class="primary" id="next-step">Далі ➡️</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="modal-backdrop" id="modal-backdrop"></div>
  <div class="modal" id="modal"></div>

  <script>
    if (typeof structuredClone !== 'function') {
      window.structuredClone = (value) => JSON.parse(JSON.stringify(value));
    }

    const STORAGE_KEY = 'ztb_panel_state_v2';

    const defaultState = {
      currentStep: 0,
      started: false,
      theme: 'light',
      mode: null,
      environment: null,
      survey: {
        role: '',
        goal: '',
        audience: '',
        tone: 'friendly',
        commands: ['/start', '/help'],
        language: 'uk',
        channel: 'dm'
      },
      autoProfile: {
        type: '',
        modules: [],
        storage: '',
        integrations: [],
        backend: '',
        uiLanguage: 'uk',
        difficulty: 'L0'
      },
      assistedBrief: '',
      generatedBrief: '',
      generatedCursorPrompt: '',
      generatedChecklist: [],
      notes: {},
      tools: {
        python: false,
        cursor: false,
        editor: false,
        codespaces: false
      },
      testChecklist: {
        start: false,
        help: false,
        custom: false
      }
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return Object.assign(structuredClone(defaultState), parsed);
      } catch (err) {
        console.error('Failed to load state', err);
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    const steps = [
      {
        id: 'start',
        title: 'Старт',
        desc: 'Пояснюємо, як працює панель. 1 дія — 1 екран.',
        render: renderStartStep,
        showNotes: false
      },
      {
        id: 'survey',
        title: 'Анкета',
        desc: 'Опиши, який бот потрібен. Ми підкажемо навіть якщо немає ідей.',
        render: renderSurveyStep,
        showNotes: true
      },
      {
        id: 'mode',
        title: 'Вибір режиму',
        desc: 'AUTO — панель сама генерує промпти. ASSISTED — працюємо через ChatGPT Навігатора.',
        render: renderModeStep,
        showNotes: false
      },
      {
        id: 'builder',
        title: 'Конструктор бота',
        desc: 'Склади конфігурацію з плиток. Якщо режим ASSISTED — цей крок можна пропустити.',
        render: renderBuilderStep,
        showNotes: true
      },
      {
        id: 'overview',
        title: 'DEV BRIEF та промпти',
        desc: 'Ось короткий DEV BRIEF і готові промпти для ChatGPT та Cursor.',
        render: renderOverviewStep,
        showNotes: true
      },
      {
        id: 'environment',
        title: 'Вибір середовища',
        desc: 'Пояснюємо різницю між Local та Codespaces. Обери, що зручно.',
        render: renderEnvironmentStep,
        showNotes: false
      },
      {
        id: 'tools',
        title: 'Підготовка інструментів',
        desc: 'Переконайся, що всі програми встановлені та відкриті.',
        render: renderToolsStep,
        showNotes: false
      },
      {
        id: 'cursor',
        title: 'Вставити у Cursor',
        desc: 'Скопіюй промпт і встав у Cursor (Chat 2).',
        render: renderCursorStep,
        showNotes: true
      },
      {
        id: 'launch',
        title: 'Запуск',
        desc: 'Скопіюй команди у термінал та перевір, що бот працює.',
        render: renderLaunchStep,
        showNotes: false
      },
      {
        id: 'botfather',
        title: 'BotFather',
        desc: 'Додай команди та налаштуй бота.',
        render: renderBotFatherStep,
        showNotes: false
      },
      {
        id: 'test',
        title: 'Перевірка',
        desc: 'Пройди чек-лист і переконайся, що все працює.',
        render: renderTestStep,
        showNotes: true
      },
      {
        id: 'finish',
        title: 'Готово та апґрейди',
        desc: 'Обери наступні кроки: кнопки, статистика, оплати.',
        render: renderFinishStep,
        showNotes: false
      }
    ];

    const elements = {
      title: document.getElementById('step-title'),
      desc: document.getElementById('step-desc'),
      body: document.getElementById('step-body'),
      noteWrap: document.getElementById('note-wrapper'),
      note: document.getElementById('step-note'),
      progressLabel: document.getElementById('progress-label'),
      progressBar: document.getElementById('progress-bar'),
      actionHint: document.getElementById('action-hint'),
      prev: document.getElementById('prev-step'),
      next: document.getElementById('next-step'),
      toast: document.getElementById('toast'),
      modeBadge: document.getElementById('mode-badge'),
      envBadge: document.getElementById('env-badge'),
      modal: document.getElementById('modal'),
      backdrop: document.getElementById('modal-backdrop')
    };
    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      const toggle = document.getElementById('toggle-theme');
      if (theme === 'dark') {
        toggle.textContent = '☀️ Світла тема';
      } else {
        toggle.textContent = '🌙 Темна тема';
      }
    }

    function toggleTheme() {
      const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      setTheme(next);
      state.theme = next;
      saveState();
    }

    function showToast(message) {
      elements.toast.textContent = message;
      elements.toast.style.display = 'inline-flex';
      setTimeout(() => {
        elements.toast.style.display = 'none';
      }, 2200);
    }

    function openModal(content) {
      elements.modal.innerHTML = '';
      elements.modal.appendChild(content);
      elements.modal.style.display = 'flex';
      elements.backdrop.style.display = 'block';
    }

    function closeModal() {
      elements.modal.style.display = 'none';
      elements.backdrop.style.display = 'none';
      elements.modal.innerHTML = '';
    }

    elements.backdrop.addEventListener('click', closeModal);

    function createModal({ title, body, list, actions }) {
      const box = document.createElement('div');
      box.className = 'box';
      const head = document.createElement('div');
      head.style.display = 'flex';
      head.style.justifyContent = 'space-between';
      head.style.alignItems = 'center';
      head.style.gap = '12px';

      const titleEl = document.createElement('h3');
      titleEl.textContent = title;
      head.appendChild(titleEl);

      const closeBtn = document.createElement('button');
      closeBtn.textContent = '✕';
      closeBtn.className = 'ghost';
      closeBtn.style.justifySelf = 'flex-end';
      closeBtn.addEventListener('click', closeModal);
      head.appendChild(closeBtn);

      box.appendChild(head);

      if (body) {
        const p = document.createElement('p');
        p.innerHTML = body;
        box.appendChild(p);
      }

      if (Array.isArray(list)) {
        const ul = document.createElement('div');
        ul.className = 'list';
        list.forEach((item) => {
          const li = document.createElement('div');
          li.innerHTML = item;
          ul.appendChild(li);
        });
        box.appendChild(ul);
      }

      if (Array.isArray(actions) && actions.length) {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.flexWrap = 'wrap';
        row.style.gap = '10px';
        actions.forEach((action) => {
          const btn = document.createElement('button');
          btn.textContent = action.label;
          if (action.variant === 'primary') btn.classList.add('primary');
          btn.addEventListener('click', () => {
            if (action.onClick) action.onClick();
          });
          row.appendChild(btn);
        });
        box.appendChild(row);
      }

      return box;
    }

    document.getElementById('open-how').addEventListener('click', () => {
      openModal(
        createModal({
          title: 'Як працює панель',
          body: 'Все дуже просто: копіюєш наші промпти → вставляєш у потрібний чат → виконуєш крок → натискаєш «Далі».',
          list: [
            '1. Заповнюєш коротку анкету про майбутнього бота.',
            '2. Обираєш режим: AUTO або ASSISTED. У будь-якому випадку ми підготуємо англомовні промпти.',
            '3. Якщо AUTO — ти лише натискаєш «Скопіювати» і вставляєш у Cursor. Якщо ASSISTED — ChatGPT допомагає сформувати DEV BRIEF.',
            '4. Далі ми ведемо тебе через підготовку середовища, запуск і налаштування BotFather.',
            '5. У кожному кроці є кнопка «Проблема?» — не соромся натискати.'
          ]
        })
      );
    });

    document.getElementById('open-help').addEventListener('click', () => {
      openModal(
        createModal({
          title: 'Допомога',
          body: 'Якщо щось незрозуміло, скористайся цими підказками.',
          list: [
            'Працюй послідовно: 1 екран = 1 дія. Не перескакуй.',
            'Усі поля можна редагувати пізніше. Панель запам’ятовує прогрес.',
            'Для ChatGPT створюй окремий чат «Навігатор» — він допомагає пояснити помилки простими словами.',
            'Усі промпти вже містять переклади та нагадування: просто копіюй і вставляй.'
          ],
          actions: [
            {
              label: 'Перейти до «Проблема?»',
              onClick: () => {
                closeModal();
                renderProblemModal();
              }
            }
          ]
        })
      );
    });

    document.getElementById('open-trouble').addEventListener('click', renderProblemModal);
    function renderProblemModal() {
      openModal(
        createModal({
          title: 'Траблшутінг',
          body: 'Оберіть ситуацію — ми сформуємо англомовне питання для ChatGPT Навігатора.',
          list: [
            '<strong>Python не знайдено</strong> → перевір встановлення. Запусти <code>python --version</code>.',
            '<strong>Помилка токена</strong> → переконайся, що у файлі <code>.env</code> є <code>TOKEN=...</code>.',
            '<strong>Бот мовчить</strong> → дивись термінал. Скопіюй лог та надішли в Навігатор.',
            '<strong>ModuleNotFoundError</strong> → виконай <code>pip install -r requirements.txt</code>.'
          ],
          actions: [
            {
              label: 'Згенерувати запит для Навігатора',
              variant: 'primary',
              onClick: () => {
                closeModal();
                renderNavigatorPromptModal();
              }
            }
          ]
        })
      );
    }

    function renderNavigatorPromptModal() {
      const prompt = generateNavigatorHelpPrompt();
      const box = createModal({
        title: 'Повідомлення для Chat 1 (Навігатор)',
        body: 'Скопіюй текст нижче та надішли в ChatGPT. Він розпише кроки українською.',
        actions: [
          {
            label: 'Скопіювати',
            variant: 'primary',
            onClick: () => {
              copyText(prompt);
              showToast('Повідомлення скопійовано. Встав у ChatGPT Навігатор.');
            }
          }
        ]
      });
      const area = document.createElement('div');
      area.className = 'prompt-area';
      area.textContent = prompt;
      box.insertBefore(area, box.lastChild);
      openModal(box);
    }

    document.getElementById('toggle-theme').addEventListener('click', toggleTheme);
    document.getElementById('reset-flow').addEventListener('click', () => {
      if (confirm('Скинути всі дані та почати спочатку?')) {
        state = structuredClone(defaultState);
        state.theme = document.body.getAttribute('data-theme');
        saveState();
        setStep(0);
        showToast('Панель оновлено. Почнімо знову!');
      }
    });

    elements.prev.addEventListener('click', () => {
      if (state.currentStep === 0) return;
      setStep(state.currentStep - 1);
    });

    elements.next.addEventListener('click', () => {
      if (state.currentStep === steps.length - 1) return;
      const { allowAdvance, message } = validateStep();
      if (!allowAdvance) {
        showToast(message || 'Заверши дію на поточному екрані.');
        return;
      }
      setStep(state.currentStep + 1);
    });

    elements.note.addEventListener('input', (event) => {
      const key = steps[state.currentStep].id;
      state.notes[key] = event.target.value;
      saveState();
    });

    function setStep(index) {
      state.currentStep = Math.max(0, Math.min(index, steps.length - 1));
      saveState();
      render();
    }

    function render() {
      const step = steps[state.currentStep];
      ensurePrompts();
      elements.title.textContent = `Крок ${state.currentStep} · ${step.title}`;
      elements.desc.textContent = step.desc;
      elements.body.innerHTML = '';
      step.render(elements.body);
      const total = steps.length - 1;
      const progress = Math.round((state.currentStep / total) * 100);
      elements.progressLabel.textContent = `Прогрес: ${progress}% · Крок ${state.currentStep} / ${total}`;
      elements.progressBar.style.width = `${progress}%`;
      elements.prev.disabled = state.currentStep === 0;
      elements.next.disabled = state.currentStep === steps.length - 1;
      if (step.showNotes) {
        elements.noteWrap.hidden = false;
        const key = step.id;
        elements.note.value = state.notes[key] || '';
      } else {
        elements.noteWrap.hidden = true;
      }
      updateBadges();
      elements.actionHint.textContent = getStepHint(step.id);
      saveState();
    }

    function updateBadges() {
      elements.modeBadge.textContent = state.mode ? `Режим: ${state.mode}` : 'Режим не обрано';
      elements.envBadge.textContent = state.environment ? `Середовище: ${state.environment}` : 'Середовище не вибране';
    }
    function getStepHint(stepId) {
      switch (stepId) {
        case 'start':
          return 'Натисни «Почати» і відмічай кожен підкрок.';
        case 'survey':
          return 'Не знаєш команди? Використай готові варіанти нижче.';
        case 'mode':
          return 'AUTO для швидкого старту. ASSISTED, якщо хочеш спілкуватись з ChatGPT.';
        case 'builder':
          return state.mode === 'ASSISTED' ? 'Режим ASSISTED — цей крок лише для натхнення.' : 'Обери хоча б по одному пункту у кожному блоці.';
        case 'overview':
          return 'Скопіюй промпти і виконай інструкції залежно від режиму.';
        case 'environment':
          return 'Визначся: локально чи в хмарі. Ми підлаштуємо інструкції далі.';
        case 'tools':
          return 'Перевір, що Python, Cursor і редактор вже відкриті.';
        case 'cursor':
          return 'Скопіюй промпт у Cursor. Якщо завис — натисни «Проблема?». ';
        case 'launch':
          return 'Виконай команди по черзі. Якщо є помилка — натисни «Проблема?». ';
        case 'botfather':
          return 'Додай команди. Вони вже перекладені.';
        case 'test':
          return 'Перевір відповіді бота та позначай галочки.';
        case 'finish':
          return 'Обери, що хочеш покращити далі.';
        default:
          return '';
      }
    }

    function validateStep() {
      const step = steps[state.currentStep];
      switch (step.id) {
        case 'survey': {
          const { role, goal } = state.survey;
          if (!role || !goal) {
            return { allowAdvance: false, message: 'Заповни роль і ціль бота. Це можна зробити своїми словами.' };
          }
          return { allowAdvance: true };
        }
        case 'mode': {
          if (!state.mode) return { allowAdvance: false, message: 'Оберіть режим роботи панелі.' };
          return { allowAdvance: true };
        }
        case 'builder': {
          if (state.mode === 'ASSISTED') return { allowAdvance: true };
          const { type, modules, storage } = state.autoProfile;
          if (!type || modules.length === 0 || !storage) {
            return { allowAdvance: false, message: 'Оберіть тип, хоча б один модуль та спосіб збереження.' };
          }
          return { allowAdvance: true };
        }
        case 'overview': {
          if (state.mode === 'ASSISTED' && !state.assistedBrief.trim()) {
            return { allowAdvance: false, message: 'Встав DEV BRIEF, який ти отримав у ChatGPT.' };
          }
          return { allowAdvance: true };
        }
        case 'environment': {
          if (!state.environment) {
            return { allowAdvance: false, message: 'Оберіть середовище: Local або Codespaces.' };
          }
          return { allowAdvance: true };
        }
        default:
          return { allowAdvance: true };
      }
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Скопійовано у буфер.');
      });
    }

    function handleChipToggle(chip, list, value) {
      const index = list.indexOf(value);
      if (index >= 0) {
        list.splice(index, 1);
        chip.classList.remove('active');
      } else {
        list.push(value);
        chip.classList.add('active');
      }
      saveState();
    }

    const COMMAND_SUGGESTIONS = ['/start', '/help', '/add', '/list', '/done', '/stats', '/tips', '/pay', '/admin', '/panic'];
    const BOT_TYPES = [
      { value: 'CRM', label: 'CRM', desc: 'Веде клієнтів і завдання' },
      { value: 'Task Manager', label: 'Task Manager', desc: 'Список справ для команди' },
      { value: 'Habit Tracker', label: 'Habit Tracker', desc: 'Щоденні звички й нагадування' },
      { value: 'FAQ', label: 'FAQ / Support', desc: 'Відповідає на типові питання' },
      { value: 'Shop', label: 'Shop', desc: 'Міні-магазин у Telegram' },
      { value: 'Booking', label: 'Booking', desc: 'Запис на послуги' },
      { value: 'Custom', label: 'Custom', desc: 'Свій сценарій' }
    ];

    const MODULES = [
      ['/start', 'Привітання'],
      ['/help', 'Пояснення'],
      ['/add', 'Додати'],
      ['/list', 'Список'],
      ['/done', 'Позначити виконане'],
      ['/stats', 'Статистика'],
      ['/tips', 'Поради'],
      ['/pay', 'Оплати'],
      ['/admin', 'Адмін-панель'],
      ['/panic', 'Швидка підтримка']
    ];

    const STORAGE_OPTIONS = [
      ['None', 'Без збереження'],
      ['JSON', 'JSON файл (простий варіант)'],
      ['Google Sheets', 'Google Sheets'],
      ['SQLite', 'SQLite'],
      ['Postgres', 'Postgres']
    ];

    const INTEGRATIONS = ['Google Sheets', 'Notion', 'Webhook', 'Stripe', 'OpenAI'];

    const BACKENDS = [
      ['None', 'Без бекенду'],
      ['Parser', 'Парсер сторінки'],
      ['Webhook', 'Webhook прийом'],
      ['FastAPI', 'FastAPI API']
    ];

    const DIFFICULTIES = [
      ['L0', 'L0 — базово'],
      ['L1', 'L1 — середній'],
      ['L2', 'L2 — просунутий'],
      ['L3', 'L3 — складний']
    ];
    function renderStartStep(container) {
      const block = document.createElement('div');
      block.className = 'step-body';

      const intro = document.createElement('div');
      intro.className = 'info-block';
      intro.innerHTML = `
        <strong>Zero-to-Bot Panel</strong> проведе тебе від ідеї до працюючого Telegram-бота.<br>
        Все, що потрібно — читати підказки, копіювати промпти і натискати «Далі».
      `;

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '12px';
      actions.style.flexWrap = 'wrap';

      const startBtn = document.createElement('button');
      startBtn.className = 'primary';
      startBtn.textContent = 'Почати створення';
      startBtn.addEventListener('click', () => {
        state.started = true;
        showToast('Поїхали! Крок 1 — Анкета.');
        setStep(1);
      });

      const howBtn = document.createElement('button');
      howBtn.textContent = 'Як це працює?';
      howBtn.addEventListener('click', () => {
        document.getElementById('open-how').click();
      });

      actions.appendChild(startBtn);
      actions.appendChild(howBtn);

      block.appendChild(intro);
      block.appendChild(actions);

      container.appendChild(block);
    }

    function renderSurveyStep(container) {
      const grid = document.createElement('div');
      grid.className = 'form-grid';

      const row1 = document.createElement('div');
      row1.className = 'form-grid two';

      row1.appendChild(createInput('Роль бота', 'Наприклад: Асистент по звичкам', state.survey.role, (value) => {
        state.survey.role = value;
        saveState();
        ensurePrompts();
      }));

      row1.appendChild(createInput('Головна ціль', 'Що має робити бот?', state.survey.goal, (value) => {
        state.survey.goal = value;
        saveState();
        ensurePrompts();
      }));

      grid.appendChild(row1);

      grid.appendChild(
        createInput('Кому допомагає бот?', 'Наприклад: фрілансерам, клієнтам магазину, команді', state.survey.audience, (value) => {
          state.survey.audience = value;
          saveState();
          ensurePrompts();
        })
      );

      const commandsBlock = document.createElement('div');
      commandsBlock.className = 'form-grid';

      const commandLabel = document.createElement('label');
      commandLabel.textContent = 'Команди (натискай, щоб додати)';
      commandsBlock.appendChild(commandLabel);

      const chips = document.createElement('div');
      chips.className = 'chip-group';

      COMMAND_SUGGESTIONS.forEach((command) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = command;
        if (state.survey.commands.includes(command)) chip.classList.add('active');
        chip.addEventListener('click', () => {
          handleChipToggle(chip, state.survey.commands, command);
          commandsTextarea.value = state.survey.commands.join(', ');
          ensurePrompts();
        });
        chips.appendChild(chip);
      });

      const commandsTextarea = document.createElement('textarea');
      commandsTextarea.value = state.survey.commands.join(', ');
      commandsTextarea.placeholder = 'Наприклад: /start, /help, /add';
      commandsTextarea.addEventListener('input', (event) => {
        const values = event.target.value
          .split(',')
          .map((item) => item.trim())
          .filter(Boolean);
        state.survey.commands = [...new Set(values.map((cmd) => (cmd.startsWith('/') ? cmd : `/${cmd}`)))];
        saveState();
        ensurePrompts();
        chips.querySelectorAll('.chip').forEach((chip) => {
          if (state.survey.commands.includes(chip.textContent)) chip.classList.add('active');
          else chip.classList.remove('active');
        });
      });

      commandsBlock.appendChild(chips);
      commandsBlock.appendChild(commandsTextarea);

      grid.appendChild(commandsBlock);

      const selectRow = document.createElement('div');
      selectRow.className = 'form-grid two';

      selectRow.appendChild(
        createSelect('Мова інтерфейсу', state.survey.language, [
          ['uk', 'Українська'],
          ['en', 'English']
        ], (value) => {
          state.survey.language = value;
          state.autoProfile.uiLanguage = value;
          saveState();
          ensurePrompts();
        })
      );

      selectRow.appendChild(
        createSelect('Канал', state.survey.channel, [
          ['dm', 'Особисті чати'],
          ['group', 'Групи']
        ], (value) => {
          state.survey.channel = value;
          saveState();
          ensurePrompts();
        })
      );

      grid.appendChild(selectRow);

      const helper = document.createElement('div');
      helper.className = 'info-block';
      helper.innerHTML = `
        <strong>Не знаєш, які команди потрібні?</strong><br>
        Обери готові приклади або залиш наші шаблони. Панель пізніше згенерує блок для BotFather.
      `;

      container.appendChild(grid);
      container.appendChild(helper);
    }
    function createInput(labelText, placeholder, value, onInput) {
      const wrapper = document.createElement('label');
      wrapper.textContent = labelText;
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = placeholder;
      input.value = value;
      input.addEventListener('input', (event) => onInput(event.target.value));
      wrapper.appendChild(input);
      return wrapper;
    }

    function createSelect(labelText, value, options, onChange) {
      const wrapper = document.createElement('label');
      wrapper.textContent = labelText;
      const select = document.createElement('select');
      options.forEach(([val, label]) => {
        const option = document.createElement('option');
        option.value = val;
        option.textContent = label;
        if (value === val) option.selected = true;
        select.appendChild(option);
      });
      select.addEventListener('change', (event) => onChange(event.target.value));
      wrapper.appendChild(select);
      return wrapper;
    }

    function renderModeStep(container) {
      const grid = document.createElement('div');
      grid.className = 'card-grid';

      const autoCard = createModeCard('AUTO', '⚡', 'Панель сама створить англомовний DEV BRIEF і промпт для Cursor. Ідеально, якщо хочеш «натиснути й отримати».');
      const assistedCard = createModeCard('ASSISTED', '💬', 'Отримаєш промпт для ChatGPT Навігатора, який допоможе сформувати DEV BRIEF. Потім вставиш його сюди.');

      if (state.mode === 'AUTO') autoCard.classList.add('active');
      if (state.mode === 'ASSISTED') assistedCard.classList.add('active');

      autoCard.addEventListener('click', () => {
        state.mode = 'AUTO';
        saveState();
        ensurePrompts();
        render();
        showToast('AUTO: промпти генеруються автоматично.');
      });

      assistedCard.addEventListener('click', () => {
        state.mode = 'ASSISTED';
        saveState();
        ensurePrompts();
        render();
        showToast('ASSISTED: працюємо через ChatGPT Навігатора.');
      });

      grid.appendChild(autoCard);
      grid.appendChild(assistedCard);

      const reminder = document.createElement('div');
      reminder.className = 'info-block';
      reminder.innerHTML = `
        <strong>Порада.</strong> Можеш змінити режим у будь-який момент. Всі промпти автоматично перерахуються.
      `;

      container.appendChild(grid);
      container.appendChild(reminder);
    }

    function createModeCard(mode, emoji, description) {
      const card = document.createElement('div');
      card.className = 'card';
      const title = document.createElement('h3');
      title.textContent = `${emoji} ${mode}`;
      const text = document.createElement('p');
      text.textContent = description;
      card.appendChild(title);
      card.appendChild(text);
      return card;
    }
    function renderBuilderStep(container) {
      if (state.mode === 'ASSISTED') {
        const block = document.createElement('div');
        block.className = 'info-block';
        block.innerHTML = `
          Ти обрав режим ASSISTED. Цей конструктор можна пропустити — ChatGPT сам допоможе сформувати структуру. Якщо хочеш, можеш все ж обрати варіанти для натхнення.
        `;
        container.appendChild(block);
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'step-body';

      const typeSection = document.createElement('div');
      typeSection.appendChild(createSectionTitle('Тип бота'));
      const typeGrid = document.createElement('div');
      typeGrid.className = 'card-grid';
      BOT_TYPES.forEach(({ value, label, desc }) => {
        const card = document.createElement('div');
        card.className = 'card';
        if (state.autoProfile.type === value) card.classList.add('active');
        const title = document.createElement('h3');
        title.textContent = label;
        const text = document.createElement('p');
        text.textContent = desc;
        card.appendChild(title);
        card.appendChild(text);
        card.addEventListener('click', () => {
          state.autoProfile.type = value;
          saveState();
          ensurePrompts();
          render();
        });
        typeGrid.appendChild(card);
      });
      typeSection.appendChild(typeGrid);
      wrapper.appendChild(typeSection);

      const modulesSection = document.createElement('div');
      modulesSection.appendChild(createSectionTitle('Модулі та команди'));
      const moduleChips = document.createElement('div');
      moduleChips.className = 'chip-group';
      MODULES.forEach(([value, label]) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = `${value} · ${label}`;
        if (state.autoProfile.modules.includes(value)) chip.classList.add('active');
        chip.addEventListener('click', () => {
          handleChipToggle(chip, state.autoProfile.modules, value);
          ensurePrompts();
        });
        moduleChips.appendChild(chip);
      });
      modulesSection.appendChild(moduleChips);
      wrapper.appendChild(modulesSection);

      const storageSection = document.createElement('div');
      storageSection.appendChild(createSectionTitle('Збереження даних'));
      const storageGrid = document.createElement('div');
      storageGrid.className = 'card-grid';
      STORAGE_OPTIONS.forEach(([value, label]) => {
        const card = document.createElement('div');
        card.className = 'card';
        if (state.autoProfile.storage === value) card.classList.add('active');
        const title = document.createElement('h3');
        title.textContent = label;
        card.appendChild(title);
        card.addEventListener('click', () => {
          state.autoProfile.storage = value;
          saveState();
          ensurePrompts();
          render();
        });
        storageGrid.appendChild(card);
      });
      storageSection.appendChild(storageGrid);
      wrapper.appendChild(storageSection);

      const integrationsSection = document.createElement('div');
      integrationsSection.appendChild(createSectionTitle('Інтеграції'));
      const integrationsChips = document.createElement('div');
      integrationsChips.className = 'chip-group';
      INTEGRATIONS.forEach((integration) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = integration;
        if (state.autoProfile.integrations.includes(integration)) chip.classList.add('active');
        chip.addEventListener('click', () => {
          handleChipToggle(chip, state.autoProfile.integrations, integration);
          ensurePrompts();
        });
        integrationsChips.appendChild(chip);
      });
      integrationsSection.appendChild(integrationsChips);
      wrapper.appendChild(integrationsSection);

      const backendSection = document.createElement('div');
      backendSection.appendChild(createSectionTitle('Бекенд'));
      const backendGrid = document.createElement('div');
      backendGrid.className = 'card-grid';
      BACKENDS.forEach(([value, label]) => {
        const card = document.createElement('div');
        card.className = 'card';
        if (state.autoProfile.backend === value) card.classList.add('active');
        const title = document.createElement('h3');
        title.textContent = label;
        card.appendChild(title);
        card.addEventListener('click', () => {
          state.autoProfile.backend = value;
          saveState();
          ensurePrompts();
          render();
        });
        backendGrid.appendChild(card);
      });
      backendSection.appendChild(backendGrid);
      wrapper.appendChild(backendSection);

      const diffSection = document.createElement('div');
      diffSection.appendChild(createSectionTitle('Рівень складності'));
      diffSection.appendChild(
        createSelect('Оберіть рівень', state.autoProfile.difficulty, DIFFICULTIES, (value) => {
          state.autoProfile.difficulty = value;
          saveState();
          ensurePrompts();
        })
      );
      wrapper.appendChild(diffSection);

      container.appendChild(wrapper);
    }

    function createSectionTitle(text) {
      const title = document.createElement('h3');
      title.textContent = text;
      title.style.margin = '0 0 12px';
      return title;
    }
    function renderOverviewStep(container) {
      ensurePrompts();

      if (state.mode === 'ASSISTED') {
        const assistedCard = document.createElement('div');
        assistedCard.className = 'card';
        const label = document.createElement('div');
        label.className = 'prompt-label chat1';
        label.textContent = 'Chat 1 · Навігатор';
        assistedCard.appendChild(label);
        const text = document.createElement('div');
        text.className = 'prompt-area';
        text.textContent = generateAssistedPrompt();
        assistedCard.appendChild(text);

        const actions = document.createElement('div');
        actions.className = 'prompt-actions';
        const copy = document.createElement('button');
        copy.className = 'chat2';
        copy.textContent = 'Скопіювати для ChatGPT';
        copy.addEventListener('click', () => copyText(text.textContent));
        actions.appendChild(copy);
        assistedCard.appendChild(actions);
        container.appendChild(assistedCard);

        const textareaLabel = document.createElement('label');
        textareaLabel.textContent = 'Встав DEV BRIEF, який повернув ChatGPT';
        const textarea = document.createElement('textarea');
        textarea.placeholder = 'Встав сюди текст англійською. Ми перетворимо його на промпт для Cursor.';
        textarea.value = state.assistedBrief;
        textarea.addEventListener('input', (event) => {
          state.assistedBrief = event.target.value;
          saveState();
          ensurePrompts();
          render();
        });
        textareaLabel.appendChild(textarea);
        container.appendChild(textareaLabel);
      }

      const briefCard = document.createElement('div');
      briefCard.className = 'card';
      const briefLabel = document.createElement('div');
      briefLabel.className = 'prompt-label chat1';
      briefLabel.textContent = 'DEV BRIEF';
      const briefText = document.createElement('div');
      briefText.className = 'prompt-area';
      briefText.textContent = state.generatedBrief;
      const briefCopy = document.createElement('button');
      briefCopy.textContent = 'Скопіювати DEV BRIEF';
      briefCopy.addEventListener('click', () => copyText(state.generatedBrief));
      briefCard.appendChild(briefLabel);
      briefCard.appendChild(briefText);
      briefCard.appendChild(briefCopy);
      container.appendChild(briefCard);

      const cursorCard = document.createElement('div');
      cursorCard.className = 'card';
      const cursorLabel = document.createElement('div');
      cursorLabel.className = 'prompt-label cursor';
      cursorLabel.textContent = 'Cursor Prompt';
      const cursorText = document.createElement('div');
      cursorText.className = 'prompt-area';
      cursorText.textContent = state.generatedCursorPrompt;
      const cursorCopy = document.createElement('button');
      cursorCopy.className = 'chat2';
      cursorCopy.textContent = 'Скопіювати для Cursor';
      cursorCopy.addEventListener('click', () => copyText(state.generatedCursorPrompt));
      cursorCard.appendChild(cursorLabel);
      cursorCard.appendChild(cursorText);
      cursorCard.appendChild(cursorCopy);
      container.appendChild(cursorCard);

      const checklistCard = document.createElement('div');
      checklistCard.className = 'card';
      const checklistLabel = document.createElement('div');
      checklistLabel.className = 'prompt-label';
      checklistLabel.textContent = 'CHECKLIST';
      const list = document.createElement('div');
      list.className = 'checklist';
      state.generatedChecklist.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'check-item';
        row.innerHTML = `<span>•</span><span>${item}</span>`;
        list.appendChild(row);
      });
      checklistCard.appendChild(checklistLabel);
      checklistCard.appendChild(list);
      container.appendChild(checklistCard);
    }
    function renderEnvironmentStep(container) {
      const grid = document.createElement('div');
      grid.className = 'card-grid';

      const localCard = createEnvironmentCard('Local', '💻', 'Працюєш на своєму комп’ютері. Потрібні Python 3.10+ і Cursor.', [
        'Повний контроль над файлами',
        'Працює офлайн',
        'Вимагає встановлення програм'
      ]);

      const cloudCard = createEnvironmentCard('Codespaces', '☁️', 'Все працює в браузері. Нічого ставити не треба, тільки GitHub-акаунт.', [
        'Автоматичне середовище з Linux',
        'Зручний варіант для слабких ПК',
        'Потрібне підключення до інтернету'
      ]);

      if (state.environment === 'Local') localCard.classList.add('active');
      if (state.environment === 'Codespaces') cloudCard.classList.add('active');

      grid.appendChild(localCard);
      grid.appendChild(cloudCard);

      container.appendChild(grid);

      const tip = document.createElement('div');
      tip.className = 'info-block';
      tip.innerHTML = `
        <strong>Що обрати?</strong><br>
        Якщо впевнено працюєш із файлами — обирай Local. Якщо хочеш мінімум налаштувань — обирай Codespaces. Ти можеш змінити вибір пізніше.
      `;
      container.appendChild(tip);
    }

    function createEnvironmentCard(name, emoji, text, bullets) {
      const card = document.createElement('div');
      card.className = 'card';
      const title = document.createElement('h3');
      title.textContent = `${emoji} ${name}`;
      const desc = document.createElement('p');
      desc.textContent = text;
      card.appendChild(title);
      card.appendChild(desc);
      const list = document.createElement('ul');
      list.style.margin = '0';
      list.style.paddingLeft = '18px';
      bullets.forEach((bullet) => {
        const li = document.createElement('li');
        li.textContent = bullet;
        list.appendChild(li);
      });
      card.appendChild(list);
      card.addEventListener('click', () => {
        state.environment = name;
        saveState();
        ensurePrompts();
        render();
        showToast(`Обрано середовище: ${name}`);
      });
      return card;
    }

    function renderToolsStep(container) {
      const tools = [
        {
          key: 'python',
          label: 'Python 3.10+',
          description: 'Без Python бот не запуститься. Натисни, щоб перевірити встановлення.',
          link: 'https://www.python.org/downloads/'
        },
        {
          key: 'cursor',
          label: 'Cursor IDE',
          description: 'Редактор з вбудованим Chat 2. Потрібен для вставки фінального промпта.',
          link: 'https://www.cursor.com/'
        },
        {
          key: 'editor',
          label: 'VS Code (опційно)',
          description: 'Зручний редактор для перегляду файлів, якщо працюєш локально.',
          link: 'https://code.visualstudio.com/'
        },
        {
          key: 'codespaces',
          label: 'GitHub Codespaces',
          description: 'Відкрий готове середовище в браузері.',
          link: 'https://github.com/codespaces'
        }
      ];

      const list = document.createElement('div');
      list.className = 'checklist';

      tools.forEach((tool) => {
        if (tool.key === 'codespaces' && state.environment !== 'Codespaces') return;
        if (tool.key !== 'codespaces' && state.environment === 'Codespaces' && tool.key === 'editor') return;
        const item = document.createElement('label');
        item.className = 'check-item';
        if (state.tools[tool.key]) item.classList.add('completed');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!state.tools[tool.key];
        checkbox.addEventListener('change', (event) => {
          state.tools[tool.key] = event.target.checked;
          saveState();
          if (event.target.checked) {
            item.classList.add('completed');
            showToast(`${tool.label} готово!`);
          } else {
            item.classList.remove('completed');
          }
        });
        const body = document.createElement('div');
        body.innerHTML = `<strong>${tool.label}</strong><br>${tool.description}`;
        const button = document.createElement('button');
        button.textContent = 'Відкрити';
        button.addEventListener('click', () => window.open(tool.link, '_blank'));
        item.appendChild(checkbox);
        item.appendChild(body);
        item.appendChild(button);
        list.appendChild(item);
      });

      container.appendChild(list);
    }
    function renderCursorStep(container) {
      const card = document.createElement('div');
      card.className = 'card';
      const label = document.createElement('div');
      label.className = 'prompt-label cursor';
      label.textContent = 'Cursor Prompt';
      const promptArea = document.createElement('div');
      promptArea.className = 'prompt-area';
      promptArea.textContent = state.generatedCursorPrompt;

      const actions = document.createElement('div');
      actions.className = 'prompt-actions';
      const copyBtn = document.createElement('button');
      copyBtn.className = 'chat2';
      copyBtn.textContent = 'Скопіювати для Cursor';
      copyBtn.addEventListener('click', () => copyText(state.generatedCursorPrompt));
      const whereBtn = document.createElement('button');
      whereBtn.textContent = 'Де вставити?';
      whereBtn.addEventListener('click', () => {
        const modal = createModal({
          title: 'Куди вставляти промпт?',
          body: 'У Cursor відкрий Chat 2 (зелений). Натисни + → «New Chat». Встав промпт повністю і натисни Enter. Якщо Cursor завис — спробуй вставити ще раз і почекай пару хвилин.'
        });
        openModal(modal);
      });
      actions.appendChild(copyBtn);
      actions.appendChild(whereBtn);

      card.appendChild(label);
      card.appendChild(promptArea);
      card.appendChild(actions);

      container.appendChild(card);
    }

    function renderLaunchStep(container) {
      const commands = state.environment === 'Codespaces'
        ? ['python --version', 'pip install -r requirements.txt', 'python main.py']
        : ['python --version', 'python -m venv .venv', 'source .venv/bin/activate  # або .\\.venv\\Scripts\\activate', 'pip install -r requirements.txt', 'python main.py'];

      const card = document.createElement('div');
      card.className = 'card';
      const label = document.createElement('div');
      label.className = 'prompt-label';
      label.textContent = 'Команди для запуску';
      const promptArea = document.createElement('div');
      promptArea.className = 'prompt-area';
      promptArea.textContent = commands.join('\n');

      const actions = document.createElement('div');
      actions.className = 'prompt-actions';
      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'Скопіювати команди';
      copyBtn.addEventListener('click', () => copyText(commands.join('\n')));
      const problemBtn = document.createElement('button');
      problemBtn.textContent = 'Проблема?';
      problemBtn.addEventListener('click', renderProblemModal);
      actions.appendChild(copyBtn);
      actions.appendChild(problemBtn);

      card.appendChild(label);
      card.appendChild(promptArea);
      card.appendChild(actions);

      container.appendChild(card);
    }

    function renderBotFatherStep(container) {
      const commands = state.survey.commands.length ? state.survey.commands : ['/start', '/help'];
      const hints = {
        '/start': 'Почати роботу',
        '/help': 'Інструкція',
        '/add': 'Додати запис',
        '/list': 'Показати список',
        '/done': 'Позначити виконане',
        '/stats': 'Статистика прогресу',
        '/tips': 'Отримати пораду',
        '/pay': 'Оплата',
        '/admin': 'Адмін-меню',
        '/panic': 'Швидка підтримка'
      };

      const card = document.createElement('div');
      card.className = 'card';
      const label = document.createElement('div');
      label.className = 'prompt-label chat1';
      label.textContent = 'Команди для BotFather';
      const prompt = commands
        .map((cmd) => `${cmd} - ${hints[cmd] || 'Команда ' + cmd.replace('/', '')}`)
        .join('\n');
      const area = document.createElement('div');
      area.className = 'prompt-area';
      area.textContent = prompt;

      const actions = document.createElement('div');
      actions.className = 'prompt-actions';
      const copy = document.createElement('button');
      copy.textContent = 'Скопіювати';
      copy.addEventListener('click', () => copyText(prompt));
      const open = document.createElement('button');
      open.textContent = 'Відкрити BotFather';
      open.addEventListener('click', () => window.open('https://t.me/BotFather', '_blank'));
      actions.appendChild(copy);
      actions.appendChild(open);

      card.appendChild(label);
      card.appendChild(area);
      card.appendChild(actions);
      container.appendChild(card);
    }

    function renderTestStep(container) {
      const checklist = [
        { key: 'start', label: 'Написав /start — отримав привітання та інструкцію.' },
        { key: 'help', label: 'Команда /help пояснює, що робити.' },
        { key: 'custom', label: 'Перевірив одну кастомну команду (наприклад /add або /stats).' }
      ];

      const list = document.createElement('div');
      list.className = 'checklist';

      checklist.forEach((item) => {
        const row = document.createElement('label');
        row.className = 'check-item';
        if (state.testChecklist[item.key]) row.classList.add('completed');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!state.testChecklist[item.key];
        checkbox.addEventListener('change', (event) => {
          state.testChecklist[item.key] = event.target.checked;
          saveState();
          if (event.target.checked) row.classList.add('completed');
          else row.classList.remove('completed');
        });
        const text = document.createElement('div');
        text.innerHTML = item.label;
        row.appendChild(checkbox);
        row.appendChild(text);
        list.appendChild(row);
      });

      const problemBtn = document.createElement('button');
      problemBtn.textContent = 'Є проблема';
      problemBtn.addEventListener('click', renderProblemModal);

      container.appendChild(list);
      container.appendChild(problemBtn);
    }

    function renderFinishStep(container) {
      const grid = document.createElement('div');
      grid.className = 'card-grid';

      const upgrades = [
        {
          title: '💬 Кнопки та меню',
          text: 'Додай Reply та Inline кнопки для швидких дій.',
          action: () => showToast('Відкрий Блок A у сайдбарі та встав промпти для кнопок.')
        },
        {
          title: '📊 Статистика',
          text: 'Показуй прогрес 7/30 днів, бари та графіки.',
          action: () => showToast('Використай /stats із Блоку B, щоб додати метрики.')
        },
        {
          title: '💰 Оплати',
          text: 'Приймай Telegram Stars або Stripe.',
          action: () => showToast('Блок C підкаже, як додати платежі.')
        }
      ];

      upgrades.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'card';
        const title = document.createElement('h3');
        title.textContent = item.title;
        const text = document.createElement('p');
        text.textContent = item.text;
        const btn = document.createElement('button');
        btn.className = 'primary';
        btn.textContent = 'Хочу це';
        btn.addEventListener('click', item.action);
        card.appendChild(title);
        card.appendChild(text);
        card.appendChild(btn);
        grid.appendChild(card);
      });

      container.appendChild(grid);

      const restart = document.createElement('button');
      restart.textContent = 'Повернутись на головну';
      restart.addEventListener('click', () => setStep(0));
      container.appendChild(restart);
    }
    function gatherProfile() {
      const commands = state.survey.commands.length ? state.survey.commands : ['/start', '/help'];
      return {
        role: state.survey.role || 'Telegram assistant',
        goal: state.survey.goal || 'Help users manage their tasks',
        audience: state.survey.audience || 'general audience',
        commands,
        language: state.survey.language || 'uk',
        channel: state.survey.channel === 'group' ? 'group' : 'dm',
        type: state.autoProfile.type || 'Custom',
        modules: state.autoProfile.modules.length ? state.autoProfile.modules : commands,
        storage: state.autoProfile.storage || 'JSON',
        integrations: state.autoProfile.integrations,
        backend: state.autoProfile.backend || 'None',
        difficulty: state.autoProfile.difficulty || 'L0',
        mode: state.mode || 'AUTO'
      };
    }

    function ensurePrompts() {
      const profile = gatherProfile();
      const autoBrief = generateDevBrief(profile);
      if (state.mode === 'ASSISTED' && state.assistedBrief.trim()) {
        state.generatedBrief = state.assistedBrief.trim();
      } else {
        state.generatedBrief = autoBrief;
      }
      state.generatedCursorPrompt = generateCursorPrompt(profile, state.generatedBrief);
      state.generatedChecklist = generateChecklist(profile);
      saveState();
    }

    function generateDevBrief(profile) {
      const integrations = profile.integrations.length ? profile.integrations.join(', ') : 'no external integrations yet';
      const modules = profile.modules.length ? profile.modules.join(', ') : 'basic onboarding and help flow';
      const channel = profile.channel === 'group' ? 'Telegram group chats' : 'private DM conversations';
      const languageNote = profile.language === 'uk' ? 'Ukrainian UI copy with warm and supportive tone.' : 'English UI copy with friendly tone.';

      return [
        `Project role: ${profile.role}.`,
        `Primary goal: ${profile.goal}. Target audience: ${profile.audience}.`,
        `Conversation channel: ${channel}.`,
        `Commands to support: ${profile.commands.join(', ')}.`,
        `Core modules: ${modules}.`,
        `Data storage: ${profile.storage}.`,
        `Integrations to prepare: ${integrations}.`,
        `Backend expectations: ${profile.backend === 'None' ? 'polling only' : profile.backend}.`,
        `Tone of voice: ${languageNote}`
      ].join('\n');
    }

    function generateCursorPrompt(profile, brief) {
      const envHint = state.environment === 'Codespaces'
        ? 'Assume the project runs inside GitHub Codespaces (Linux).'
        : 'Assume the project runs locally on macOS/Windows with Python 3.11.';
      const modules = profile.modules.length ? profile.modules.join(', ') : 'basic onboarding';
      const integrations = profile.integrations.length ? profile.integrations.join(', ') : 'no external integrations yet';
      const storage = profile.storage === 'None' ? 'in-memory cache only' : profile.storage;

      return [
        'You are an expert Python developer working inside Cursor IDE. Build a production-ready Telegram bot using aiogram v3.',
        envHint,
        '--- Project brief ---',
        brief,
        '--- Requirements ---',
        '1. Use Python 3.11+, aiogram==3.*, python-dotenv and any standard libraries you need.',
        '2. Structure the project with folders: handlers/, keyboards/, services/, utils/, and keep configuration in config.py.',
        `3. Implement commands ${profile.commands.join(', ')} with clear docstrings and logging.`,
        `4. Provide data layer for ${storage}. If storage requires files, include safe load/save helpers.`,
        `5. Cover modules/features: ${modules}.`,
        `6. Prepare integration stubs for: ${integrations}.`,
        '7. Load the bot token from .env, validate it, and handle missing token gracefully.',
        '8. Include a README.md with setup instructions and commands to run the project.',
        '9. Return an .env.example with TOKEN= placeholder and other secrets.',
        '10. After code generation, show a short checklist reminding to run the commands from the brief.'
      ].join('\n\n');
    }

    function generateChecklist(profile) {
      const base = [
        'Create a virtual environment and install dependencies.',
        'Copy the generated Cursor code into the project.',
        'Create .env with TOKEN= from BotFather.',
        'Run python main.py and confirm the bot replies to /start and /help.',
        'Send /help to ensure descriptions are understandable.'
      ];
      if (profile.integrations.includes('Google Sheets')) {
        base.push('Share Google Sheet with service account credentials and test read/write operations.');
      }
      if (profile.integrations.includes('Webhook')) {
        base.push('Configure webhook URL and verify HTTPS endpoint responds with 200 OK.');
      }
      if (profile.integrations.includes('Stripe') || profile.integrations.includes('OpenAI')) {
        base.push('Fill payment/API keys in .env and run a test request in safe mode.');
      }
      return base;
    }

    function generateAssistedPrompt() {
      const profile = gatherProfile();
      return [
        'You are a senior product manager helping to craft an English DEV BRIEF for a Telegram bot project.',
        `Input language: Ukrainian. Current bot idea: ${profile.role}.`,
        `Goal: ${profile.goal}. Audience: ${profile.audience}.`,
        `Commands from the user: ${profile.commands.join(', ')}.`,
        'Please return a concise DEV BRIEF in English that contains: purpose, flows, commands, storage, integrations, and tone of voice.',
        'Answer only in English. Keep it short (max 12 sentences).' 
      ].join('\n');
    }

    function generateNavigatorHelpPrompt() {
      const step = steps[state.currentStep];
      return [
        'Hi Navigator! I am following the Zero-to-Bot panel and need help.',
        `Current step: ${step.title}.`,
        'Problem description: [встав сюди коротко, що сталося].',
        'Terminal log or screenshot: [встав сюди лог, якщо є].',
        'Please explain what to do next in Ukrainian using прості, короткі речення.'
      ].join('\n');
    }
    const theme = state.theme || 'light';
    setTheme(theme);
    ensurePrompts();
    render();
  </script>
</body>
</html>
